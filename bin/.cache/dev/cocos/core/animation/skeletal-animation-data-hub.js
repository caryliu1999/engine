(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../math/index.js", "./target-path.js", "../global-exports.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../math/index.js"), require("./target-path.js"), require("../global-exports.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.index, global.targetPath, global.globalExports);
    global.skeletalAnimationDataHub = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _index, _targetPath, _globalExports) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.SkelAnimDataHub = void 0;

  function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

  function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

  function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

  /**
   * 骨骼动画数据转换中心。
   */
  var SkelAnimDataHub = /*#__PURE__*/function () {
    function SkelAnimDataHub() {
      _classCallCheck(this, SkelAnimDataHub);
    }

    _createClass(SkelAnimDataHub, null, [{
      key: "getOrExtract",
      value: function getOrExtract(clip) {
        var data = SkelAnimDataHub.pool.get(clip);

        if (!data || data.info.sample !== clip.sample) {
          // release outdated render data
          if (data) {
            _globalExports.legacyCC.director.root.dataPoolManager.releaseAnimationClip(clip);
          }

          data = convertToSkeletalCurves(clip);
          SkelAnimDataHub.pool.set(clip, data);
        }

        return data;
      }
    }, {
      key: "destroy",
      value: function destroy(clip) {
        SkelAnimDataHub.pool["delete"](clip);
      }
    }]);

    return SkelAnimDataHub;
  }();

  _exports.SkelAnimDataHub = SkelAnimDataHub;
  SkelAnimDataHub.pool = new Map();

  function convertToSkeletalCurves(clip) {
    var data = {};
    clip.curves.forEach(function (curve) {
      if (!curve.valueAdapter && (0, _targetPath.isCustomPath)(curve.modifiers[0], _targetPath.HierarchyPath) && (0, _targetPath.isPropertyPath)(curve.modifiers[1])) {
        var path = curve.modifiers[0].path;
        var cs = data[path];

        if (!cs) {
          cs = data[path] = {};
        }

        var property = curve.modifiers[1];
        cs[property] = {
          values: curve.data.values,
          keys: curve.data.keys
        }; // don't use curve.data directly
      }
    });
    var frames = Math.ceil(clip.sample * clip.duration) + 1; // lazy eval the conversion due to memory-heavy ops
    // many animation paths may not be actually in-use

    var _loop = function _loop() {
      var path = _Object$keys[_i];
      var props = data[path];

      if (!props) {
        return "continue";
      }

      Object.defineProperty(props, 'worldMatrix', {
        get: function get() {
          if (!props._worldMatrix) {
            var position = props.position,
                rotation = props.rotation,
                scale = props.scale; // fixed step pre-sample

            convertToUniformSample(clip, position, frames);
            convertToUniformSample(clip, rotation, frames);
            convertToUniformSample(clip, scale, frames); // transform to world space

            convertToWorldSpace(data, path, props);
          }

          return props._worldMatrix;
        }
      });
    };

    for (var _i = 0, _Object$keys = Object.keys(data); _i < _Object$keys.length; _i++) {
      var _ret = _loop();

      if (_ret === "continue") continue;
    }

    var info = {
      frames: frames,
      sample: clip.sample
    };
    return {
      info: info,
      data: data
    };
  }

  function convertToUniformSample(clip, curve, frames) {
    var keys = clip.keys[curve.keys];
    var values = [];

    if (!keys || keys.length === 1) {
      for (var i = 0; i < frames; i++) {
        values[i] = curve.values[0].clone(); // never forget to clone
      }
    } else {
      var isQuat = curve.values[0] instanceof _index.Quat;

      for (var _i2 = 0, idx = 0; _i2 < frames; _i2++) {
        var time = _i2 / clip.sample;

        while (keys[idx] <= time) {
          idx++;
        }

        if (idx > keys.length - 1) {
          idx = keys.length - 1;
          time = keys[idx];
        } else if (idx === 0) {
          idx = 1;
        }

        var from = curve.values[idx - 1].clone();
        var denom = keys[idx] - keys[idx - 1];
        var ratio = denom ? (0, _index.clamp01)((time - keys[idx - 1]) / denom) : 1;

        if (isQuat) {
          from.slerp(curve.values[idx], ratio);
        } else {
          from.lerp(curve.values[idx], ratio);
        }

        values[_i2] = from;
      }
    }

    curve.values = values;
  }

  function convertToWorldSpace(convertedProps, path, props) {
    var oPos = props.position.values;
    var oRot = props.rotation.values;
    var oScale = props.scale.values;
    var matrix = oPos.map(function () {
      return new _index.Mat4();
    });
    var idx = path.lastIndexOf('/');
    var pMatrix = null;

    if (idx > 0) {
      var name = path.substring(0, idx);
      var data = convertedProps[name];

      if (!data) {
        console.warn('no data for parent bone?');
        return;
      }

      pMatrix = data.worldMatrix.values;
    } // all props should have the same length now


    for (var i = 0; i < oPos.length; i++) {
      var oT = oPos[i];
      var oR = oRot[i];
      var oS = oScale[i];
      var m = matrix[i];

      _index.Mat4.fromRTS(m, oR, oT, oS);

      if (pMatrix) {
        _index.Mat4.multiply(m, pMatrix[i], m);
      }
    }

    Object.keys(props).forEach(function (k) {
      return delete props[k];
    });
    props._worldMatrix = {
      keys: 0,
      interpolate: false,
      values: matrix
    };
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL2NvcmUvYW5pbWF0aW9uL3NrZWxldGFsLWFuaW1hdGlvbi1kYXRhLWh1Yi50cyJdLCJuYW1lcyI6WyJTa2VsQW5pbURhdGFIdWIiLCJjbGlwIiwiZGF0YSIsInBvb2wiLCJnZXQiLCJpbmZvIiwic2FtcGxlIiwibGVnYWN5Q0MiLCJkaXJlY3RvciIsInJvb3QiLCJkYXRhUG9vbE1hbmFnZXIiLCJyZWxlYXNlQW5pbWF0aW9uQ2xpcCIsImNvbnZlcnRUb1NrZWxldGFsQ3VydmVzIiwic2V0IiwiTWFwIiwiY3VydmVzIiwiZm9yRWFjaCIsImN1cnZlIiwidmFsdWVBZGFwdGVyIiwibW9kaWZpZXJzIiwiSGllcmFyY2h5UGF0aCIsInBhdGgiLCJjcyIsInByb3BlcnR5IiwidmFsdWVzIiwia2V5cyIsImZyYW1lcyIsIk1hdGgiLCJjZWlsIiwiZHVyYXRpb24iLCJwcm9wcyIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiX3dvcmxkTWF0cml4IiwicG9zaXRpb24iLCJyb3RhdGlvbiIsInNjYWxlIiwiY29udmVydFRvVW5pZm9ybVNhbXBsZSIsImNvbnZlcnRUb1dvcmxkU3BhY2UiLCJsZW5ndGgiLCJpIiwiY2xvbmUiLCJpc1F1YXQiLCJRdWF0IiwiaWR4IiwidGltZSIsImZyb20iLCJkZW5vbSIsInJhdGlvIiwic2xlcnAiLCJsZXJwIiwiY29udmVydGVkUHJvcHMiLCJvUG9zIiwib1JvdCIsIm9TY2FsZSIsIm1hdHJpeCIsIm1hcCIsIk1hdDQiLCJsYXN0SW5kZXhPZiIsInBNYXRyaXgiLCJuYW1lIiwic3Vic3RyaW5nIiwiY29uc29sZSIsIndhcm4iLCJ3b3JsZE1hdHJpeCIsIm9UIiwib1IiLCJvUyIsIm0iLCJmcm9tUlRTIiwibXVsdGlwbHkiLCJrIiwiaW50ZXJwb2xhdGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBbURBOzs7TUFHYUEsZTs7Ozs7OzttQ0FF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SSxDQUFDOEQsV0FBTCxDQUFpQnhDLE1BQTNCO0FBQ0gsS0FaZ0gsQ0Fhakg7OztBQUNBLFNBQUssSUFBSWdCLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdZLElBQUksQ0FBQ2IsTUFBekIsRUFBaUNDLENBQUMsRUFBbEMsRUFBc0M7QUFDbEMsVUFBTXlCLEVBQUUsR0FBR2IsSUFBSSxDQUFDWixDQUFELENBQWY7QUFDQSxVQUFNMEIsRUFBRSxHQUFHYixJQUFJLENBQUNiLENBQUQsQ0FBZjtBQUNBLFVBQU0yQixFQUFFLEdBQUdiLE1BQU0sQ0FBQ2QsQ0FBRCxDQUFqQjtBQUNBLFVBQU00QixDQUFDLEdBQUdiLE1BQU0sQ0FBQ2YsQ0FBRCxDQUFoQjs7QUFDQWlCLGtCQUFLWSxPQUFMLENBQWFELENBQWIsRUFBZ0JGLEVBQWhCLEVBQW9CRCxFQUFwQixFQUF3QkUsRUFBeEI7O0FBQ0EsVUFBSVIsT0FBSixFQUFhO0FBQUVGLG9CQUFLYSxRQUFMLENBQWNGLENBQWQsRUFBaUJULE9BQU8sQ0FBQ25CLENBQUQsQ0FBeEIsRUFBNkI0QixDQUE3QjtBQUFrQztBQUNwRDs7QUFDRHJDLElBQUFBLE1BQU0sQ0FBQ04sSUFBUCxDQUFZSyxLQUFaLEVBQW1CZCxPQUFuQixDQUEyQixVQUFDdUQsQ0FBRDtBQUFBLGFBQU8sT0FBT3pDLEtBQUssQ0FBQ3lDLENBQUQsQ0FBbkI7QUFBQSxLQUEzQjtBQUNBekMsSUFBQUEsS0FBSyxDQUFDRyxZQUFOLEdBQXFCO0FBQUVSLE1BQUFBLElBQUksRUFBRSxDQUFSO0FBQVcrQyxNQUFBQSxXQUFXLEVBQUUsS0FBeEI7QUFBK0JoRCxNQUFBQSxNQUFNLEVBQUUrQjtBQUF2QyxLQUFyQjtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuIENvcHlyaWdodCAoYykgMjAxNy0yMDE4IFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLlxyXG5cclxuIGh0dHA6Ly93d3cuY29jb3MuY29tXHJcblxyXG4gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxyXG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXHJcbiAgd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxyXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcclxuICBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXHJcbiAgdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxyXG4gIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxyXG5cclxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXHJcbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxyXG5cclxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcclxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxyXG4gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXHJcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXHJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxyXG4gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxyXG4gVEhFIFNPRlRXQVJFLlxyXG4qL1xyXG5cclxuLyoqXHJcbiAqIEBjYXRlZ29yeSBhbmltYXRpb25cclxuICovXHJcblxyXG5pbXBvcnQgeyBjbGFtcDAxLCBNYXQ0LCBRdWF0LCBWZWMzIH0gZnJvbSAnLi4vbWF0aCc7XHJcbmltcG9ydCB7IERhdGFQb29sTWFuYWdlciB9IGZyb20gJy4uL3JlbmRlcmVyL2RhdGEtcG9vbC1tYW5hZ2VyJztcclxuaW1wb3J0IHsgQW5pbWF0aW9uQ2xpcCwgSU9iamVjdEN1cnZlRGF0YSB9IGZyb20gJy4vYW5pbWF0aW9uLWNsaXAnO1xyXG5pbXBvcnQgeyBIaWVyYXJjaHlQYXRoLCBpc0N1c3RvbVBhdGgsIGlzUHJvcGVydHlQYXRoIH0gZnJvbSAnLi90YXJnZXQtcGF0aCc7XHJcbmltcG9ydCB7IGxlZ2FjeUNDIH0gZnJvbSAnLi4vZ2xvYmFsLWV4cG9ydHMnO1xyXG5cclxudHlwZSBDdXJ2ZURhdGEgPSBWZWMzW10gfCBRdWF0W10gfCBNYXQ0W107XHJcbnR5cGUgQ29udmVydGVkUHJvcHMgPSBSZWNvcmQ8c3RyaW5nLCBJUHJvcGVydHlDdXJ2ZT47XHJcblxyXG5pbnRlcmZhY2UgSVByb3BlcnR5Q3VydmUge1xyXG4gICAga2V5czogbnVtYmVyO1xyXG4gICAgdmFsdWVzOiBDdXJ2ZURhdGE7XHJcbn1cclxuaW50ZXJmYWNlIElTa2VsZXRhbEN1cnZlSW5mbyB7XHJcbiAgICBmcmFtZXM6IG51bWJlcjtcclxuICAgIHNhbXBsZTogbnVtYmVyO1xyXG59XHJcbmludGVyZmFjZSBJQ29udmVydGVkRGF0YSB7XHJcbiAgICBpbmZvOiBJU2tlbGV0YWxDdXJ2ZUluZm87XHJcbiAgICBkYXRhOiBSZWNvcmQ8c3RyaW5nLCBDb252ZXJ0ZWRQcm9wcz47XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDpqqjpqrzliqjnlLvmlbDmja7ovazmjaLkuK3lv4PjgIJcclxuICovXHJcbmV4cG9ydCBjbGFzcyBTa2VsQW5pbURhdGFIdWIge1xyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZ2V0T3JFeHRyYWN0IChjbGlwOiBBbmltYXRpb25DbGlwKSB7XHJcbiAgICAgICAgbGV0IGRhdGEgPSBTa2VsQW5pbURhdGFIdWIucG9vbC5nZXQoY2xpcCk7XHJcbiAgICAgICAgaWYgKCFkYXRhIHx8IGRhdGEuaW5mby5zYW1wbGUgIT09IGNsaXAuc2FtcGxlKSB7XHJcbiAgICAgICAgICAgIC8vIHJlbGVhc2Ugb3V0ZGF0ZWQgcmVuZGVyIGRhdGFcclxuICAgICAgICAgICAgaWYgKGRhdGEpIHsgKGxlZ2FjeUNDLmRpcmVjdG9yLnJvb3QuZGF0YVBvb2xNYW5hZ2VyIGFzIERhdGFQb29sTWFuYWdlcikucmVsZWFzZUFuaW1hdGlvbkNsaXAoY2xpcCk7IH1cclxuICAgICAgICAgICAgZGF0YSA9IGNvbnZlcnRUb1NrZWxldGFsQ3VydmVzKGNsaXApO1xyXG4gICAgICAgICAgICBTa2VsQW5pbURhdGFIdWIucG9vbC5zZXQoY2xpcCwgZGF0YSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkYXRhO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzdGF0aWMgZGVzdHJveSAoY2xpcDogQW5pbWF0aW9uQ2xpcCkge1xyXG4gICAgICAgIFNrZWxBbmltRGF0YUh1Yi5wb29sLmRlbGV0ZShjbGlwKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgc3RhdGljIHBvb2wgPSBuZXcgTWFwPEFuaW1hdGlvbkNsaXAsIElDb252ZXJ0ZWREYXRhPigpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb252ZXJ0VG9Ta2VsZXRhbEN1cnZlcyAoY2xpcDogQW5pbWF0aW9uQ2xpcCk6IElDb252ZXJ0ZWREYXRhIHtcclxuICAgIGNvbnN0IGRhdGE6IFJlY29yZDxzdHJpbmcsIENvbnZlcnRlZFByb3BzPiA9IHt9O1xyXG4gICAgY2xpcC5jdXJ2ZXMuZm9yRWFjaCgoY3VydmUpID0+IHtcclxuICAgICAgICBpZiAoIWN1cnZlLnZhbHVlQWRhcHRlciAmJlxyXG4gICAgICAgICAgICBpc0N1c3RvbVBhdGgoY3VydmUubW9kaWZpZXJzWzBdLCBIaWVyYXJjaHlQYXRoKSAmJlxyXG4gICAgICAgICAgICBpc1Byb3BlcnR5UGF0aChjdXJ2ZS5tb2RpZmllcnNbMV0pKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhdGggPSAoY3VydmUubW9kaWZpZXJzWzBdIGFzIEhpZXJhcmNoeVBhdGgpLnBhdGg7XHJcbiAgICAgICAgICAgIGxldCBjcyA9IGRhdGFbcGF0aF07XHJcbiAgICAgICAgICAgIGlmICghY3MpIHsgY3MgPSBkYXRhW3BhdGhdID0ge307IH1cclxuICAgICAgICAgICAgY29uc3QgcHJvcGVydHkgPSBjdXJ2ZS5tb2RpZmllcnNbMV0gYXMgc3RyaW5nO1xyXG4gICAgICAgICAgICBjc1twcm9wZXJ0eV0gPSB7IHZhbHVlczogY3VydmUuZGF0YS52YWx1ZXMsIGtleXM6IGN1cnZlLmRhdGEua2V5cyB9OyAvLyBkb24ndCB1c2UgY3VydmUuZGF0YSBkaXJlY3RseVxyXG4gICAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgY29uc3QgZnJhbWVzID0gTWF0aC5jZWlsKGNsaXAuc2FtcGxlICogY2xpcC5kdXJhdGlvbikgKyAxO1xyXG4gICAgLy8gbGF6eSBldmFsIHRoZSBjb252ZXJzaW9uIGR1ZSB0byBtZW1vcnktaGVhdnkgb3BzXHJcbiAgICAvLyBtYW55IGFuaW1hdGlvbiBwYXRocyBtYXkgbm90IGJlIGFjdHVhbGx5IGluLXVzZVxyXG4gICAgZm9yIChjb25zdCBwYXRoIG9mIE9iamVjdC5rZXlzKGRhdGEpKSB7XHJcbiAgICAgICAgY29uc3QgcHJvcHMgPSBkYXRhW3BhdGhdO1xyXG4gICAgICAgIGlmICghcHJvcHMpIHsgY29udGludWU7IH1cclxuICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkocHJvcHMsICd3b3JsZE1hdHJpeCcsIHtcclxuICAgICAgICAgICAgZ2V0OiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXByb3BzLl93b3JsZE1hdHJpeCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgcG9zaXRpb24sIHJvdGF0aW9uLCBzY2FsZSB9ID0gcHJvcHM7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gZml4ZWQgc3RlcCBwcmUtc2FtcGxlXHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVydFRvVW5pZm9ybVNhbXBsZShjbGlwLCBwb3NpdGlvbiwgZnJhbWVzKTtcclxuICAgICAgICAgICAgICAgICAgICBjb252ZXJ0VG9Vbmlmb3JtU2FtcGxlKGNsaXAsIHJvdGF0aW9uLCBmcmFtZXMpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnZlcnRUb1VuaWZvcm1TYW1wbGUoY2xpcCwgc2NhbGUsIGZyYW1lcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gdHJhbnNmb3JtIHRvIHdvcmxkIHNwYWNlXHJcbiAgICAgICAgICAgICAgICAgICAgY29udmVydFRvV29ybGRTcGFjZShkYXRhLCBwYXRoLCBwcm9wcyk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJvcHMuX3dvcmxkTWF0cml4O1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgY29uc3QgaW5mbzogSVNrZWxldGFsQ3VydmVJbmZvID0ge1xyXG4gICAgICAgIGZyYW1lcyxcclxuICAgICAgICBzYW1wbGU6IGNsaXAuc2FtcGxlLFxyXG4gICAgfTtcclxuICAgIHJldHVybiB7IGluZm8sIGRhdGEgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydFRvVW5pZm9ybVNhbXBsZSAoY2xpcDogQW5pbWF0aW9uQ2xpcCwgY3VydmU6IElQcm9wZXJ0eUN1cnZlLCBmcmFtZXM6IG51bWJlcikge1xyXG4gICAgY29uc3Qga2V5cyA9IGNsaXAua2V5c1tjdXJ2ZS5rZXlzXTtcclxuICAgIGNvbnN0IHZhbHVlczogQ3VydmVEYXRhID0gW107XHJcbiAgICBpZiAoIWtleXMgfHwga2V5cy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZyYW1lczsgaSsrKSB7XHJcbiAgICAgICAgICAgIHZhbHVlc1tpXSA9IGN1cnZlLnZhbHVlc1swXS5jbG9uZSgpOyAvLyBuZXZlciBmb3JnZXQgdG8gY2xvbmVcclxuICAgICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IGlzUXVhdCA9IGN1cnZlLnZhbHVlc1swXSBpbnN0YW5jZW9mIFF1YXQ7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGlkeCA9IDA7IGkgPCBmcmFtZXM7IGkrKykge1xyXG4gICAgICAgICAgICBsZXQgdGltZSA9IGkgLyBjbGlwLnNhbXBsZTtcclxuICAgICAgICAgICAgd2hpbGUgKGtleXNbaWR4XSA8PSB0aW1lKSB7IGlkeCsrOyB9XHJcbiAgICAgICAgICAgIGlmIChpZHggPiBrZXlzLmxlbmd0aCAtIDEpIHsgaWR4ID0ga2V5cy5sZW5ndGggLSAxOyB0aW1lID0ga2V5c1tpZHhdOyB9XHJcbiAgICAgICAgICAgIGVsc2UgaWYgKGlkeCA9PT0gMCkgeyBpZHggPSAxOyB9XHJcbiAgICAgICAgICAgIGNvbnN0IGZyb20gPSBjdXJ2ZS52YWx1ZXNbaWR4IC0gMV0uY2xvbmUoKTtcclxuICAgICAgICAgICAgY29uc3QgZGVub20gPSBrZXlzW2lkeF0gLSBrZXlzW2lkeCAtIDFdO1xyXG4gICAgICAgICAgICBjb25zdCByYXRpbyA9IGRlbm9tID8gY2xhbXAwMSgodGltZSAtIGtleXNbaWR4IC0gMV0pIC8gZGVub20pIDogMTtcclxuICAgICAgICAgICAgaWYgKGlzUXVhdCkge1xyXG4gICAgICAgICAgICAgICAgKGZyb20gYXMgUXVhdCkuc2xlcnAoY3VydmUudmFsdWVzW2lkeF0gYXMgUXVhdCwgcmF0aW8pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgKGZyb20gYXMgVmVjMykubGVycChjdXJ2ZS52YWx1ZXNbaWR4XSBhcyBWZWMzLCByYXRpbyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdmFsdWVzW2ldID0gZnJvbTtcclxuICAgICAgIH1cclxuICAgIH1cclxuICAgIGN1cnZlLnZhbHVlcyA9IHZhbHVlcztcclxufVxyXG5cclxuZnVuY3Rpb24gY29udmVydFRvV29ybGRTcGFjZSAoY29udmVydGVkUHJvcHM6IFJlY29yZDxzdHJpbmcsIENvbnZlcnRlZFByb3BzPiwgcGF0aDogc3RyaW5nLCBwcm9wczogSU9iamVjdEN1cnZlRGF0YSkge1xyXG4gICAgY29uc3Qgb1BvcyA9IHByb3BzLnBvc2l0aW9uLnZhbHVlcztcclxuICAgIGNvbnN0IG9Sb3QgPSBwcm9wcy5yb3RhdGlvbi52YWx1ZXM7XHJcbiAgICBjb25zdCBvU2NhbGUgPSBwcm9wcy5zY2FsZS52YWx1ZXM7XHJcbiAgICBjb25zdCBtYXRyaXggPSBvUG9zLm1hcCgoKSA9PiBuZXcgTWF0NCgpKTtcclxuICAgIGNvbnN0IGlkeCA9IHBhdGgubGFzdEluZGV4T2YoJy8nKTtcclxuICAgIGxldCBwTWF0cml4OiBNYXQ0W10gfCBudWxsID0gbnVsbDtcclxuICAgIGlmIChpZHggPiAwKSB7XHJcbiAgICAgICAgY29uc3QgbmFtZSA9IHBhdGguc3Vic3RyaW5nKDAsIGlkeCk7XHJcbiAgICAgICAgY29uc3QgZGF0YSA9IGNvbnZlcnRlZFByb3BzW25hbWVdO1xyXG4gICAgICAgIGlmICghZGF0YSkgeyBjb25zb2xlLndhcm4oJ25vIGRhdGEgZm9yIHBhcmVudCBib25lPycpOyByZXR1cm47IH1cclxuICAgICAgICBwTWF0cml4ID0gZGF0YS53b3JsZE1hdHJpeC52YWx1ZXMgYXMgTWF0NFtdO1xyXG4gICAgfVxyXG4gICAgLy8gYWxsIHByb3BzIHNob3VsZCBoYXZlIHRoZSBzYW1lIGxlbmd0aCBub3dcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb1Bvcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IG9UID0gb1Bvc1tpXTtcclxuICAgICAgICBjb25zdCBvUiA9IG9Sb3RbaV07XHJcbiAgICAgICAgY29uc3Qgb1MgPSBvU2NhbGVbaV07XHJcbiAgICAgICAgY29uc3QgbSA9IG1hdHJpeFtpXTtcclxuICAgICAgICBNYXQ0LmZyb21SVFMobSwgb1IsIG9ULCBvUyk7XHJcbiAgICAgICAgaWYgKHBNYXRyaXgpIHsgTWF0NC5tdWx0aXBseShtLCBwTWF0cml4W2ldLCBtKTsgfVxyXG4gICAgfVxyXG4gICAgT2JqZWN0LmtleXMocHJvcHMpLmZvckVhY2goKGspID0+IGRlbGV0ZSBwcm9wc1trXSk7XHJcbiAgICBwcm9wcy5fd29ybGRNYXRyaXggPSB7IGtleXM6IDAsIGludGVycG9sYXRlOiBmYWxzZSwgdmFsdWVzOiBtYXRyaXggfTtcclxufVxyXG4iXX0=