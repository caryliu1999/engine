(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../utils/text-utils.js", "../platform/debug.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../utils/text-utils.js"), require("../platform/debug.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.textUtils, global.debug);
    global.fontLoader = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _textUtils, _debug) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.loadFont = loadFont;
  _exports._getFontFamily = _getFontFamily;

  /*
   Copyright (c) 2017-2018 Xiamen Yaji Software Co., Ltd.
  
   http://www.cocos.com
  
   Permission is hereby granted, free of charge, to any person obtaining a copy
   of this software and associated engine source code (the "Software"), a limited,
    worldwide, royalty-free, non-assignable, revocable and non-exclusive license
   to use Cocos Creator solely to develop games on your target platforms. You shall
    not use Cocos Creator software for developing other software or tools that's
    used for developing games. You are not granted to publish, distribute,
    sublicense, and/or sell copies of Cocos Creator.
  
   The software or tools in this License Agreement are licensed, not sold.
   Xiamen Yaji Software Co., Ltd. reserves all rights not expressly granted to you.
  
   THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
   IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
   FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
   AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
   LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
   OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
   THE SOFTWARE.
   */

  /**
   * @hidden
   */
  var _canvasContext = null; // letter symbol number CJK

  var _testString = "BES bswy:->@123\u4E01\u3041\u1101";
  var _fontFaces = {};

  var _intervalId = -1;

  var _loadingFonts = []; // 3 seconds timeout

  var _timeout = 3000;

  var useNativeCheck = function () {
    var nativeCheck;
    return function () {
      if (!nativeCheck) {
        if (!!window.FontFace) {
          var match = /Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent);
          var safari10Match = /OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent) && /Apple/.exec(window.navigator.vendor);

          if (match) {
            nativeCheck = parseInt(match[1], 10) > 42;
          } else if (safari10Match) {
            nativeCheck = false;
          } else {
            nativeCheck = true;
          }
        } else {
          nativeCheck = false;
        }
      }

      return nativeCheck;
    };
  }();

  function nativeCheckFontLoaded(start, font, callback) {
    var loader = new Promise(function (resolve, reject) {
      var check = function check() {
        var now = Date.now();

        if (now - start >= _timeout) {
          reject();
        } else {
          // @ts-ignore
          document.fonts.load('40px ' + font).then(function (fonts) {
            if (fonts.length >= 1) {
              resolve();
            } else {
              setTimeout(check, 100);
            }
          }, function () {
            reject();
          });
        }
      };

      check();
    });
    var timeoutId;
    var timer = new Promise(function (resolve, reject) {
      timeoutId = setTimeout(reject, _timeout);
    });
    Promise.race([timer, loader]).then(function () {
      if (timeoutId) {
        clearTimeout(timeoutId);
        timeoutId = null;
      }

      callback(null, font);
    }, function () {
      (0, _debug.warnID)(4933, font);
      callback(null, font);
    });
  }

  function _checkFontLoaded() {
    var allFontsLoaded = true;
    var now = Date.now();

    for (var i = _loadingFonts.length - 1; i >= 0; i--) {
      var fontLoadHandle = _loadingFonts[i];
      var fontFamily = fontLoadHandle.fontFamilyName; // load timeout

      if (now - fontLoadHandle.startTime > _timeout) {
        (0, _debug.warnID)(4933, fontFamily);
        fontLoadHandle.callback(null, fontFamily);

        _loadingFonts.splice(i, 1);

        continue;
      }

      var oldWidth = fontLoadHandle.refWidth; // @ts-ignore

      _canvasContext.font = '40px ' + fontFamily; // @ts-ignore

      var newWidth = (0, _textUtils.safeMeasureText)(_canvasContext, _testString); // loaded successfully

      if (oldWidth !== newWidth) {
        _loadingFonts.splice(i, 1);

        fontLoadHandle.callback(null, fontFamily);
      } else {
        allFontsLoaded = false;
      }
    }

    if (allFontsLoaded) {
      clearInterval(_intervalId);
      _intervalId = -1;
    }
  }

  function loadFont(item, callback) {
    var url = item.url;

    var fontFamilyName = _getFontFamily(url); // Already loaded fonts


    if (_fontFaces[fontFamilyName]) {
      return fontFamilyName;
    }

    if (!_canvasContext) {
      var labelCanvas = document.createElement('canvas');
      labelCanvas.width = 100;
      labelCanvas.height = 100;
      _canvasContext = labelCanvas.getContext('2d');
    } // Default width reference to test whether new font is loaded correctly


    var fontDesc = '40px ' + fontFamilyName; // @ts-ignore

    _canvasContext.font = fontDesc; // @ts-ignore

    var refWidth = (0, _textUtils.safeMeasureText)(_canvasContext, _testString); // Setup font face style

    var fontStyle = document.createElement("style");
    fontStyle.type = "text/css";
    var fontStr = "";
    if (isNaN(fontFamilyName - 0)) fontStr += "@font-face { font-family:" + fontFamilyName + "; src:";else fontStr += "@font-face { font-family:'" + fontFamilyName + "'; src:";
    fontStr += "url('" + url + "');";
    fontStyle.textContent = fontStr + "}";
    document.body.appendChild(fontStyle); // Preload font with div

    var preloadDiv = document.createElement("div");
    var divStyle = preloadDiv.style;
    divStyle.fontFamily = fontFamilyName;
    preloadDiv.innerHTML = ".";
    divStyle.position = "absolute";
    divStyle.left = "-100px";
    divStyle.top = "-100px";
    document.body.appendChild(preloadDiv);

    if (useNativeCheck()) {
      nativeCheckFontLoaded(Date.now(), fontFamilyName, callback);
    } else {
      // Save loading font
      var fontLoadHandle = {
        fontFamilyName: fontFamilyName,
        refWidth: refWidth,
        callback: callback,
        startTime: Date.now()
      };

      _loadingFonts.push(fontLoadHandle);

      if (_intervalId === -1) {
        _intervalId = setInterval(_checkFontLoaded, 100);
      }
    }

    _fontFaces[fontFamilyName] = fontStyle;
  }

  function _getFontFamily(fontHandle) {
    var ttfIndex = fontHandle.lastIndexOf(".ttf");
    if (ttfIndex === -1) return fontHandle;
    var slashPos = fontHandle.lastIndexOf("/");
    var fontFamilyName;

    if (slashPos === -1) {
      fontFamilyName = fontHandle.substring(0, ttfIndex) + "_LABEL";
    } else {
      fontFamilyName = fontHandle.substring(slashPos + 1, ttfIndex) + "_LABEL";
    }

    if (fontFamilyName.indexOf(' ') !== -1) {
      fontFamilyName = '"' + fontFamilyName + '"';
    }

    return fontFamilyName;
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL2NvcmUvbG9hZC1waXBlbGluZS9mb250LWxvYWRlci50cyJdLCJuYW1lcyI6WyJfY2FudmFzQ29udGV4dCIsIl90ZXN0U3RyaW5nIiwiX2ZvbnRGYWNlcyIsIl9pbnRlcnZhbElkIiwiX2xvYWRpbmdGb250cyIsIl90aW1lb3V0IiwidXNlTmF0aXZlQ2hlY2siLCJuYXRpdmVDaGVjayIsIndpbmRvdyIsIkZvbnRGYWNlIiwibWF0Y2giLCJleGVjIiwibmF2aWdhdG9yIiwidXNlckFnZW50Iiwic2FmYXJpMTBNYXRjaCIsInZlbmRvciIsInBhcnNlSW50IiwibmF0aXZlQ2hlY2tGb250TG9hZGVkIiwic3RhcnQiLCJmb250IiwiY2FsbGJhY2siLCJsb2FkZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsImNoZWNrIiwibm93IiwiRGF0ZSIsImRvY3VtZW50IiwiZm9udHMiLCJsb2FkIiwidGhlbiIsImxlbmd0aCIsInNldFRpbWVvdXQiLCJ0aW1lb3V0SWQiLCJ0aW1lciIsInJhY2UiLCJjbGVhclRpbWVvdXQiLCJfY2hlY2tGb250TG9hZGVkIiwiYWxsRm9udHNMb2FkZWQiLCJpIiwiZm9udExvYWRIYW5kbGUiLCJmb250RmFtaWx5IiwiZm9udEZhbWlseU5hbWUiLCJzdGFydFRpbWUiLCJzcGxpY2UiLCJvbGRXaWR0aCIsInJlZldpZHRoIiwibmV3V2lkdGgiLCJjbGVhckludGVydmFsIiwibG9hZEZvbnQiLCJpdGVtIiwidXJsIiwiX2dldEZvbnRGYW1pbHkiLCJsYWJlbENhbnZhcyIsImNyZWF0ZUVsZW1lbnQiLCJ3aWR0aCIsImhlaWdodCIsImdldENvbnRleHQiLCJmb250RGVzYyIsImZvbnRTdHlsZSIsInR5cGUiLCJmb250U3RyIiwiaXNOYU4iLCJ0ZXh0Q29udGVudCIsImJvZHkiLCJhcHBlbmRDaGlsZCIsInByZWxvYWREaXYiLCJkaXZTdHlsZSIsInN0eWxlIiwiaW5uZXJIVE1MIiwicG9zaXRpb24iLCJsZWZ0IiwidG9wIiwicHVzaCIsInNldEludGVydmFsIiwiZm9udEhhbmRsZSIsInR0ZkluZGV4IiwibGFzdEluZGV4T2YiLCJzbGFzaFBvcyIsInN1YnN0cmluZyIsImluZGV4T2YiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBeUJBOzs7QUFlQSxNQUFJQSxjQUE2QyxHQUFHLElBQXBELEMsQ0FDQTs7QUFDQSxNQUFNQyxXQUFXLEdBQUcsbUNBQXBCO0FBRUEsTUFBSUMsVUFBVSxHQUFHLEVBQWpCOztBQUNBLE1BQUlDLFdBQVcsR0FBRyxDQUFDLENBQW5COztBQUNBLE1BQUlDLGFBQXFDLEdBQUcsRUFBNUMsQyxDQUNBOztBQUNBLE1BQUlDLFFBQVEsR0FBRyxJQUFmOztBQUVBLE1BQUlDLGNBQWMsR0FBSSxZQUFZO0FBQzlCLFFBQUlDLFdBQUo7QUFDQSxXQUFPLFlBQVk7QUFDZixVQUFJLENBQUNBLFdBQUwsRUFBa0I7QUFDZCxZQUFJLENBQUMsQ0FBQ0MsTUFBTSxDQUFDQyxRQUFiLEVBQXVCO0FBQ25CLGNBQUlDLEtBQUssR0FBRyx3QkFBd0JDLElBQXhCLENBQTZCSCxNQUFNLENBQUNJLFNBQVAsQ0FBaUJDLFNBQTlDLENBQVo7QUFDQSxjQUFJQyxhQUFhLEdBQUcsOEJBQThCSCxJQUE5QixDQUFtQ0gsTUFBTSxDQUFDSSxTQUFQLENBQWlCQyxTQUFwRCxLQUFrRSxRQUFRRixJQUFSLENBQWFILE1BQU0sQ0FBQ0ksU0FBUCxDQUFpQkcsTUFBOUIsQ0FBdEY7O0FBRUEsY0FBSUwsS0FBSixFQUFXO0FBQ1BILFlBQUFBLFdBQVcsR0FBR1MsUUFBUSxDQUFDTixLQUFLLENBQUMsQ0FBRCxDQUFOLEVBQVcsRUFBWCxDQUFSLEdBQXlCLEVBQXZDO0FBQ0gsV0FGRCxNQUdLLElBQUlJLGFBQUosRUFBbUI7QUFDcEJQLFlBQUFBLFdBQVcsR0FBRyxLQUFkO0FBQ0gsV0FGSSxNQUdBO0FBQ0RBLFlB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Y0FBYyxHQUFHaUMsVUFBVSxDQUFDSSxTQUFYLENBQXFCRCxRQUFRLEdBQUcsQ0FBaEMsRUFBbUNGLFFBQW5DLElBQStDLFFBQWhFO0FBQ0g7O0FBQ0QsUUFBSWxDLGNBQWMsQ0FBQ3NDLE9BQWYsQ0FBdUIsR0FBdkIsTUFBZ0MsQ0FBQyxDQUFyQyxFQUF3QztBQUNwQ3RDLE1BQUFBLGNBQWMsR0FBRyxNQUFNQSxjQUFOLEdBQXVCLEdBQXhDO0FBQ0g7O0FBQ0QsV0FBT0EsY0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuIENvcHlyaWdodCAoYykgMjAxNy0yMDE4IFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLlxyXG5cclxuIGh0dHA6Ly93d3cuY29jb3MuY29tXHJcblxyXG4gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxyXG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXHJcbiAgd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxyXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcclxuICBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXHJcbiAgdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxyXG4gIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxyXG5cclxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXHJcbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxyXG5cclxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcclxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxyXG4gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXHJcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXHJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxyXG4gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxyXG4gVEhFIFNPRlRXQVJFLlxyXG4gKi9cclxuXHJcbi8qKlxyXG4gKiBAaGlkZGVuXHJcbiAqL1xyXG5cclxuaW1wb3J0IHtzYWZlTWVhc3VyZVRleHR9IGZyb20gJy4uL3V0aWxzL3RleHQtdXRpbHMnO1xyXG5pbXBvcnQgeyBsZWdhY3lDQyB9IGZyb20gJy4uL2dsb2JhbC1leHBvcnRzJztcclxuaW1wb3J0IHsgd2FybklEIH0gZnJvbSAnLi4vcGxhdGZvcm0vZGVidWcnO1xyXG5cclxuaW50ZXJmYWNlIElGb250TG9hZEhhbmRsZSB7XHJcbiAgICBmb250RmFtaWx5TmFtZTtcclxuICAgIHJlZldpZHRoO1xyXG4gICAgY2FsbGJhY2s7XHJcbiAgICBzdGFydFRpbWU7XHJcbn1cclxuXHJcbmxldCBfY2FudmFzQ29udGV4dDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfG51bGwgPSBudWxsO1xyXG4vLyBsZXR0ZXIgc3ltYm9sIG51bWJlciBDSktcclxuY29uc3QgX3Rlc3RTdHJpbmcgPSBcIkJFUyBic3d5Oi0+QDEyM1xcdTRFMDFcXHUzMDQxXFx1MTEwMVwiO1xyXG5cclxubGV0IF9mb250RmFjZXMgPSB7fTtcclxubGV0IF9pbnRlcnZhbElkID0gLTE7XHJcbmxldCBfbG9hZGluZ0ZvbnRzOiBBcnJheTxJRm9udExvYWRIYW5kbGU+ID0gW107XHJcbi8vIDMgc2Vjb25kcyB0aW1lb3V0XHJcbmxldCBfdGltZW91dCA9IDMwMDA7XHJcblxyXG5sZXQgdXNlTmF0aXZlQ2hlY2sgPSAoZnVuY3Rpb24gKCkge1xyXG4gICAgbGV0IG5hdGl2ZUNoZWNrO1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAoIW5hdGl2ZUNoZWNrKSB7XHJcbiAgICAgICAgICAgIGlmICghIXdpbmRvdy5Gb250RmFjZSkge1xyXG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gL0dlY2tvLipGaXJlZm94XFwvKFxcZCspLy5leGVjKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KTtcclxuICAgICAgICAgICAgICAgIHZhciBzYWZhcmkxME1hdGNoID0gL09TIFguKlZlcnNpb25cXC8xMFxcLi4qU2FmYXJpLy5leGVjKHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50KSAmJiAvQXBwbGUvLmV4ZWMod2luZG93Lm5hdmlnYXRvci52ZW5kb3IpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSBwYXJzZUludChtYXRjaFsxXSwgMTApID4gNDI7XHJcbiAgICAgICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc2FmYXJpMTBNYXRjaCkge1xyXG4gICAgICAgICAgICAgICAgICAgIG5hdGl2ZUNoZWNrID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICB9IFxyXG4gICAgICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgbmF0aXZlQ2hlY2sgPSBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmF0aXZlQ2hlY2s7XHJcbiAgICB9XHJcbn0pKCk7XHJcblxyXG5mdW5jdGlvbiBuYXRpdmVDaGVja0ZvbnRMb2FkZWQgKHN0YXJ0LCBmb250LCBjYWxsYmFjaykge1xyXG4gICAgdmFyIGxvYWRlciA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICB2YXIgY2hlY2sgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgIHZhciBub3cgPSBEYXRlLm5vdygpO1xyXG5cclxuICAgICAgICAgICAgaWYgKG5vdyAtIHN0YXJ0ID49IF90aW1lb3V0KSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoKTtcclxuICAgICAgICAgICAgfSBcclxuICAgICAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5mb250cy5sb2FkKCc0MHB4ICcgKyBmb250KS50aGVuKGZ1bmN0aW9uIChmb250cykge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChmb250cy5sZW5ndGggPj0gMSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBcclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChjaGVjaywgMTAwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KCk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICAgY2hlY2soKTtcclxuICAgIH0pO1xyXG4gIFxyXG4gICAgbGV0IHRpbWVvdXRJZDtcclxuICAgIGxldCB0aW1lciA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgICAgICB0aW1lb3V0SWQgPSBzZXRUaW1lb3V0KHJlamVjdCwgX3RpbWVvdXQpO1xyXG4gICAgfSk7XHJcbiAgXHJcbiAgICBQcm9taXNlLnJhY2UoW3RpbWVyLCBsb2FkZXJdKS50aGVuKGZ1bmN0aW9uICgpIHtcclxuICAgICAgICBpZiAodGltZW91dElkKSB7XHJcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0SWQpO1xyXG4gICAgICAgICAgICB0aW1lb3V0SWQgPSBudWxsO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYWxsYmFjayhudWxsLCBmb250KTtcclxuICAgIH0sIGZ1bmN0aW9uICgpIHtcclxuICAgICAgICB3YXJuSUQoNDkzMywgZm9udCk7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgZm9udCk7XHJcbiAgICB9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gX2NoZWNrRm9udExvYWRlZCAoKSB7XHJcbiAgICBsZXQgYWxsRm9udHNMb2FkZWQgPSB0cnVlO1xyXG4gICAgbGV0IG5vdyA9IERhdGUubm93KCk7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IF9sb2FkaW5nRm9udHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgICBsZXQgZm9udExvYWRIYW5kbGUgPSBfbG9hZGluZ0ZvbnRzW2ldO1xyXG4gICAgICAgIGxldCBmb250RmFtaWx5ID0gZm9udExvYWRIYW5kbGUuZm9udEZhbWlseU5hbWU7XHJcbiAgICAgICAgLy8gbG9hZCB0aW1lb3V0XHJcbiAgICAgICAgaWYgKG5vdyAtIGZvbnRMb2FkSGFuZGxlLnN0YXJ0VGltZSA+IF90aW1lb3V0KSB7XHJcbiAgICAgICAgICAgIHdhcm5JRCg0OTMzLCBmb250RmFtaWx5KTtcclxuICAgICAgICAgICAgZm9udExvYWRIYW5kbGUuY2FsbGJhY2sobnVsbCwgZm9udEZhbWlseSk7XHJcbiAgICAgICAgICAgIF9sb2FkaW5nRm9udHMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBvbGRXaWR0aCA9IGZvbnRMb2FkSGFuZGxlLnJlZldpZHRoO1xyXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcclxuICAgICAgICBfY2FudmFzQ29udGV4dC5mb250ID0gJzQwcHggJyArIGZvbnRGYW1pbHk7XHJcbiAgICAgICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgICAgIGxldCBuZXdXaWR0aCA9IHNhZmVNZWFzdXJlVGV4dChfY2FudmFzQ29udGV4dCwgX3Rlc3RTdHJpbmcpO1xyXG4gICAgICAgIC8vIGxvYWRlZCBzdWNjZXNzZnVsbHlcclxuICAgICAgICBpZiAob2xkV2lkdGggIT09IG5ld1dpZHRoKSB7XHJcbiAgICAgICAgICAgIF9sb2FkaW5nRm9udHMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICBmb250TG9hZEhhbmRsZS5jYWxsYmFjayhudWxsLCBmb250RmFtaWx5KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSB7XHJcbiAgICAgICAgICAgIGFsbEZvbnRzTG9hZGVkID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChhbGxGb250c0xvYWRlZCkge1xyXG4gICAgICAgIGNsZWFySW50ZXJ2YWwoX2ludGVydmFsSWQpO1xyXG4gICAgICAgIF9pbnRlcnZhbElkID0gLTE7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBsb2FkRm9udCAoaXRlbSwgY2FsbGJhY2spIHtcclxuICAgIGxldCB1cmwgPSBpdGVtLnVybDtcclxuICAgIGxldCBmb250RmFtaWx5TmFtZSA9IF9nZXRGb250RmFtaWx5KHVybCk7XHJcblxyXG4gICAgLy8gQWxyZWFkeSBsb2FkZWQgZm9udHNcclxuICAgIGlmIChfZm9udEZhY2VzW2ZvbnRGYW1pbHlOYW1lXSkge1xyXG4gICAgICAgIHJldHVybiBmb250RmFtaWx5TmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIV9jYW52YXNDb250ZXh0KSB7XHJcbiAgICAgICAgbGV0IGxhYmVsQ2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7XHJcbiAgICAgICAgbGFiZWxDYW52YXMud2lkdGggPSAxMDA7XHJcbiAgICAgICAgbGFiZWxDYW52YXMuaGVpZ2h0ID0gMTAwO1xyXG4gICAgICAgIF9jYW52YXNDb250ZXh0ID0gbGFiZWxDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBEZWZhdWx0IHdpZHRoIHJlZmVyZW5jZSB0byB0ZXN0IHdoZXRoZXIgbmV3IGZvbnQgaXMgbG9hZGVkIGNvcnJlY3RseVxyXG4gICAgbGV0IGZvbnREZXNjID0gJzQwcHggJyArIGZvbnRGYW1pbHlOYW1lO1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgX2NhbnZhc0NvbnRleHQuZm9udCA9IGZvbnREZXNjO1xyXG4gICAgLy8gQHRzLWlnbm9yZVxyXG4gICAgbGV0IHJlZldpZHRoID0gc2FmZU1lYXN1cmVUZXh0KF9jYW52YXNDb250ZXh0LCBfdGVzdFN0cmluZyk7XHJcblxyXG4gICAgLy8gU2V0dXAgZm9udCBmYWNlIHN0eWxlXHJcbiAgICBsZXQgZm9udFN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInN0eWxlXCIpO1xyXG4gICAgZm9udFN0eWxlLnR5cGUgPSBcInRleHQvY3NzXCI7XHJcbiAgICBsZXQgZm9udFN0ciA9IFwiXCI7XHJcbiAgICBpZiAoaXNOYU4oZm9udEZhbWlseU5hbWUgLSAwKSlcclxuICAgICAgICBmb250U3RyICs9IFwiQGZvbnQtZmFjZSB7IGZvbnQtZmFtaWx5OlwiICsgZm9udEZhbWlseU5hbWUgKyBcIjsgc3JjOlwiO1xyXG4gICAgZWxzZVxyXG4gICAgICAgIGZvbnRTdHIgKz0gXCJAZm9udC1mYWNlIHsgZm9udC1mYW1pbHk6J1wiICsgZm9udEZhbWlseU5hbWUgKyBcIic7IHNyYzpcIjtcclxuICAgIGZvbnRTdHIgKz0gXCJ1cmwoJ1wiICsgdXJsICsgXCInKTtcIjtcclxuICAgIGZvbnRTdHlsZS50ZXh0Q29udGVudCA9IGZvbnRTdHIgKyBcIn1cIjtcclxuICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZm9udFN0eWxlKTtcclxuXHJcbiAgICAvLyBQcmVsb2FkIGZvbnQgd2l0aCBkaXZcclxuICAgIGxldCBwcmVsb2FkRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuICAgIGxldCBkaXZTdHlsZSA9IHByZWxvYWREaXYuc3R5bGU7XHJcbiAgICBkaXZTdHlsZS5mb250RmFtaWx5ID0gZm9udEZhbWlseU5hbWU7XHJcbiAgICBwcmVsb2FkRGl2LmlubmVySFRNTCA9IFwiLlwiO1xyXG4gICAgZGl2U3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XHJcbiAgICBkaXZTdHlsZS5sZWZ0ID0gXCItMTAwcHhcIjtcclxuICAgIGRpdlN0eWxlLnRvcCA9IFwiLTEwMHB4XCI7XHJcbiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHByZWxvYWREaXYpO1xyXG5cclxuICAgIGlmICh1c2VOYXRpdmVDaGVjaygpKSB7XHJcbiAgICAgICAgbmF0aXZlQ2hlY2tGb250TG9hZGVkKERhdGUubm93KCksIGZvbnRGYW1pbHlOYW1lLCBjYWxsYmFjayk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICAvLyBTYXZlIGxvYWRpbmcgZm9udFxyXG4gICAgICAgIGxldCBmb250TG9hZEhhbmRsZTogSUZvbnRMb2FkSGFuZGxlID0ge1xyXG4gICAgICAgICAgICBmb250RmFtaWx5TmFtZSxcclxuICAgICAgICAgICAgcmVmV2lkdGgsXHJcbiAgICAgICAgICAgIGNhbGxiYWNrLFxyXG4gICAgICAgICAgICBzdGFydFRpbWU6IERhdGUubm93KClcclxuICAgICAgICB9XHJcbiAgICAgICAgX2xvYWRpbmdGb250cy5wdXNoKGZvbnRMb2FkSGFuZGxlKTtcclxuICAgICAgICBpZiAoX2ludGVydmFsSWQgPT09IC0xKSB7XHJcbiAgICAgICAgICAgIF9pbnRlcnZhbElkID0gc2V0SW50ZXJ2YWwoX2NoZWNrRm9udExvYWRlZCwgMTAwKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBfZm9udEZhY2VzW2ZvbnRGYW1pbHlOYW1lXSA9IGZvbnRTdHlsZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIF9nZXRGb250RmFtaWx5IChmb250SGFuZGxlKSB7XHJcbiAgICBsZXQgdHRmSW5kZXggPSBmb250SGFuZGxlLmxhc3RJbmRleE9mKFwiLnR0ZlwiKTtcclxuICAgIGlmICh0dGZJbmRleCA9PT0gLTEpIHJldHVybiBmb250SGFuZGxlO1xyXG5cclxuICAgIGxldCBzbGFzaFBvcyA9IGZvbnRIYW5kbGUubGFzdEluZGV4T2YoXCIvXCIpO1xyXG4gICAgbGV0IGZvbnRGYW1pbHlOYW1lO1xyXG4gICAgaWYgKHNsYXNoUG9zID09PSAtMSkge1xyXG4gICAgICAgIGZvbnRGYW1pbHlOYW1lID0gZm9udEhhbmRsZS5zdWJzdHJpbmcoMCwgdHRmSW5kZXgpICsgXCJfTEFCRUxcIjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgICAgZm9udEZhbWlseU5hbWUgPSBmb250SGFuZGxlLnN1YnN0cmluZyhzbGFzaFBvcyArIDEsIHR0ZkluZGV4KSArIFwiX0xBQkVMXCI7XHJcbiAgICB9XHJcbiAgICBpZiAoZm9udEZhbWlseU5hbWUuaW5kZXhPZignICcpICE9PSAtMSkge1xyXG4gICAgICAgIGZvbnRGYW1pbHlOYW1lID0gJ1wiJyArIGZvbnRGYW1pbHlOYW1lICsgJ1wiJztcclxuICAgIH1cclxuICAgIHJldHVybiBmb250RmFtaWx5TmFtZTtcclxufSJdfQ==