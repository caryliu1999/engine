(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../../gfx/define.js", "../../gfx/texture.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../../gfx/define.js"), require("../../gfx/texture.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.define, global.texture);
    global.textureBufferPool = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _define, _texture) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.nearestPOT = nearestPOT;
  _exports.TextureBufferPool = void 0;

  function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

  function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

  function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

  function nearestPOT(num) {
    --num;
    num |= num >> 16;
    num |= num >> 8;
    num |= num >> 4;
    num |= num >> 2;
    num |= num >> 1;
    ++num;
    return num;
  }

  function roundUp(n, alignment) {
    return Math.ceil(n / alignment) * alignment;
  }

  var TextureBufferPool = /*#__PURE__*/function () {
    function TextureBufferPool(device) {
      _classCallCheck(this, TextureBufferPool);

      this._device = void 0;
      this._format = _define.GFXFormat.UNKNOWN;
      this._formatSize = 0;
      this._chunks = [];
      this._chunkCount = 0;
      this._handles = [];
      this._region0 = new _define.GFXBufferTextureCopy();
      this._region1 = new _define.GFXBufferTextureCopy();
      this._region2 = new _define.GFXBufferTextureCopy();
      this._roundUpFn = null;
      this._bufferViewCtor = Uint8Array;
      this._channels = 4;
      this._alignment = 1;
      this._device = device;
    }

    _createClass(TextureBufferPool, [{
      key: "initialize",
      value: function initialize(info) {
        var formatInfo = _define.GFXFormatInfos[info.format];
        this._format = info.format;
        this._formatSize = formatInfo.size;
        this._channels = formatInfo.count;
        this._bufferViewCtor = (0, _define.getTypedArrayConstructor)(formatInfo);
        this._roundUpFn = info.roundUpFn || null;
        this._alignment = info.alignment || 1;

        if (info.inOrderFree) {
          this.alloc = this._McDonaldAlloc;
        }
      }
    }, {
      key: "destroy",
      value: function destroy() {
        for (var i = 0; i < this._chunkCount; ++i) {
          var chunk = this._chunks[i];
          chunk.texture.destroy();
        }

        this._chunks.length = 0;
        this._handles.length = 0;
      }
    }, {
      key: "alloc",
      value: function alloc(size, chunkIdx) {
        size = roundUp(size, this._alignment);
        var index = -1;
        var start = -1;

        if (chunkIdx !== undefined) {
          index = chunkIdx;
          start = this._findAvailableSpace(size, index);
        }

        if (start < 0) {
          for (var i = 0; i < this._chunkCount; ++i) {
            index = i;
            start = this._findAvailableSpace(size, index);

            if (start >= 0) {
              break;
            }
          }
        }

        if (start >= 0) {
          var chunk = this._chunks[index];
          chunk.start += size;
          var handle = {
            chunkIdx: index,
            start: start,
            end: start + size,
            texture: chunk.texture
          };

          this._handles.push(handle);

          return handle;
        } // create a new one


        var targetSize = Math.sqrt(size / this._formatSize);
        var texLength = this._roundUpFn && this._roundUpFn(targetSize, this._formatSize) || Math.max(1024, nearestPOT(targetSize));

        var newChunk = this._chunks[this.createChunk(texLength)];

        newChunk.start += size;
        var texHandle = {
          chunkIdx: this._chunkCount - 1,
          start: 0,
          end: size,
          texture: newChunk.texture
        };

        this._handles.push(texHandle);

        return texHandle;
      }
    }, {
      key: "free",
      value: function free(handle) {
        for (var i = 0; i < this._handles.length; ++i) {
          if (this._handles[i] === handle) {
            this._chunks[handle.chunkIdx].end = handle.end;

            this._handles.splice(i, 1);

            return;
          }
        }
      }
    }, {
      key: "createChunk",
      value: function createChunk(length) {
        var texSize = length * length * this._formatSize;
        console.info('TextureBufferPool: Allocate chunk ' + this._chunkCount + ', size: ' + texSize + ', format: ' + this._format);

        var texture = this._device.createTexture(new _texture.GFXTextureInfo(_define.GFXTextureType.TEX2D, _define.GFXTextureUsageBit.SAMPLED | _define.GFXTextureUsageBit.TRANSFER_DST, this._format, length, length));

        var chunk = {
          texture: texture,
          size: texSize,
          start: 0,
          end: texSize
        };
        this._chunks[this._chunkCount] = chunk;
        return this._chunkCount++;
      }
    }, {
      key: "update",
      value: function update(handle, buffer) {
        var buffers = [];
        var regions = [];
        var start = handle.start / this._formatSize;
        var remainSize = buffer.byteLength / this._formatSize;
        var offsetX = start % handle.texture.width;
        var offsetY = Math.floor(start / handle.texture.width);
        var copySize = Math.min(handle.texture.width - offsetX, remainSize);
        var begin = 0;

        if (offsetX > 0) {
          this._region0.texOffset.x = offsetX;
          this._region0.texOffset.y = offsetY;
          this._region0.texExtent.width = copySize;
          this._region0.texExtent.height = 1;
          buffers.push(new this._bufferViewCtor(buffer, begin * this._formatSize, copySize * this._channels));
          regions.push(this._region0);
          offsetX = 0;
          offsetY += 1;
          remainSize -= copySize;
          begin += copySize;
        }

        if (remainSize > 0) {
          this._region1.texOffset.x = offsetX;
          this._region1.texOffset.y = offsetY;

          if (remainSize > handle.texture.width) {
            this._region1.texExtent.width = handle.texture.width;
            this._region1.texExtent.height = Math.floor(remainSize / handle.texture.width);
            copySize = this._region1.texExtent.width * this._region1.texExtent.height;
          } else {
            copySize = remainSize;
            this._region1.texExtent.width = copySize;
            this._region1.texExtent.height = 1;
          }

          buffers.push(new this._bufferViewCtor(buffer, begin * this._formatSize, copySize * this._channels));
          regions.push(this._region1);
          offsetX = 0;
          offsetY += this._region1.texExtent.height;
          remainSize -= copySize;
          begin += copySize;
        }

        if (remainSize > 0) {
          this._region2.texOffset.x = offsetX;
          this._region2.texOffset.y = offsetY;
          this._region2.texExtent.width = remainSize;
          this._region2.texExtent.height = 1;
          buffers.push(new this._bufferViewCtor(buffer, begin * this._formatSize, remainSize * this._channels));
          regions.push(this._region2);
        }

        this._device.copyBuffersToTexture(buffers, handle.texture, regions);
      }
    }, {
      key: "_findAvailableSpace",
      value: function _findAvailableSpace(size, chunkIdx) {
        var chunk = this._chunks[chunkIdx];
        var isFound = false;
        var start = chunk.start;

        if (start + size <= chunk.size) {
          isFound = true;
        } else {
          start = 0; // try to find from head again

          var handles = this._handles.filter(function (h) {
            return h.chunkIdx === chunkIdx;
          }).sort(function (a, b) {
            return a.start - b.start;
          });

          for (var i = 0; i < handles.length; i++) {
            var handle = handles[i];

            if (start + size <= handle.start) {
              isFound = true;
              break;
            }

            start = handle.end;
          }

          if (!isFound && start + size <= chunk.size) {
            isFound = true;
          }
        }

        return isFound ? start : -1;
      } // [McDonald 12] Efficient Buffer Management

    }, {
      key: "_McDonaldAlloc",
      value: function _McDonaldAlloc(size) {
        size = roundUp(size, this._alignment);

        for (var i = 0; i < this._chunkCount; ++i) {
          var chunk = this._chunks[i];
          var isFound = false;
          var start = chunk.start;

          if (start + size <= chunk.end) {
            isFound = true;
          } else if (start > chunk.end) {
            if (start + size <= chunk.size) {
              isFound = true;
            } else if (size <= chunk.end) {
              // Try to find from head again.
              chunk.start = start = 0;
              isFound = true;
            }
          } else if (start === chunk.end) {
            chunk.start = start = 0;
            chunk.end = chunk.size;

            if (size <= chunk.end) {
              isFound = true;
            }
          }

          if (isFound) {
            chunk.start += size;
            var handle = {
              chunkIdx: i,
              start: start,
              end: start + size,
              texture: chunk.texture
            };

            this._handles.push(handle);

            return handle;
          }
        } // create a new one


        var targetSize = Math.sqrt(size / this._formatSize);
        var texLength = this._roundUpFn && this._roundUpFn(targetSize, this._formatSize) || Math.max(1024, nearestPOT(targetSize));

        var newChunk = this._chunks[this.createChunk(texLength)];

        newChunk.start += size;
        var texHandle = {
          chunkIdx: this._chunkCount,
          start: 0,
          end: size,
          texture: newChunk.texture
        };

        this._handles.push(texHandle);

        return texHandle;
      }
    }]);

    return TextureBufferPool;
  }();

  _exports.TextureBufferPool = TextureBufferPool;
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL2NvcmUvcmVuZGVyZXIvY29yZS90ZXh0dXJlLWJ1ZmZlci1wb29sLnRzIl0sIm5hbWVzIjpbIm5lYXJlc3RQT1QiLCJudW0iLCJyb3VuZFVwIiwibiIsImFsaWdubWVudCIsIk1hdGgiLCJjZWlsIiwiVGV4dHVyZUJ1ZmZlclBvb2wiLCJkZXZpY2UiLCJfZGV2aWNlIiwiX2Zvcm1hdCIsIkdGWEZvcm1hdCIsIlVOS05PV04iLCJfZm9ybWF0U2l6ZSIsIl9jaHVua3MiLCJfY2h1bmtDb3VudCIsIl9oYW5kbGVzIiwiX3JlZ2lvbjAiLCJHRlhCdWZmZXJUZXh0dXJlQ29weSIsIl9yZWdpb24xIiwiX3JlZ2lvbjIiLCJfcm91bmRVcEZuIiwiX2J1ZmZlclZpZXdDdG9yIiwiVWludDhBcnJheSIsIl9jaGFubmVscyIsIl9hbGlnbm1lbnQiLCJpbmZvIiwiZm9ybWF0SW5mbyIsIkdGWEZvcm1hdEluZm9zIiwiZm9ybWF0Iiwic2l6ZSIsImNvdW50Iiwicm91bmRVcEZuIiwiaW5PcmRlckZyZWUiLCJhbGxvYyIsIl9NY0RvbmFsZEFsbG9jIiwiaSIsImNodW5rIiwidGV4dHVyZSIsImRlc3Ryb3kiLCJsZW5ndGgiLCJjaHVua0lkeCIsImluZGV4Iiwic3RhcnQiLCJ1bmRlZmluZWQiLCJfZmluZEF2YWlsYWJsZVNwYWNlIiwiaGFuZGxlIiwiZW5kIiwicHVzaCIsInRhcmdldFNpemUiLCJzcXJ0IiwidGV4TGVuZ3RoIiwibWF4IiwibmV3Q2h1bmsiLCJjcmVhdGVDaHVuayIsInRleEhhbmRsZSIsInNwbGljZSIsInRleFNpemUiLCJjb25zb2xlIiwiY3JlYXRlVGV4dHVyZSIsIkdGWFRleHR1cmVJbmZvIiwiR0ZYVGV4dHVyZVR5cGUiLCJURVgyRCIsIkdGWFRleHR1cmVVc2FnZUJpdCIsIlNBTVBMRUQiLCJUUkFOU0ZFUl9EU1QiLCJidWZmZXIiLCJidWZmZXJzIiwicmVnaW9ucyIsInJlbWFpblNpemUiLCJieXRlTGVuZ3RoIiwib2Zmc2V0WCIsIndpZHRoIiwib2Zmc2V0WSIsImZsb29yIiwiY29weVNpemUiLCJtaW4iLCJiZWdpbiIsInRleE9mZnNldCIsIngiLCJ5IiwidGV4RXh0ZW50IiwiaGVpZ2h0IiwiY29weUJ1ZmZlcnNUb1RleHR1cmUiLCJpc0ZvdW5kIiwiaGFuZGxlcyIsImZpbHRlciIsImgiLCJzb3J0IiwiYSIsImIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQVFPLFdBQVNBLFVBQVQsQ0FBcUJDLEdBQXJCLEVBQTBDO0FBQzdDLE1BQUVBLEdBQUY7QUFDQUEsSUFBQUEsR0FBRyxJQUFJQSxHQUFHLElBQUksRUFBZDtBQUNBQSxJQUFBQSxHQUFHLElBQUlBLEdBQUcsSUFBSSxDQUFkO0FBQ0FBLElBQUFBLEdBQUcsSUFBSUEsR0FBRyxJQUFJLENBQWQ7QUFDQUEsSUFBQUEsR0FBRyxJQUFJQSxHQUFHLElBQUksQ0FBZDtBQUNBQSxJQUFBQSxHQUFHLElBQUlBLEdBQUcsSUFBSSxDQUFkO0FBQ0EsTUFBRUEsR0FBRjtBQUNBLFdBQU9BLEdBQVA7QUFDSDs7QUF1QkQsV0FBU0MsT0FBVCxDQUFrQkMsQ0FBbEIsRUFBNkJDLFNBQTdCLEVBQWdEO0FBQzVDLFdBQU9DLElBQUksQ0FBQ0MsSUFBTCxDQUFVSCxDQUFDLEdBQUdDLFNBQWQsSUFBMkJBLFNBQWxDO0FBQ0g7O01BRVlHLGlCO0FBZ0JULCtCQUFvQkMsTUFBcEIsRUFBdUM7QUFBQTs7QUFBQSxXQWQvQkMsT0FjK0I7QUFBQSxXQWIvQkMsT0FhK0IsR0FickJDLGtCQUFVQyxPQWFXO0FBQUEsV0FaL0JDLFdBWStCLEdBWmpCLENBWWlCO0FBQUEsV0FYL0JDLE9BVytCLEdBWEgsRUFXRztBQUFBLFdBVi9CQyxXQVUrQixHQVZqQixDQVVpQjtBQUFBLFdBVC9CQyxRQVMrQixHQVRJLEVBU0o7QUFBQSxXQVIvQkMsUUFRK0IsR0FScEIsSUFBSUMsNEJBQUosRUFRb0I7QUFBQSxXQVAvQkMsUUFPK0IsR0FQ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O0FBQ0osU0FuQ2lDLENBcUNsQzs7O0FBQ0EsWUFBTUcsVUFBVSxHQUFHNUMsSUFBSSxDQUFDNkMsSUFBTCxDQUFVcEIsSUFBSSxHQUFHLEtBQUtqQixXQUF0QixDQUFuQjtBQUNBLFlBQU1zQyxTQUFTLEdBQUcsS0FBSzlCLFVBQUwsSUFBbUIsS0FBS0EsVUFBTCxDQUFnQjRCLFVBQWhCLEVBQTRCLEtBQUtwQyxXQUFqQyxDQUFuQixJQUFvRVIsSUFBSSxDQUFDK0MsR0FBTCxDQUFTLElBQVQsRUFBZXBELFVBQVUsQ0FBQ2lELFVBQUQsQ0FBekIsQ0FBdEY7O0FBQ0EsWUFBTUksUUFBUSxHQUFHLEtBQUt2QyxPQUFMLENBQWEsS0FBS3dDLFdBQUwsQ0FBaUJILFNBQWpCLENBQWIsQ0FBakI7O0FBRUFFLFFBQUFBLFFBQVEsQ0FBQ1YsS0FBVCxJQUFrQmIsSUFBbEI7QUFDQSxZQUFNeUIsU0FBK0IsR0FBRztBQUNwQ2QsVUFBQUEsUUFBUSxFQUFFLEtBQUsxQixXQURxQjtBQUVwQzRCLFVBQUFBLEtBQUssRUFBRSxDQUY2QjtBQUdwQ0ksVUFBQUEsR0FBRyxFQUFFakIsSUFIK0I7QUFJcENRLFVBQUFBLE9BQU8sRUFBRWUsUUFBUSxDQUFDZjtBQUprQixTQUF4Qzs7QUFNQSxhQUFLdEIsUUFBTCxDQUFjZ0MsSUFBZCxDQUFtQk8sU0FBbkI7O0FBQ0EsZUFBT0EsU0FBUDtBQUNIIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIEBoaWRkZW5cclxuICovXHJcblxyXG5pbXBvcnQgeyBnZXRUeXBlZEFycmF5Q29uc3RydWN0b3IsIEdGWEJ1ZmZlclRleHR1cmVDb3B5LCBHRlhGb3JtYXQsIEdGWEZvcm1hdEluZm9zLCBHRlhUZXh0dXJlVHlwZSwgR0ZYVGV4dHVyZVVzYWdlQml0LCBHRlhUZXh0dXJlRmxhZ0JpdCB9IGZyb20gJy4uLy4uL2dmeC9kZWZpbmUnO1xyXG5pbXBvcnQgeyBHRlhEZXZpY2UgfSBmcm9tICcuLi8uLi9nZngvZGV2aWNlJztcclxuaW1wb3J0IHsgR0ZYVGV4dHVyZSwgR0ZYVGV4dHVyZUluZm8gfSBmcm9tICcuLi8uLi9nZngvdGV4dHVyZSc7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbmVhcmVzdFBPVCAobnVtOiBudW1iZXIpOiBudW1iZXIge1xyXG4gICAgLS1udW07XHJcbiAgICBudW0gfD0gbnVtID4+IDE2O1xyXG4gICAgbnVtIHw9IG51bSA+PiA4O1xyXG4gICAgbnVtIHw9IG51bSA+PiA0O1xyXG4gICAgbnVtIHw9IG51bSA+PiAyO1xyXG4gICAgbnVtIHw9IG51bSA+PiAxO1xyXG4gICAgKytudW07XHJcbiAgICByZXR1cm4gbnVtO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElUZXh0dXJlQnVmZmVyIHtcclxuICAgIHRleHR1cmU6IEdGWFRleHR1cmU7XHJcbiAgICBzaXplOiBudW1iZXI7XHJcbiAgICBzdGFydDogbnVtYmVyO1xyXG4gICAgZW5kOiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSVRleHR1cmVCdWZmZXJIYW5kbGUge1xyXG4gICAgY2h1bmtJZHg6IG51bWJlcjtcclxuICAgIHN0YXJ0OiBudW1iZXI7XHJcbiAgICBlbmQ6IG51bWJlcjtcclxuICAgIHRleHR1cmU6IEdGWFRleHR1cmU7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgSVRleHR1cmVCdWZmZXJQb29sSW5mbyB7XHJcbiAgICBmb3JtYXQ6IEdGWEZvcm1hdDsgLy8gdGFyZ2V0IHRleHR1cmUgZm9ybWF0XHJcbiAgICBpbk9yZGVyRnJlZT86IGJvb2xlYW47IC8vIHdpbGwgdGhlIGhhbmRsZXMgYmUgZnJlZWQgZXhhY3RseSBpbiB0aGUgb3JkZXIgb2YgdGhlaXIgYWxsb2NhdGlvbj9cclxuICAgIGFsaWdubWVudD86IG51bWJlcjsgLy8gdGhlIGRhdGEgYWxpZ25tZW50IGZvciBlYWNoIGhhbmRsZSBhbGxvY2F0ZWQsIGluIGJ5dGVzXHJcbiAgICByb3VuZFVwRm4/OiAoc2l6ZTogbnVtYmVyLCBmb3JtYXRTaXplOiBudW1iZXIpID0+IG51bWJlcjsgLy8gZ2l2ZW4gYSB0YXJnZXQgc2l6ZSwgaG93IHdpbGwgdGhlIGFjdHVhbCB0ZXh0dXJlIHNpemUgcm91bmQgdXA/XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJvdW5kVXAgKG46IG51bWJlciwgYWxpZ25tZW50OiBudW1iZXIpIHtcclxuICAgIHJldHVybiBNYXRoLmNlaWwobiAvIGFsaWdubWVudCkgKiBhbGlnbm1lbnQ7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBUZXh0dXJlQnVmZmVyUG9vbCB7XHJcblxyXG4gICAgcHJpdmF0ZSBfZGV2aWNlOiBHRlhEZXZpY2U7XHJcbiAgICBwcml2YXRlIF9mb3JtYXQgPSBHRlhGb3JtYXQuVU5LTk9XTjtcclxuICAgIHByaXZhdGUgX2Zvcm1hdFNpemUgPSAwO1xyXG4gICAgcHJpdmF0ZSBfY2h1bmtzOiBJVGV4dHVyZUJ1ZmZlcltdID0gW107XHJcbiAgICBwcml2YXRlIF9jaHVua0NvdW50ID0gMDtcclxuICAgIHByaXZhdGUgX2hhbmRsZXM6IElUZXh0dXJlQnVmZmVySGFuZGxlW10gPSBbXTtcclxuICAgIHByaXZhdGUgX3JlZ2lvbjAgPSBuZXcgR0ZYQnVmZmVyVGV4dHVyZUNvcHkoKTtcclxuICAgIHByaXZhdGUgX3JlZ2lvbjEgPSBuZXcgR0ZYQnVmZmVyVGV4dHVyZUNvcHkoKTtcclxuICAgIHByaXZhdGUgX3JlZ2lvbjIgPSBuZXcgR0ZYQnVmZmVyVGV4dHVyZUNvcHkoKTtcclxuICAgIHByaXZhdGUgX3JvdW5kVXBGbjogKCh0YXJnZXRTaXplOiBudW1iZXIsIGZvcm1hdFNpemU6IG51bWJlcikgPT4gbnVtYmVyKSB8IG51bGwgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBfYnVmZmVyVmlld0N0b3I6IFR5cGVkQXJyYXlDb25zdHJ1Y3RvciA9IFVpbnQ4QXJyYXk7XHJcbiAgICBwcml2YXRlIF9jaGFubmVscyA9IDQ7XHJcbiAgICBwcml2YXRlIF9hbGlnbm1lbnQgPSAxO1xyXG5cclxuICAgIHB1YmxpYyBjb25zdHJ1Y3RvciAoZGV2aWNlOiBHRlhEZXZpY2UpIHtcclxuICAgICAgICB0aGlzLl9kZXZpY2UgPSBkZXZpY2U7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGluaXRpYWxpemUgKGluZm86IElUZXh0dXJlQnVmZmVyUG9vbEluZm8pIHtcclxuICAgICAgICBjb25zdCBmb3JtYXRJbmZvID0gR0ZYRm9ybWF0SW5mb3NbaW5mby5mb3JtYXRdO1xyXG4gICAgICAgIHRoaXMuX2Zvcm1hdCA9IGluZm8uZm9ybWF0O1xyXG4gICAgICAgIHRoaXMuX2Zvcm1hdFNpemUgPSBmb3JtYXRJbmZvLnNpemU7XHJcbiAgICAgICAgdGhpcy5fY2hhbm5lbHMgPSBmb3JtYXRJbmZvLmNvdW50O1xyXG4gICAgICAgIHRoaXMuX2J1ZmZlclZpZXdDdG9yID0gZ2V0VHlwZWRBcnJheUNvbnN0cnVjdG9yKGZvcm1hdEluZm8pO1xyXG4gICAgICAgIHRoaXMuX3JvdW5kVXBGbiA9IGluZm8ucm91bmRVcEZuIHx8IG51bGw7XHJcbiAgICAgICAgdGhpcy5fYWxpZ25tZW50ID0gaW5mby5hbGlnbm1lbnQgfHwgMTtcclxuICAgICAgICBpZiAoaW5mby5pbk9yZGVyRnJlZSkgeyB0aGlzLmFsbG9jID0gdGhpcy5fTWNEb25hbGRBbGxvYzsgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBkZXN0cm95ICgpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2NodW5rQ291bnQ7ICsraSkge1xyXG4gICAgICAgICAgICBjb25zdCBjaHVuayA9IHRoaXMuX2NodW5rc1tpXTtcclxuICAgICAgICAgICAgY2h1bmsudGV4dHVyZS5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2NodW5rcy5sZW5ndGggPSAwO1xyXG4gICAgICAgIHRoaXMuX2hhbmRsZXMubGVuZ3RoID0gMDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgYWxsb2MgKHNpemU6IG51bWJlciwgY2h1bmtJZHg/OiBudW1iZXIpIHtcclxuICAgICAgICBzaXplID0gcm91bmRVcChzaXplLCB0aGlzLl9hbGlnbm1lbnQpO1xyXG5cclxuICAgICAgICBsZXQgaW5kZXggPSAtMTtcclxuICAgICAgICBsZXQgc3RhcnQgPSAtMTtcclxuICAgICAgICBpZiAoY2h1bmtJZHggIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICBpbmRleCA9IGNodW5rSWR4O1xyXG4gICAgICAgICAgICBzdGFydCA9IHRoaXMuX2ZpbmRBdmFpbGFibGVTcGFjZShzaXplLCBpbmRleCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc3RhcnQgPCAwKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fY2h1bmtDb3VudDsgKytpKSB7XHJcbiAgICAgICAgICAgICAgICBpbmRleCA9IGk7XHJcbiAgICAgICAgICAgICAgICBzdGFydCA9IHRoaXMuX2ZpbmRBdmFpbGFibGVTcGFjZShzaXplLCBpbmRleCk7XHJcbiAgICAgICAgICAgICAgICBpZiAoc3RhcnQgPj0gMCkgeyBicmVhazsgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoc3RhcnQgPj0gMCkge1xyXG4gICAgICAgICAgICBjb25zdCBjaHVuayA9IHRoaXMuX2NodW5rc1tpbmRleF07XHJcbiAgICAgICAgICAgIGNodW5rLnN0YXJ0ICs9IHNpemU7XHJcbiAgICAgICAgICAgIGNvbnN0IGhhbmRsZTogSVRleHR1cmVCdWZmZXJIYW5kbGUgPSB7XHJcbiAgICAgICAgICAgICAgICBjaHVua0lkeDogaW5kZXgsXHJcbiAgICAgICAgICAgICAgICBzdGFydCxcclxuICAgICAgICAgICAgICAgIGVuZDogc3RhcnQgKyBzaXplLFxyXG4gICAgICAgICAgICAgICAgdGV4dHVyZTogY2h1bmsudGV4dHVyZSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgdGhpcy5faGFuZGxlcy5wdXNoKGhhbmRsZSk7XHJcbiAgICAgICAgICAgIHJldHVybiBoYW5kbGU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBjcmVhdGUgYSBuZXcgb25lXHJcbiAgICAgICAgY29uc3QgdGFyZ2V0U2l6ZSA9IE1hdGguc3FydChzaXplIC8gdGhpcy5fZm9ybWF0U2l6ZSk7XHJcbiAgICAgICAgY29uc3QgdGV4TGVuZ3RoID0gdGhpcy5fcm91bmRVcEZuICYmIHRoaXMuX3JvdW5kVXBGbih0YXJnZXRTaXplLCB0aGlzLl9mb3JtYXRTaXplKSB8fCBNYXRoLm1heCgxMDI0LCBuZWFyZXN0UE9UKHRhcmdldFNpemUpKTtcclxuICAgICAgICBjb25zdCBuZXdDaHVuayA9IHRoaXMuX2NodW5rc1t0aGlzLmNyZWF0ZUNodW5rKHRleExlbmd0aCldO1xyXG5cclxuICAgICAgICBuZXdDaHVuay5zdGFydCArPSBzaXplO1xyXG4gICAgICAgIGNvbnN0IHRleEhhbmRsZTogSVRleHR1cmVCdWZmZXJIYW5kbGUgPSB7XHJcbiAgICAgICAgICAgIGNodW5rSWR4OiB0aGlzLl9jaHVua0NvdW50IC0gMSxcclxuICAgICAgICAgICAgc3RhcnQ6IDAsXHJcbiAgICAgICAgICAgIGVuZDogc2l6ZSxcclxuICAgICAgICAgICAgdGV4dHVyZTogbmV3Q2h1bmsudGV4dHVyZSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuX2hhbmRsZXMucHVzaCh0ZXhIYW5kbGUpO1xyXG4gICAgICAgIHJldHVybiB0ZXhIYW5kbGU7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGZyZWUgKGhhbmRsZTogSVRleHR1cmVCdWZmZXJIYW5kbGUpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuX2hhbmRsZXMubGVuZ3RoOyArK2kpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuX2hhbmRsZXNbaV0gPT09IGhhbmRsZSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fY2h1bmtzW2hhbmRsZS5jaHVua0lkeF0uZW5kID0gaGFuZGxlLmVuZDtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZXMuc3BsaWNlKGksIDEpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBjcmVhdGVDaHVuayAobGVuZ3RoOiBudW1iZXIpIHtcclxuICAgICAgICBjb25zdCB0ZXhTaXplID0gbGVuZ3RoICogbGVuZ3RoICogdGhpcy5fZm9ybWF0U2l6ZTtcclxuXHJcbiAgICAgICAgY29uc29sZS5pbmZvKCdUZXh0dXJlQnVmZmVyUG9vbDogQWxsb2NhdGUgY2h1bmsgJyArIHRoaXMuX2NodW5rQ291bnQgKyAnLCBzaXplOiAnICsgdGV4U2l6ZSArICcsIGZvcm1hdDogJyArIHRoaXMuX2Zvcm1hdCk7XHJcblxyXG4gICAgICAgIGNvbnN0IHRleHR1cmU6IEdGWFRleHR1cmUgPSB0aGlzLl9kZXZpY2UuY3JlYXRlVGV4dHVyZShuZXcgR0ZYVGV4dHVyZUluZm8oXHJcbiAgICAgICAgICAgIEdGWFRleHR1cmVUeXBlLlRFWDJELFxyXG4gICAgICAgICAgICBHRlhUZXh0dXJlVXNhZ2VCaXQuU0FNUExFRCB8IEdGWFRleHR1cmVVc2FnZUJpdC5UUkFOU0ZFUl9EU1QsXHJcbiAgICAgICAgICAgIHRoaXMuX2Zvcm1hdCxcclxuICAgICAgICAgICAgbGVuZ3RoLFxyXG4gICAgICAgICAgICBsZW5ndGgsXHJcbiAgICAgICAgKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNodW5rOiBJVGV4dHVyZUJ1ZmZlciA9IHtcclxuICAgICAgICAgICAgdGV4dHVyZSxcclxuICAgICAgICAgICAgc2l6ZTogdGV4U2l6ZSxcclxuICAgICAgICAgICAgc3RhcnQ6IDAsXHJcbiAgICAgICAgICAgIGVuZDogdGV4U2l6ZSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuX2NodW5rc1t0aGlzLl9jaHVua0NvdW50XSA9IGNodW5rO1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jaHVua0NvdW50Kys7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHVwZGF0ZSAoaGFuZGxlOiBJVGV4dHVyZUJ1ZmZlckhhbmRsZSwgYnVmZmVyOiBBcnJheUJ1ZmZlcikge1xyXG5cclxuICAgICAgICBjb25zdCBidWZmZXJzOiBBcnJheUJ1ZmZlclZpZXdbXSA9IFtdO1xyXG4gICAgICAgIGNvbnN0IHJlZ2lvbnM6IEdGWEJ1ZmZlclRleHR1cmVDb3B5W10gPSBbXTtcclxuICAgICAgICBjb25zdCBzdGFydCA9IGhhbmRsZS5zdGFydCAvIHRoaXMuX2Zvcm1hdFNpemU7XHJcblxyXG4gICAgICAgIGxldCByZW1haW5TaXplID0gYnVmZmVyLmJ5dGVMZW5ndGggLyB0aGlzLl9mb3JtYXRTaXplO1xyXG4gICAgICAgIGxldCBvZmZzZXRYID0gc3RhcnQgJSBoYW5kbGUudGV4dHVyZS53aWR0aDtcclxuICAgICAgICBsZXQgb2Zmc2V0WSA9IE1hdGguZmxvb3Ioc3RhcnQgLyBoYW5kbGUudGV4dHVyZS53aWR0aCk7XHJcbiAgICAgICAgbGV0IGNvcHlTaXplID0gTWF0aC5taW4oaGFuZGxlLnRleHR1cmUud2lkdGggLSBvZmZzZXRYLCByZW1haW5TaXplKTtcclxuICAgICAgICBsZXQgYmVnaW4gPSAwO1xyXG5cclxuICAgICAgICBpZiAob2Zmc2V0WCA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5fcmVnaW9uMC50ZXhPZmZzZXQueCA9IG9mZnNldFg7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlZ2lvbjAudGV4T2Zmc2V0LnkgPSBvZmZzZXRZO1xyXG4gICAgICAgICAgICB0aGlzLl9yZWdpb24wLnRleEV4dGVudC53aWR0aCA9IGNvcHlTaXplO1xyXG4gICAgICAgICAgICB0aGlzLl9yZWdpb24wLnRleEV4dGVudC5oZWlnaHQgPSAxO1xyXG5cclxuICAgICAgICAgICAgYnVmZmVycy5wdXNoKG5ldyB0aGlzLl9idWZmZXJWaWV3Q3RvcihidWZmZXIsIGJlZ2luICogdGhpcy5fZm9ybWF0U2l6ZSwgY29weVNpemUgKiB0aGlzLl9jaGFubmVscykpO1xyXG4gICAgICAgICAgICByZWdpb25zLnB1c2godGhpcy5fcmVnaW9uMCk7XHJcblxyXG4gICAgICAgICAgICBvZmZzZXRYID0gMDtcclxuICAgICAgICAgICAgb2Zmc2V0WSArPSAxO1xyXG4gICAgICAgICAgICByZW1haW5TaXplIC09IGNvcHlTaXplO1xyXG4gICAgICAgICAgICBiZWdpbiArPSBjb3B5U2l6ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChyZW1haW5TaXplID4gMCkge1xyXG4gICAgICAgICAgICB0aGlzLl9yZWdpb24xLnRleE9mZnNldC54ID0gb2Zmc2V0WDtcclxuICAgICAgICAgICAgdGhpcy5fcmVnaW9uMS50ZXhPZmZzZXQueSA9IG9mZnNldFk7XHJcblxyXG4gICAgICAgICAgICBpZiAocmVtYWluU2l6ZSA+IGhhbmRsZS50ZXh0dXJlLndpZHRoKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9yZWdpb24xLnRleEV4dGVudC53aWR0aCA9IGhhbmRsZS50ZXh0dXJlLndpZHRoO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fcmVnaW9uMS50ZXhFeHRlbnQuaGVpZ2h0ID0gTWF0aC5mbG9vcihyZW1haW5TaXplIC8gaGFuZGxlLnRleHR1cmUud2lkdGgpO1xyXG4gICAgICAgICAgICAgICAgY29weVNpemUgPSB0aGlzLl9yZWdpb24xLnRleEV4dGVudC53aWR0aCAqIHRoaXMuX3JlZ2lvbjEudGV4RXh0ZW50LmhlaWdodDtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvcHlTaXplID0gcmVtYWluU2l6ZTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3JlZ2lvbjEudGV4RXh0ZW50LndpZHRoID0gY29weVNpemU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9yZWdpb24xLnRleEV4dGVudC5oZWlnaHQgPSAxO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBidWZmZXJzLnB1c2gobmV3IHRoaXMuX2J1ZmZlclZpZXdDdG9yKGJ1ZmZlciwgYmVnaW4gKiB0aGlzLl9mb3JtYXRTaXplLCBjb3B5U2l6ZSAqIHRoaXMuX2NoYW5uZWxzKSk7XHJcbiAgICAgICAgICAgIHJlZ2lvbnMucHVzaCh0aGlzLl9yZWdpb24xKTtcclxuXHJcbiAgICAgICAgICAgIG9mZnNldFggPSAwO1xyXG4gICAgICAgICAgICBvZmZzZXRZICs9IHRoaXMuX3JlZ2lvbjEudGV4RXh0ZW50LmhlaWdodDtcclxuICAgICAgICAgICAgcmVtYWluU2l6ZSAtPSBjb3B5U2l6ZTtcclxuICAgICAgICAgICAgYmVnaW4gKz0gY29weVNpemU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocmVtYWluU2l6ZSA+IDApIHtcclxuICAgICAgICAgICAgdGhpcy5fcmVnaW9uMi50ZXhPZmZzZXQueCA9IG9mZnNldFg7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlZ2lvbjIudGV4T2Zmc2V0LnkgPSBvZmZzZXRZO1xyXG4gICAgICAgICAgICB0aGlzLl9yZWdpb24yLnRleEV4dGVudC53aWR0aCA9IHJlbWFpblNpemU7XHJcbiAgICAgICAgICAgIHRoaXMuX3JlZ2lvbjIudGV4RXh0ZW50LmhlaWdodCA9IDE7XHJcblxyXG4gICAgICAgICAgICBidWZmZXJzLnB1c2gobmV3IHRoaXMuX2J1ZmZlclZpZXdDdG9yKGJ1ZmZlciwgYmVnaW4gKiB0aGlzLl9mb3JtYXRTaXplLCByZW1haW5TaXplICogdGhpcy5fY2hhbm5lbHMpKTtcclxuICAgICAgICAgICAgcmVnaW9ucy5wdXNoKHRoaXMuX3JlZ2lvbjIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fZGV2aWNlLmNvcHlCdWZmZXJzVG9UZXh0dXJlKGJ1ZmZlcnMsIGhhbmRsZS50ZXh0dXJlLCByZWdpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9maW5kQXZhaWxhYmxlU3BhY2UgKHNpemU6IG51bWJlciwgY2h1bmtJZHg6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5fY2h1bmtzW2NodW5rSWR4XTtcclxuICAgICAgICBsZXQgaXNGb3VuZCA9IGZhbHNlO1xyXG4gICAgICAgIGxldCBzdGFydCA9IGNodW5rLnN0YXJ0O1xyXG4gICAgICAgIGlmICgoc3RhcnQgKyBzaXplKSA8PSBjaHVuay5zaXplKSB7XHJcbiAgICAgICAgICAgIGlzRm91bmQgPSB0cnVlO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gMDsgLy8gdHJ5IHRvIGZpbmQgZnJvbSBoZWFkIGFnYWluXHJcbiAgICAgICAgICAgIGNvbnN0IGhhbmRsZXMgPSB0aGlzLl9oYW5kbGVzLmZpbHRlcigoaCkgPT4gaC5jaHVua0lkeCA9PT0gY2h1bmtJZHgpLnNvcnQoKGEsIGIpID0+IGEuc3RhcnQgLSBiLnN0YXJ0KTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoYW5kbGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBoYW5kbGUgPSBoYW5kbGVzW2ldO1xyXG4gICAgICAgICAgICAgICAgaWYgKChzdGFydCArIHNpemUpIDw9IGhhbmRsZS5zdGFydCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlzRm91bmQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgc3RhcnQgPSBoYW5kbGUuZW5kO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICghaXNGb3VuZCAmJiAoc3RhcnQgKyBzaXplKSA8PSBjaHVuay5zaXplKSB7XHJcbiAgICAgICAgICAgICAgICBpc0ZvdW5kID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gaXNGb3VuZCA/IHN0YXJ0IDogLTE7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gW01jRG9uYWxkIDEyXSBFZmZpY2llbnQgQnVmZmVyIE1hbmFnZW1lbnRcclxuICAgIHByaXZhdGUgX01jRG9uYWxkQWxsb2MgKHNpemU6IG51bWJlcikge1xyXG4gICAgICAgIHNpemUgPSByb3VuZFVwKHNpemUsIHRoaXMuX2FsaWdubWVudCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fY2h1bmtDb3VudDsgKytpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNodW5rID0gdGhpcy5fY2h1bmtzW2ldO1xyXG4gICAgICAgICAgICBsZXQgaXNGb3VuZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICBsZXQgc3RhcnQgPSBjaHVuay5zdGFydDtcclxuICAgICAgICAgICAgaWYgKChzdGFydCArIHNpemUpIDw9IGNodW5rLmVuZCkge1xyXG4gICAgICAgICAgICAgICAgaXNGb3VuZCA9IHRydWU7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnQgPiBjaHVuay5lbmQpIHtcclxuICAgICAgICAgICAgICAgIGlmICgoc3RhcnQgKyBzaXplKSA8PSBjaHVuay5zaXplKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaXNGb3VuZCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNpemUgPD0gY2h1bmsuZW5kKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gVHJ5IHRvIGZpbmQgZnJvbSBoZWFkIGFnYWluLlxyXG4gICAgICAgICAgICAgICAgICAgIGNodW5rLnN0YXJ0ID0gc3RhcnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgIGlzRm91bmQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0ID09PSBjaHVuay5lbmQpIHtcclxuICAgICAgICAgICAgICAgIGNodW5rLnN0YXJ0ID0gc3RhcnQgPSAwO1xyXG4gICAgICAgICAgICAgICAgY2h1bmsuZW5kID0gY2h1bmsuc2l6ZTtcclxuICAgICAgICAgICAgICAgIGlmIChzaXplIDw9IGNodW5rLmVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlzRm91bmQgPSB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpc0ZvdW5kKSB7XHJcbiAgICAgICAgICAgICAgICBjaHVuay5zdGFydCArPSBzaXplO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaGFuZGxlOiBJVGV4dHVyZUJ1ZmZlckhhbmRsZSA9IHtcclxuICAgICAgICAgICAgICAgICAgICBjaHVua0lkeDogaSxcclxuICAgICAgICAgICAgICAgICAgICBzdGFydCxcclxuICAgICAgICAgICAgICAgICAgICBlbmQ6IHN0YXJ0ICsgc2l6ZSxcclxuICAgICAgICAgICAgICAgICAgICB0ZXh0dXJlOiBjaHVuay50ZXh0dXJlLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2hhbmRsZXMucHVzaChoYW5kbGUpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhhbmRsZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gY3JlYXRlIGEgbmV3IG9uZVxyXG4gICAgICAgIGNvbnN0IHRhcmdldFNpemUgPSBNYXRoLnNxcnQoc2l6ZSAvIHRoaXMuX2Zvcm1hdFNpemUpO1xyXG4gICAgICAgIGNvbnN0IHRleExlbmd0aCA9IHRoaXMuX3JvdW5kVXBGbiAmJiB0aGlzLl9yb3VuZFVwRm4odGFyZ2V0U2l6ZSwgdGhpcy5fZm9ybWF0U2l6ZSkgfHwgTWF0aC5tYXgoMTAyNCwgbmVhcmVzdFBPVCh0YXJnZXRTaXplKSk7XHJcbiAgICAgICAgY29uc3QgbmV3Q2h1bmsgPSB0aGlzLl9jaHVua3NbdGhpcy5jcmVhdGVDaHVuayh0ZXhMZW5ndGgpXTtcclxuXHJcbiAgICAgICAgbmV3Q2h1bmsuc3RhcnQgKz0gc2l6ZTtcclxuICAgICAgICBjb25zdCB0ZXhIYW5kbGU6IElUZXh0dXJlQnVmZmVySGFuZGxlID0ge1xyXG4gICAgICAgICAgICBjaHVua0lkeDogdGhpcy5fY2h1bmtDb3VudCxcclxuICAgICAgICAgICAgc3RhcnQ6IDAsXHJcbiAgICAgICAgICAgIGVuZDogc2l6ZSxcclxuICAgICAgICAgICAgdGV4dHVyZTogbmV3Q2h1bmsudGV4dHVyZSxcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuX2hhbmRsZXMucHVzaCh0ZXhIYW5kbGUpO1xyXG4gICAgICAgIHJldHVybiB0ZXhIYW5kbGU7XHJcbiAgICB9XHJcbn1cclxuIl19