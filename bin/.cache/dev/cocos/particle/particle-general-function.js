(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../core/math/index.js", "../core/math/bits.js", "./enum.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../core/math/index.js"), require("../core/math/bits.js"), require("./enum.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.index, global.bits, global._enum);
    global.particleGeneralFunction = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _index, _bits, _enum) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.calculateTransform = calculateTransform;
  _exports.fixedAngleUnitVector2 = fixedAngleUnitVector2;
  _exports.randomUnitVector2 = randomUnitVector2;
  _exports.randomUnitVector = randomUnitVector;
  _exports.randomPointInUnitSphere = randomPointInUnitSphere;
  _exports.randomPointBetweenSphere = randomPointBetweenSphere;
  _exports.randomPointInUnitCircle = randomPointInUnitCircle;
  _exports.randomPointBetweenCircle = randomPointBetweenCircle;
  _exports.randomPointBetweenCircleAtFixedAngle = randomPointBetweenCircleAtFixedAngle;
  _exports.randomPointInCube = randomPointInCube;
  _exports.randomPointBetweenCube = randomPointBetweenCube;
  _exports.randomSortArray = randomSortArray;
  _exports.randomSign = randomSign;
  _exports.particleEmitZAxis = void 0;

  /**
   * @hidden
   */
  var particleEmitZAxis = new _index.Vec3(0, 0, -1);
  _exports.particleEmitZAxis = particleEmitZAxis;

  function calculateTransform(systemSpace, moduleSpace, worldTransform, outQuat) {
    if (moduleSpace !== systemSpace) {
      if (systemSpace === _enum.Space.World) {
        _index.Mat4.getRotation(outQuat, worldTransform);
      } else {
        _index.Mat4.invert(worldTransform, worldTransform);

        _index.Mat4.getRotation(outQuat, worldTransform);
      }

      return true;
    } else {
      _index.Quat.set(outQuat, 0, 0, 0, 1);

      return false;
    }
  }

  function fixedAngleUnitVector2(out, theta) {
    _index.Vec2.set(out, Math.cos(theta), Math.sin(theta));
  }

  function randomUnitVector2(out) {
    var a = (0, _index.randomRange)(0, 2 * Math.PI);
    var x = Math.cos(a);
    var y = Math.sin(a);

    _index.Vec2.set(out, x, y);
  }

  function randomUnitVector(out) {
    var z = (0, _index.randomRange)(-1, 1);
    var a = (0, _index.randomRange)(0, 2 * Math.PI);
    var r = Math.sqrt(1 - z * z);
    var x = r * Math.cos(a);
    var y = r * Math.sin(a);

    _index.Vec3.set(out, x, y, z);
  }

  function randomPointInUnitSphere(out) {
    randomUnitVector(out);

    _index.Vec3.multiplyScalar(out, out, (0, _index.random)());
  }

  function randomPointBetweenSphere(out, minRadius, maxRadius) {
    randomUnitVector(out);

    _index.Vec3.multiplyScalar(out, out, minRadius + (maxRadius - minRadius) * (0, _index.random)());
  }

  function randomPointInUnitCircle(out) {
    randomUnitVector2(out);
    out.z = 0;

    _index.Vec3.multiplyScalar(out, out, (0, _index.random)());
  }

  function randomPointBetweenCircle(out, minRadius, maxRadius) {
    randomUnitVector2(out);
    out.z = 0;

    _index.Vec3.multiplyScalar(out, out, minRadius + (maxRadius - minRadius) * (0, _index.random)());
  }

  function randomPointBetweenCircleAtFixedAngle(out, minRadius, maxRadius, theta) {
    fixedAngleUnitVector2(out, theta);
    out.z = 0;

    _index.Vec3.multiplyScalar(out, out, minRadius + (maxRadius - minRadius) * (0, _index.random)());
  }

  function randomPointInCube(out, extents) {
    _index.Vec3.set(out, (0, _index.randomRange)(-extents.x, extents.x), (0, _index.randomRange)(-extents.y, extents.y), (0, _index.randomRange)(-extents.z, extents.z));
  }

  function randomPointBetweenCube(out, minBox, maxBox) {
    var subscript = ['x', 'y', 'z'];
    var edge = (0, _index.randomRangeInt)(0, 3);

    for (var i = 0; i < 3; i++) {
      if (i === edge) {
        out[subscript[i]] = (0, _index.randomRange)(-maxBox[subscript[i]], maxBox[subscript[i]]);
        continue;
      }

      var x = (0, _index.random)() * 2 - 1;

      if (x < 0) {
        out[subscript[i]] = -minBox[subscript[i]] + x * (maxBox[subscript[i]] - minBox[subscript[i]]);
      } else {
        out[subscript[i]] = minBox[subscript[i]] + x * (maxBox[subscript[i]] - minBox[subscript[i]]);
      }
    }
  } // Fisherâ€“Yates shuffle


  function randomSortArray(arr) {
    for (var i = 0; i < arr.length; i++) {
      var transpose = i + (0, _index.randomRangeInt)(0, arr.length - i);
      var val = arr[transpose];
      arr[transpose] = arr[i];
      arr[i] = val;
    }
  }

  function randomSign() {
    var sgn = (0, _index.randomRange)(-1, 1);

    if (sgn === 0) {
      sgn++;
    }

    return (0, _bits.sign)(sgn);
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL3BhcnRpY2xlL3BhcnRpY2xlLWdlbmVyYWwtZnVuY3Rpb24udHMiXSwibmFtZXMiOlsicGFydGljbGVFbWl0WkF4aXMiLCJWZWMzIiwiY2FsY3VsYXRlVHJhbnNmb3JtIiwic3lzdGVtU3BhY2UiLCJtb2R1bGVTcGFjZSIsIndvcmxkVHJhbnNmb3JtIiwib3V0UXVhdCIsIlNwYWNlIiwiV29ybGQiLCJNYXQ0IiwiZ2V0Um90YXRpb24iLCJpbnZlcnQiLCJRdWF0Iiwic2V0IiwiZml4ZWRBbmdsZVVuaXRWZWN0b3IyIiwib3V0IiwidGhldGEiLCJWZWMyIiwiTWF0aCIsImNvcyIsInNpbiIsInJhbmRvbVVuaXRWZWN0b3IyIiwiYSIsIlBJIiwieCIsInkiLCJyYW5kb21Vbml0VmVjdG9yIiwieiIsInIiLCJzcXJ0IiwicmFuZG9tUG9pbnRJblVuaXRTcGhlcmUiLCJtdWx0aXBseVNjYWxhciIsInJhbmRvbVBvaW50QmV0d2VlblNwaGVyZSIsIm1pblJhZGl1cyIsIm1heFJhZGl1cyIsInJhbmRvbVBvaW50SW5Vbml0Q2lyY2xlIiwicmFuZG9tUG9pbnRCZXR3ZWVuQ2lyY2xlIiwicmFuZG9tUG9pbnRCZXR3ZWVuQ2lyY2xlQXRGaXhlZEFuZ2xlIiwicmFuZG9tUG9pbnRJbkN1YmUiLCJleHRlbnRzIiwicmFuZG9tUG9pbnRCZXR3ZWVuQ3ViZSIsIm1pbkJveCIsIm1heEJveCIsInN1YnNjcmlwdCIsImVkZ2UiLCJpIiwicmFuZG9tU29ydEFycmF5IiwiYXJyIiwibGVuZ3RoIiwidHJhbnNwb3NlIiwidmFsIiwicmFuZG9tU2lnbiIsInNnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7OztBQVFPLE1BQU1BLGlCQUFpQixHQUFHLElBQUlDLFdBQUosQ0FBUyxDQUFULEVBQVksQ0FBWixFQUFlLENBQUMsQ0FBaEIsQ0FBMUI7OztBQUVBLFdBQVNDLGtC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ZUFBVCxDQUEwQkMsR0FBMUIsRUFBc0M7QUFDekMsU0FBSyxJQUFJRixDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHRSxHQUFHLENBQUNDLE1BQXhCLEVBQWdDSCxDQUFDLEVBQWpDLEVBQXFDO0FBQ2pDLFVBQU1JLFNBQVMsR0FBR0osQ0FBQyxHQUFHLDJCQUFlLENBQWYsRUFBa0JFLEdBQUcsQ0FBQ0MsTUFBSixHQUFhSCxDQUEvQixDQUF0QjtBQUNBLFVBQU1LLEdBQUcsR0FBR0gsR0FBRyxDQUFDRSxTQUFELENBQWY7QUFDQUYsTUFBQUEsR0FBRyxDQUFDRSxTQUFELENBQUgsR0FBaUJGLEdBQUcsQ0FBQ0YsQ0FBRCxDQUFwQjtBQUNBRSxNQUFBQSxHQUFHLENBQUNGLENBQUQsQ0FBSCxHQUFTSyxHQUFUO0FBQ0g7QUFDSjs7QUFFTSxXQUFTQyxVQUFULEdBQXVCO0FBQzFCLFFBQUlDLEdBQUcsR0FBRyx3QkFBWSxDQUFDLENBQWIsRUFBZ0IsQ0FBaEIsQ0FBVjs7QUFDQSxRQUFJQSxHQUFHLEtBQUssQ0FBWixFQUFlO0FBQ1hBLE1BQUFBLEdBQUc7QUFDTjs7QUFDRCxXQUFPLGdCQUFLQSxHQUFMLENBQVA7QUFDSCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAaGlkZGVuXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgTWF0NCwgUXVhdCwgcmFuZG9tLCByYW5kb21SYW5nZSwgcmFuZG9tUmFuZ2VJbnQsIFZlYzIsIFZlYzMgfSBmcm9tICcuLi9jb3JlL21hdGgnO1xyXG5pbXBvcnQgeyBzaWduIH0gZnJvbSAnLi4vY29yZS9tYXRoL2JpdHMnO1xyXG5pbXBvcnQgeyBTcGFjZSB9IGZyb20gJy4vZW51bSc7XHJcblxyXG5leHBvcnQgY29uc3QgcGFydGljbGVFbWl0WkF4aXMgPSBuZXcgVmVjMygwLCAwLCAtMSk7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlVHJhbnNmb3JtIChzeXN0ZW1TcGFjZTogbnVtYmVyLCBtb2R1bGVTcGFjZTogbnVtYmVyLCB3b3JsZFRyYW5zZm9ybTogTWF0NCwgb3V0UXVhdDogUXVhdCkge1xyXG4gICAgaWYgKG1vZHVsZVNwYWNlICE9PSBzeXN0ZW1TcGFjZSkge1xyXG4gICAgICAgIGlmIChzeXN0ZW1TcGFjZSA9PT0gU3BhY2UuV29ybGQpIHtcclxuICAgICAgICAgICAgTWF0NC5nZXRSb3RhdGlvbihvdXRRdWF0LCB3b3JsZFRyYW5zZm9ybSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBNYXQ0LmludmVydCh3b3JsZFRyYW5zZm9ybSwgd29ybGRUcmFuc2Zvcm0pO1xyXG4gICAgICAgICAgICBNYXQ0LmdldFJvdGF0aW9uKG91dFF1YXQsIHdvcmxkVHJhbnNmb3JtKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgICBRdWF0LnNldChvdXRRdWF0LCAwLCAwLCAwLCAxKTtcclxuICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaXhlZEFuZ2xlVW5pdFZlY3RvcjIgKG91dDogVmVjMiB8IFZlYzMsIHRoZXRhOiBudW1iZXIpIHtcclxuICAgIFZlYzIuc2V0KG91dCwgTWF0aC5jb3ModGhldGEpLCBNYXRoLnNpbih0aGV0YSkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmFuZG9tVW5pdFZlY3RvcjIgKG91dDogVmVjMiB8IFZlYzMpIHtcclxuICAgIGNvbnN0IGEgPSByYW5kb21SYW5nZSgwLCAyICogTWF0aC5QSSk7XHJcbiAgICBjb25zdCB4ID0gTWF0aC5jb3MoYSk7XHJcbiAgICBjb25zdCB5ID0gTWF0aC5zaW4oYSk7XHJcbiAgICBWZWMyLnNldChvdXQsIHgsIHkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmFuZG9tVW5pdFZlY3RvciAob3V0OiBWZWMzKSB7XHJcbiAgICBjb25zdCB6ID0gcmFuZG9tUmFuZ2UoLTEsIDEpO1xyXG4gICAgY29uc3QgYSA9IHJhbmRvbVJhbmdlKDAsIDIgKiBNYXRoLlBJKTtcclxuICAgIGNvbnN0IHIgPSBNYXRoLnNxcnQoMSAtIHogKiB6KTtcclxuICAgIGNvbnN0IHggPSByICogTWF0aC5jb3MoYSk7XHJcbiAgICBjb25zdCB5ID0gciAqIE1hdGguc2luKGEpO1xyXG4gICAgVmVjMy5zZXQob3V0LCB4LCB5LCB6KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbVBvaW50SW5Vbml0U3BoZXJlIChvdXQ6IFZlYzMpIHtcclxuICAgIHJhbmRvbVVuaXRWZWN0b3Iob3V0KTtcclxuICAgIFZlYzMubXVsdGlwbHlTY2FsYXIob3V0LCBvdXQsIHJhbmRvbSgpKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbVBvaW50QmV0d2VlblNwaGVyZSAob3V0OiBWZWMzLCBtaW5SYWRpdXM6IG51bWJlciwgbWF4UmFkaXVzOiBudW1iZXIpIHtcclxuICAgIHJhbmRvbVVuaXRWZWN0b3Iob3V0KTtcclxuICAgIFZlYzMubXVsdGlwbHlTY2FsYXIob3V0LCBvdXQsIG1pblJhZGl1cyArIChtYXhSYWRpdXMgLSBtaW5SYWRpdXMpICogcmFuZG9tKCkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmFuZG9tUG9pbnRJblVuaXRDaXJjbGUgKG91dDogVmVjMykge1xyXG4gICAgcmFuZG9tVW5pdFZlY3RvcjIob3V0KTtcclxuICAgIG91dC56ID0gMDtcclxuICAgIFZlYzMubXVsdGlwbHlTY2FsYXIob3V0LCBvdXQsIHJhbmRvbSgpKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbVBvaW50QmV0d2VlbkNpcmNsZSAob3V0OiBWZWMzLCBtaW5SYWRpdXM6IG51bWJlciwgbWF4UmFkaXVzOiBudW1iZXIpIHtcclxuICAgIHJhbmRvbVVuaXRWZWN0b3IyKG91dCk7XHJcbiAgICBvdXQueiA9IDA7XHJcbiAgICBWZWMzLm11bHRpcGx5U2NhbGFyKG91dCwgb3V0LCBtaW5SYWRpdXMgKyAobWF4UmFkaXVzIC0gbWluUmFkaXVzKSAqIHJhbmRvbSgpKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbVBvaW50QmV0d2VlbkNpcmNsZUF0Rml4ZWRBbmdsZSAob3V0OiBWZWMzLCBtaW5SYWRpdXM6IG51bWJlciwgbWF4UmFkaXVzOiBudW1iZXIsIHRoZXRhOiBudW1iZXIpIHtcclxuICAgIGZpeGVkQW5nbGVVbml0VmVjdG9yMihvdXQsIHRoZXRhKTtcclxuICAgIG91dC56ID0gMDtcclxuICAgIFZlYzMubXVsdGlwbHlTY2FsYXIob3V0LCBvdXQsIG1pblJhZGl1cyArIChtYXhSYWRpdXMgLSBtaW5SYWRpdXMpICogcmFuZG9tKCkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmFuZG9tUG9pbnRJbkN1YmUgKG91dDogVmVjMywgZXh0ZW50czogVmVjMykge1xyXG4gICAgVmVjMy5zZXQob3V0LFxyXG4gICAgICAgIHJhbmRvbVJhbmdlKC1leHRlbnRzLngsIGV4dGVudHMueCksXHJcbiAgICAgICAgcmFuZG9tUmFuZ2UoLWV4dGVudHMueSwgZXh0ZW50cy55KSxcclxuICAgICAgICByYW5kb21SYW5nZSgtZXh0ZW50cy56LCBleHRlbnRzLnopKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbVBvaW50QmV0d2VlbkN1YmUgKG91dDogVmVjMywgbWluQm94OiBWZWMzLCBtYXhCb3g6IFZlYzMpIHtcclxuICAgIGNvbnN0IHN1YnNjcmlwdCA9IFsneCcsICd5JywgJ3onXTtcclxuICAgIGNvbnN0IGVkZ2UgPSByYW5kb21SYW5nZUludCgwLCAzKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMzsgaSsrKSB7XHJcbiAgICAgICAgaWYgKGkgPT09IGVkZ2UpIHtcclxuICAgICAgICAgICAgb3V0W3N1YnNjcmlwdFtpXV0gPSByYW5kb21SYW5nZSgtbWF4Qm94W3N1YnNjcmlwdFtpXV0sIG1heEJveFtzdWJzY3JpcHRbaV1dKTtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHggPSByYW5kb20oKSAqIDIgLSAxO1xyXG4gICAgICAgIGlmICh4IDwgMCkge1xyXG4gICAgICAgICAgICBvdXRbc3Vic2NyaXB0W2ldXSA9IC1taW5Cb3hbc3Vic2NyaXB0W2ldXSArIHggKiAobWF4Qm94W3N1YnNjcmlwdFtpXV0gLSBtaW5Cb3hbc3Vic2NyaXB0W2ldXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2Uge1xyXG4gICAgICAgICAgICBvdXRbc3Vic2NyaXB0W2ldXSA9IG1pbkJveFtzdWJzY3JpcHRbaV1dICsgeCAqIChtYXhCb3hbc3Vic2NyaXB0W2ldXSAtIG1pbkJveFtzdWJzY3JpcHRbaV1dKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbi8vIEZpc2hlcuKAk1lhdGVzIHNodWZmbGVcclxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbVNvcnRBcnJheSAoYXJyOiBhbnlbXSkge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnIubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBjb25zdCB0cmFuc3Bvc2UgPSBpICsgcmFuZG9tUmFuZ2VJbnQoMCwgYXJyLmxlbmd0aCAtIGkpO1xyXG4gICAgICAgIGNvbnN0IHZhbCA9IGFyclt0cmFuc3Bvc2VdO1xyXG4gICAgICAgIGFyclt0cmFuc3Bvc2VdID0gYXJyW2ldO1xyXG4gICAgICAgIGFycltpXSA9IHZhbDtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHJhbmRvbVNpZ24gKCkge1xyXG4gICAgbGV0IHNnbiA9IHJhbmRvbVJhbmdlKC0xLCAxKTtcclxuICAgIGlmIChzZ24gPT09IDApIHtcclxuICAgICAgICBzZ24rKztcclxuICAgIH1cclxuICAgIHJldHVybiBzaWduKHNnbik7XHJcbn1cclxuIl19