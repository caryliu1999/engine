(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../../core/math/index.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../../core/math/index.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.index);
    global.utils = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _index) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.fillVertices3D = fillVertices3D;
  _exports.fillMeshVertices3D = fillMeshVertices3D;
  _exports.fillVerticesWithoutCalc3D = fillVerticesWithoutCalc3D;

  /**
   * @hidden
   */
  var vec3_temp = new _index.Vec3();

  var _worldMatrix = new _index.Mat4();

  function fillVertices3D(node, renderer, renderData, color) {
    var dataList = renderData.data;
    var buffer = renderer.currBufferBatch;
    var vertexOffset = buffer.byteOffset >> 2;
    var vertexCount = renderData.vertexCount;
    var indicesOffset = buffer.indicesOffset;
    var vertexId = buffer.vertexOffset;
    var isRecreate = buffer.request(vertexCount, renderData.indicesCount);

    if (!isRecreate) {
      buffer = renderer.currBufferBatch;
      vertexCount = 0;
      indicesOffset = 0;
      vertexId = 0;
    } // buffer data may be realloc, need get reference after request.


    var vBuf = buffer.vData;
    node.getWorldMatrix(_worldMatrix);

    for (var i = 0; i < vertexCount; i++) {
      var vert = dataList[i];

      _index.Vec3.set(vec3_temp, vert.x, vert.y, 0);

      _index.Vec3.transformMat4(vec3_temp, vec3_temp, _worldMatrix);

      vBuf[vertexOffset++] = vec3_temp.x;
      vBuf[vertexOffset++] = vec3_temp.y;
      vBuf[vertexOffset++] = vec3_temp.z;
      vBuf[vertexOffset++] = vert.u;
      vBuf[vertexOffset++] = vert.v;

      _index.Color.toArray(vBuf, color, vertexOffset);

      vertexOffset += 4;
    } // buffer data may be realloc, need get reference after request.


    var iBuf = buffer.iData;

    for (var _i = 0; _i < renderData.dataLength; _i++) {
      iBuf[indicesOffset + _i] = vertexId + _i;
    }
  }

  function fillMeshVertices3D(node, renderer, renderData, color) {
    var dataList = renderData.data;
    var buffer = renderer.currBufferBatch;
    var vertexOffset = buffer.byteOffset >> 2;
    var vertexCount = renderData.vertexCount;
    var indicesOffset = buffer.indicesOffset;
    var vertexId = buffer.vertexOffset;
    var isRecreate = buffer.request(vertexCount, renderData.indicesCount);

    if (!isRecreate) {
      buffer = renderer.currBufferBatch;
      vertexCount = 0;
      indicesOffset = 0;
      vertexId = 0;
    } // buffer data may be realloc, need get reference after request.


    var vBuf = buffer.vData;
    var iBuf = buffer.iData;
    node.getWorldMatrix(_worldMatrix);

    for (var i = 0; i < vertexCount; i++) {
      var vert = dataList[i];

      _index.Vec3.set(vec3_temp, vert.x, vert.y, 0);

      _index.Vec3.transformMat4(vec3_temp, vec3_temp, _worldMatrix);

      vBuf[vertexOffset++] = vec3_temp.x;
      vBuf[vertexOffset++] = vec3_temp.y;
      vBuf[vertexOffset++] = vec3_temp.z;
      vBuf[vertexOffset++] = vert.u;
      vBuf[vertexOffset++] = vert.v;

      _index.Color.toArray(vBuf, color, vertexOffset);

      vertexOffset += 4;
    } // fill index data


    for (var _i2 = 0, count = vertexCount / 4; _i2 < count; _i2++) {
      var start = vertexId + _i2 * 4;
      iBuf[indicesOffset++] = start;
      iBuf[indicesOffset++] = start + 1;
      iBuf[indicesOffset++] = start + 2;
      iBuf[indicesOffset++] = start + 1;
      iBuf[indicesOffset++] = start + 3;
      iBuf[indicesOffset++] = start + 2;
    }
  }

  function fillVerticesWithoutCalc3D(node, renderer, renderData, color) {
    var dataList = renderData.data;
    var buffer = renderer.currBufferBatch;
    var vertexOffset = buffer.byteOffset >> 2; // buffer

    var vertexCount = renderData.vertexCount;
    var indicesOffset = buffer.indicesOffset;
    var vertexId = buffer.vertexOffset;
    var isRecreate = buffer.request(vertexCount, renderData.indicesCount);

    if (!isRecreate) {
      buffer = renderer.currBufferBatch;
      vertexCount = 0;
      indicesOffset = 0;
      vertexId = 0;
    } // buffer data may be realloc, need get reference after request.


    var vBuf = buffer.vData;

    for (var i = 0; i < vertexCount; i++) {
      var vert = dataList[i];
      vBuf[vertexOffset++] = vert.x;
      vBuf[vertexOffset++] = vert.y;
      vBuf[vertexOffset++] = vert.z;
      vBuf[vertexOffset++] = vert.u;
      vBuf[vertexOffset++] = vert.v;

      _index.Color.toArray(vBuf, color, vertexOffset);

      vertexOffset += 4;
    } // buffer data may be realloc, need get reference after request.


    var iBuf = buffer.iData;
    iBuf[indicesOffset++] = vertexId;
    iBuf[indicesOffset++] = vertexId + 1;
    iBuf[indicesOffset++] = vertexId + 2;
    iBuf[indicesOffset++] = vertexId + 1;
    iBuf[indicesOffset++] = vertexId + 3;
    iBuf[indicesOffset++] = vertexId + 2;
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL3VpL2Fzc2VtYmxlci91dGlscy50cyJdLCJuYW1lcyI6WyJ2ZWMzX3RlbXAiLCJWZWMzIiwiX3dvcmxkTWF0cml4IiwiTWF0NCIsImZpbGxWZXJ0aWNlczNEIiwibm9kZSIsInJlbmRlcmVyIiwicmVuZGVyRGF0YSIsImNvbG9yIiwiZGF0YUxpc3QiLCJkYXRhIiwiYnVmZmVyIiwiY3VyckJ1ZmZlckJhdGNoIiwidmVydGV4T2Zmc2V0IiwiYnl0ZU9mZnNldCIsInZlcnRleENvdW50IiwiaW5kaWNlc09mZnNldCIsInZlcnRleElkIiwiaXNSZWNyZWF0ZSIsInJlcXVlc3QiLCJpbmRpY2VzQ291bnQiLCJ2QnVmIiwidkRhdGEiLCJnZXRXb3JsZE1hdHJpeCIsImkiLCJ2ZXJ0Iiwic2V0IiwieCIsInkiLCJ0cmFuc2Zvcm1NYXQ0IiwieiIsInUiLCJ2IiwiQ29sb3IiLCJ0b0FycmF5IiwiaUJ1ZiIsImlEYXRhIiwiZGF0YUxlbmd0aCIsImZpbGxNZXNoVmVydGljZXMzRCIsImNvdW50Iiwic3RhcnQiLCJmaWxsVmVydGljZXNXaXRob3V0Q2FsYzNEIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7OztBQVNBLE1BQU1BLFNBQVMsR0FBRyxJQUFJQyxXQUFKLEVBQWxCOztBQUNBLE1BQU1DLFlBQVksR0FBRyxJQUFJQyxXQUFKLEVBQXJCOztBQUVPLFdBQVNDLGNBQVQsQ0FBeUJDLElBQXpCLEVBQXFDQyxRQUFyQyxFQUFtREMsVUFBbkQsRUFBMkVDLEtBQTNFLEVBQXlGO0FBQzVGLFFBQU1DLFFBQVEsR0FBR0YsVUFBVSxDQUFDRyxJQUE1QjtBQUNBLFFBQUlDLE1BQU0sR0FBR0wsUUFBUSxDQUFDTSxlQUF0QjtBQUNBLFFBQUlDLFlBQVksR0FBR0YsTUFBTSxDQUFDRyxVQUFQLElBQXFCLENBQXhDO0FBRUEsUUFBSUMsV0FBVyxHQUFHUixVQUFVLENBQUNRLFdBQTdCO0FBQ0EsUUFBSUMsYUFBYSxHQUFHTCxNQUFNLENBQUVLLGFBQTVCO0FBQ0EsUUFBSUMsUUFBUSxHQUFHTixNQUFNLENBQUNFLFlBQXRCO0FBQ0EsUUFBTUssVUFBVSxHQUFHUCxNQUFNLENBQUNRLE9BQVAsQ0FBZUosV0FBZixFQUE0QlIsVUFBVSxDQUFDYSxZQUF2QyxDQUFuQjs7QUFDQSxRQUFJLENBQUNGLFVBQUwsRUFBaUI7QUFDYlAsTUFBQUEsTUFBTSxHQUFHTCxRQUFRLENBQUNNLGVBQWxCO0FBQ0FHLE1BQUFBLFdBQVcsR0FBRyxDQUFkO0FBQ0FDLE1BQUFBLGFBQWEsR0FBRyxDQUFoQjtBQUNBQyxNQUFBQSxRQUFRLEdBQUcsQ0FBWDtBQUNILEtBZDJGLENBZ0I1Rjs7O0FBQ0EsUUFBTUksSUFBSSxHQUFHVixNQUFNLENBQUNXLEtBQXBCO0FBRUFqQixJQUFBQSxJQUFJLENBQUNrQixjQUFMLENBQW9CckIsWUFBcEI7O0FBRUEsU0FBSyxJQUFJc0IsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR1QsV0FBcEIsRUFBaUNTLENBQUMsRUFBbEMsRUFBc0M7QUFDbEMsVUFBTUMsSUFBSSxHQUFHaEIsUUFBUSxDQUFDZSxDQUFELENBQXJCOztBQUNBdkIsa0JBQUt5QixHQUFMLENBQVMxQixTQUFULEVBQW9CeUIsSUFBSSxDQUFDRSxDQUF6QixFQUE0QkYsSUFBSSxDQUFDRyxDQUFqQyxFQUFvQyxDQUFwQzs7QUFDQTNCLGtCQUFLNEIsYUFBTCxDQUFtQjdCLFNBQW5CLEVBQThCQSxTQUE5QixFQUF5Q0UsWUFBekM7O0FBQ0FtQixNQUFBQSxJQUFJLENBQUNSLFlBQVksRUFBYixDQUFKLEdBQXVCYixTQUFTLENBQUMyQixDQUFqQztBQUNBTixNQUFBQSxJQUFJLENBQUNSLFlBQVksRUFBYixDQUFKLEdBQXVCYixTQUFTLENBQUM0QixDQUFqQztBQUNBUCxNQUFBQSxJQUFJLENBQUNSLFlBQVksRUFBYixDQUFKLEdBQXVCYixTQUFTLENBQUM4QixDQUFqQztBQUNBVCxNQUFBQSxJQUFJLENBQUNSLFlBQVksRUFBYixDQUFKLEdBQXVCWSxJQUFJLENBQUNNLENBQTVCO0FBQ0FWLE1BQUFBLElBQUksQ0FBQ1IsWUFBWSxFQUFiLENBQUosR0FBdUJZLElBQUksQ0FBQ08sQ0FBNUI7O0FBQ0FDLG1CQUFNQyxPQUFOLENBQWNiLElBQWQsRUFBcUJiLEtBQXJCLEVBQTRCSyxZQUE1Qjs7QUFDQUEsTUFBQUEsWUFBWSxJQUFJLENBQWhCO0FBQ0gsS0FoQzJGLENBa0M1Rjs7O0FBQ0EsUUFBTXNCLElBQUksR0FBR3hCLE1BQU0sQ0FBQ3lCLEtBQXBCOztBQUNBLFNBQUssSUFBSVosRUFBQyxHQUFHLENBQWIsRUFBZ0JBLEVBQUMsR0FBR2pCLFVBQVUsQ0FBRThCLFVBQWhDLEVBQTRDYixFQUFDLEVBQTdDLEVBQWlEO0FBQzdDVyxNQUFBQSxJQUFJLENBQUVuQixhQUFhLEdBQUdRLEVBQWxCLENBQUosR0FBMkJQLFFBQVEsR0FBR08sRUFBdEM7QUFDSDtBQUNKOztBQUVNLFdBQVNjLGtCQUFULENBQTZCakMsSUFBN0IsRUFBeUNDLFFBQXpDLEVBQXVEQyxVQUF2RCxFQUErRUMsS0FBL0UsRUFBNkY7QUFDaEcsUUFBTUMsUUFBUSxHQUFHRixVQUFVLENBQUNHLElBQTVCO0FBQ0EsUUFBSUMsTUFBTSxHQUFHTCxRQUFRLENBQUNNLGVBQXRCO0FBQ0EsUUFBSUMsWUFBWSxHQUFHRixNQUFNLENBQUNHLFVBQVAsSUFBcUIsQ0FBeEM7QUFFQSxRQUFJQyxXQUFXLEdBQUdSLFVBQVUsQ0FBQ1EsV0FBN0I7QUFDQSxRQUFJQyxhQUFhLEdBQUdMLE1BQU0sQ0FBQ0ssYUFBM0I7QUFDQSxRQUFJQyxRQUFRLEdBQUdOLE1BQU0sQ0FBQ0UsWUFBdEI7QUFFQSxRQUFNSyxVQUFVLEdBQUdQLE1BQU0sQ0FBQ1EsT0FBUCxDQUFlSixXQUFmLEVBQTRCUixVQUFVLENBQUNhLFlBQXZDLENBQW5COztBQUNBLFFBQUksQ0FBQ0YsVUFBTCxFQUFpQjtBQUNiUCxNQUFBQSxNQUFNLEdBQUdMLFFBQVEsQ0FBQ00sZUFBbEI7QUFDQUcsTUFBQUEsV0FBVyxHQUFHLENBQWQ7QUFDQUMsTUFBQUEsYUFBYSxHQUFHLENBQWhCO0FBQ0FDLE1BQUFBLFFBQVEsR0FBRyxDQUFYO0FBQ0gsS0FmK0YsQ0FpQmhHOzs7QUFDQSxRQUFNSSxJQUFJLEdBQUdWLE1BQU0sQ0FBQ1csS0FBcEI7QUFDQSxRQUFNYSxJQUFJLEdBQUd4QixNQUFNLENBQUN5QixLQUFwQjtBQUVBL0IsSUFBQUEsSUFBSSxDQUFDa0IsY0FBTCxDQUFvQnJCLFlBQXBCOztBQUVBLFNBQUssSUFBSXNCLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdULFdBQXBCLEVBQWlDUyxDQUFDLEVBQWxDLEVBQXNDO0FBQ2xDLFVBQU1DLElBQUksR0FBR2hCLFFBQVEsQ0FBQ2UsQ0FBRCxDQUFyQjs7QUFDQXZCLGtCQUFLeUIsR0FBTCxDQUFTMUIsU0FBVCxFQUFvQnlCLElBQUksQ0FBQ0UsQ0FBekIsRUFBNEJGLElBQUksQ0FBQ0csQ0FBakMsRUFBb0MsQ0FBcEM7O0FBQ0EzQixrQkFBSzRCLGFBQUwsQ0FBbUI3QixTQUFuQixFQUE4QkEsU0FBOUIsRUFBeUNFLFlBQXpDOztBQUNBbUIsTUFBQUEsSUFBSSxDQUFDUixZQUFZLEVBQWIsQ0FBSixHQUF1QmIsU0FBUyxDQUFDMkIsQ0FBakM7QUFDQU4sTUFBQUEsSUFBSSxDQUFDUixZQUFZLEVBQWIsQ0FBSixHQUF1QmIsU0FBUyxDQUFDNEIsQ0FBakM7QUFDQVAsTUFBQUEsSUFBSSxDQUFDUixZQUFZLEVBQWIsQ0FBSixHQUF1QmIsU0FBUyxDQUFDOEIsQ0FBakM7QUFDQVQsTUFBQUEsSUFBSSxDQUFDUixZQUFZLEVBQWIsQ0FBSixHQUF1QlksSUFBSSxDQUFDTSxDQUE1QjtBQUNBVixNQUFBQSxJQUFJLENBQUNSLFlBQVksRUFBYixDQUFKLEdBQXVCWSxJQUFJLENBQUNPLENBQTVCOztBQUNBQyxtQkFBTUMsT0FBTixDQUFjYixJQUFkLEVBQXFCYixLQUFyQixFQUE0QkssWUFBNUI7O0FBQ0FBLE1BQUFBLFlBQVksSUFBSSxDQUFoQjtBQUNILEtBbEMrRixDQW9DaEc7OztBQUNBLFNBQUssSUFBSVcsR0FBQyxHQUFHLENBQVIsRUFBV2UsS0FBSyxHQUFHeEIsV0FBVyxHQUFHLENBQXRDLEVBQXlDUyxHQUFDLEdBQUdlLEtBQTdDLEVBQW9EZixHQUFDLEVBQXJELEVBQXlEO0FBQ3JELFVBQU1nQixLQUFLLEdBQUd2QixRQUFRLEdBQUdPLEdBQUMsR0FBRyxDQUE3QjtBQUNBVyxNQUFBQSxJQUFJLENBQUNuQixhQUFhLEVBQWQsQ0FBSixHQUF3QndCLEtBQXhCO0FBQ0FMLE1BQUFBLElBQUksQ0FBQ25CLGFBQWEsRUFBZCxDQUFKLEdBQXdCd0IsS0FBSyxHQUFHLENBQWhDO0FBQ0FMLE1BQUFBLElBQUksQ0FBQ25CLGFBQWEsRUFBZCxDQUFKLEdBQXdCd0IsS0FBSyxHQUFHLENBQWhDO0FBQ0FMLE1BQUFBLElBQUksQ0FBQ25CLGFBQWEsRUFBZCxDQUFKLEdBQXdCd0IsS0FBSyxHQUFHLENBQWhDO0FBQ0FMLE1BQUFBLElBQUksQ0FBQ25CLGFBQWEsRUFBZCxDQUFKLEdBQXdCd0IsS0FBSyxHQUFHLENBQWhDO0FBQ0FMLE1BQUFBLElBQUksQ0FBQ25CLGFBQWEsRUFBZCxDQUFKLEdBQXdCd0IsS0FBSyxHQUFHLENBQWhDO0FBQ0g7QUFDSjs7QUFFTSxXQUFTQyx5QkFBVCxDQUFvQ3BDLElBQXBDLEVBQWdEQyxRQUFoRCxFQUE4REMsVUFBOUQsRUFBc0ZDLEtBQXRGLEVBQW9HO0FBQ3ZHLFFBQU1DLFFBQVEsR0FBR0YsVUFBVSxDQUFDRyxJQUE1QjtBQUNBLFFBQUlDLE1BQU0sR0FBR0wsUUFBUSxDQUFDTSxlQUF0QjtBQUNBLFFBQUlDLFlBQVksR0FBR0YsTUFBTSxDQUFDRyxVQUFQLElBQXFCLENBQXhDLENBSHVHLENBS3ZHOztBQUNBLFFBQUlDLFdBQVcsR0FBR1IsVUFBVSxDQUFDUSxXQUE3QjtBQUNBLFFBQUlDLGFBQXFCLEdBQUdMLE1BQU0sQ0FBQ0ssYUFBbkM7QUFDQSxRQUFJQyxRQUFnQixHQUFHTixNQUFNLENBQUNFLFlBQTlCO0FBQ0EsUUFBTUssVUFBVSxHQUFHUCxNQUFNLENBQUNRLE9BQVAsQ0FBZUosV0FBZixFQUE0QlIsVUFBVSxDQUFDYSxZQUF2QyxDQUFuQjs7QUFDQSxRQUFJLENBQUNGLFVBQUwsRUFBaUI7QUFDYlAsTUFBQUEsTUFBTSxHQUFHTCxRQUFRLENBQUNNLGVBQWxCO0FBQ0FHLE1BQUFBLFdBQVcsR0FBRyxDQUFkO0FBQ0FDLE1BQUFBLGFBQWEsR0FBRyxDQUFoQjtBQUNBQyxNQUFBQSxRQUFRLEdBQUcsQ0FBWDtBQUNILEtBZnNHLENBaUJ2Rzs7O0FBQ0EsUUFBTUksSUFBSSxHQUFHVixNQUFNLENBQUNXLEtBQXBCOztBQUVBLFNBQUssSUFBSUUsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR1QsV0FBcEIsRUFBaUNTLENBQUMsRUFBbEMsRUFBc0M7QUFDbEMsVUFBTUMsSUFBSSxHQUFHaEIsUUFBUSxDQUFDZSxDQUFELENBQXJCO0FBQ0FILE1BQUFBLElBQUksQ0FBQ1IsWUFBWSxFQUFiLENBQUosR0FBdUJZLElBQUksQ0FBQ0UsQ0FBNUI7QUFDQU4sTUFBQUEsSUFBSSxDQUFDUixZQUFZLEVBQWIsQ0FBSixHQUF1QlksSUFBSSxDQUFDRyxDQUE1QjtBQUNBUCxNQUFBQSxJQUFJLENBQUNSLFlBQVksRUFBYixDQUFKLEdBQXVCWSxJQUFJLENBQUNLLENBQTVCO0FBQ0FULE1BQUFBLElBQUksQ0FBQ1IsWUFBWSxFQUFiLENBQUosR0FBdUJZLElBQUksQ0FBQ00sQ0FBNUI7QUFDQVYsTUFBQUEsSUFBSSxDQUFDUixZQUFZLEVBQWIsQ0FBSixHQUF1QlksSUFBSSxDQUFDTyxDQUE1Qjs7QUFDQUMsbUJBQU1DLE9BQU4sQ0FBY2IsSUFBZCxFQUFxQmIsS0FBckIsRUFBNEJLLFlBQTVCOztBQUNBQSxNQUFBQSxZQUFZLElBQUksQ0FBaEI7QUFDSCxLQTdCc0csQ0ErQnZHOzs7QUFDQSxRQUFNc0IsSUFBSSxHQUFHeEIsTUFBTSxDQUFDeUIsS0FBcEI7QUFDQUQsSUFBQUEsSUFBSSxDQUFFbkIsYUFBYSxFQUFmLENBQUosR0FBeUJDLFFBQXpCO0FBQ0FrQixJQUFBQSxJQUFJLENBQUVuQixhQUFhLEVBQWYsQ0FBSixHQUF5QkMsUUFBUSxHQUFHLENBQXBDO0FBQ0FrQixJQUFBQSxJQUFJLENBQUVuQixhQUFhLEVBQWYsQ0FBSixHQUF5QkMsUUFBUSxHQUFHLENBQXBDO0FBQ0FrQixJQUFBQSxJQUFJLENBQUVuQixhQUFhLEVBQWYsQ0FBSixHQUF5QkMsUUFBUSxHQUFHLENBQXBDO0FBQ0FrQixJQUFBQSxJQUFJLENBQUVuQixhQUFhLEVBQWYsQ0FBSixHQUF5QkMsUUFBUSxHQUFHLENBQXBDO0FBQ0FrQixJQUFBQSxJQUFJLENBQUVuQixhQUFhLEVBQWYsQ0FBSixHQUF5QkMsUUFBUSxHQUFHLENBQXBDO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogQGhpZGRlblxyXG4gKi9cclxuXHJcbmltcG9ydCB7IENvbG9yLCBNYXQ0LCBWZWMzIH0gZnJvbSAnLi4vLi4vY29yZS9tYXRoJztcclxuaW1wb3J0IHsgUmVuZGVyRGF0YSB9IGZyb20gJy4uLy4uL2NvcmUvcmVuZGVyZXIvdWkvcmVuZGVyLWRhdGEnO1xyXG5pbXBvcnQgeyBVSSB9IGZyb20gJy4uLy4uL2NvcmUvcmVuZGVyZXIvdWkvdWknO1xyXG5pbXBvcnQgeyBOb2RlIH0gZnJvbSAnLi4vLi4vY29yZSc7XHJcblxyXG5jb25zdCB2ZWMzX3RlbXAgPSBuZXcgVmVjMygpO1xyXG5jb25zdCBfd29ybGRNYXRyaXggPSBuZXcgTWF0NCgpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbGxWZXJ0aWNlczNEIChub2RlOiBOb2RlLCByZW5kZXJlcjogVUksIHJlbmRlckRhdGE6IFJlbmRlckRhdGEsIGNvbG9yOiBDb2xvcikge1xyXG4gICAgY29uc3QgZGF0YUxpc3QgPSByZW5kZXJEYXRhLmRhdGE7XHJcbiAgICBsZXQgYnVmZmVyID0gcmVuZGVyZXIuY3VyckJ1ZmZlckJhdGNoITtcclxuICAgIGxldCB2ZXJ0ZXhPZmZzZXQgPSBidWZmZXIuYnl0ZU9mZnNldCA+PiAyO1xyXG5cclxuICAgIGxldCB2ZXJ0ZXhDb3VudCA9IHJlbmRlckRhdGEudmVydGV4Q291bnQ7XHJcbiAgICBsZXQgaW5kaWNlc09mZnNldCA9IGJ1ZmZlciEuaW5kaWNlc09mZnNldDtcclxuICAgIGxldCB2ZXJ0ZXhJZCA9IGJ1ZmZlci52ZXJ0ZXhPZmZzZXQ7XHJcbiAgICBjb25zdCBpc1JlY3JlYXRlID0gYnVmZmVyLnJlcXVlc3QodmVydGV4Q291bnQsIHJlbmRlckRhdGEuaW5kaWNlc0NvdW50KTtcclxuICAgIGlmICghaXNSZWNyZWF0ZSkge1xyXG4gICAgICAgIGJ1ZmZlciA9IHJlbmRlcmVyLmN1cnJCdWZmZXJCYXRjaCE7XHJcbiAgICAgICAgdmVydGV4Q291bnQgPSAwO1xyXG4gICAgICAgIGluZGljZXNPZmZzZXQgPSAwO1xyXG4gICAgICAgIHZlcnRleElkID0gMDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBidWZmZXIgZGF0YSBtYXkgYmUgcmVhbGxvYywgbmVlZCBnZXQgcmVmZXJlbmNlIGFmdGVyIHJlcXVlc3QuXHJcbiAgICBjb25zdCB2QnVmID0gYnVmZmVyLnZEYXRhITtcclxuXHJcbiAgICBub2RlLmdldFdvcmxkTWF0cml4KF93b3JsZE1hdHJpeCk7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB2ZXJ0ZXhDb3VudDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3QgdmVydCA9IGRhdGFMaXN0W2ldO1xyXG4gICAgICAgIFZlYzMuc2V0KHZlYzNfdGVtcCwgdmVydC54LCB2ZXJ0LnksIDApO1xyXG4gICAgICAgIFZlYzMudHJhbnNmb3JtTWF0NCh2ZWMzX3RlbXAsIHZlYzNfdGVtcCwgX3dvcmxkTWF0cml4KTtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlYzNfdGVtcC54O1xyXG4gICAgICAgIHZCdWZbdmVydGV4T2Zmc2V0KytdID0gdmVjM190ZW1wLnk7XHJcbiAgICAgICAgdkJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZWMzX3RlbXAuejtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlcnQudTtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlcnQudjtcclxuICAgICAgICBDb2xvci50b0FycmF5KHZCdWYhLCBjb2xvciwgdmVydGV4T2Zmc2V0KTtcclxuICAgICAgICB2ZXJ0ZXhPZmZzZXQgKz0gNDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBidWZmZXIgZGF0YSBtYXkgYmUgcmVhbGxvYywgbmVlZCBnZXQgcmVmZXJlbmNlIGFmdGVyIHJlcXVlc3QuXHJcbiAgICBjb25zdCBpQnVmID0gYnVmZmVyLmlEYXRhO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZW5kZXJEYXRhIS5kYXRhTGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpQnVmIVtpbmRpY2VzT2Zmc2V0ICsgaV0gPSB2ZXJ0ZXhJZCArIGk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaWxsTWVzaFZlcnRpY2VzM0QgKG5vZGU6IE5vZGUsIHJlbmRlcmVyOiBVSSwgcmVuZGVyRGF0YTogUmVuZGVyRGF0YSwgY29sb3I6IENvbG9yKSB7XHJcbiAgICBjb25zdCBkYXRhTGlzdCA9IHJlbmRlckRhdGEuZGF0YTtcclxuICAgIGxldCBidWZmZXIgPSByZW5kZXJlci5jdXJyQnVmZmVyQmF0Y2ghO1xyXG4gICAgbGV0IHZlcnRleE9mZnNldCA9IGJ1ZmZlci5ieXRlT2Zmc2V0ID4+IDI7XHJcblxyXG4gICAgbGV0IHZlcnRleENvdW50ID0gcmVuZGVyRGF0YS52ZXJ0ZXhDb3VudDtcclxuICAgIGxldCBpbmRpY2VzT2Zmc2V0ID0gYnVmZmVyLmluZGljZXNPZmZzZXQ7XHJcbiAgICBsZXQgdmVydGV4SWQgPSBidWZmZXIudmVydGV4T2Zmc2V0O1xyXG5cclxuICAgIGNvbnN0IGlzUmVjcmVhdGUgPSBidWZmZXIucmVxdWVzdCh2ZXJ0ZXhDb3VudCwgcmVuZGVyRGF0YS5pbmRpY2VzQ291bnQpO1xyXG4gICAgaWYgKCFpc1JlY3JlYXRlKSB7XHJcbiAgICAgICAgYnVmZmVyID0gcmVuZGVyZXIuY3VyckJ1ZmZlckJhdGNoITtcclxuICAgICAgICB2ZXJ0ZXhDb3VudCA9IDA7XHJcbiAgICAgICAgaW5kaWNlc09mZnNldCA9IDA7XHJcbiAgICAgICAgdmVydGV4SWQgPSAwO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGJ1ZmZlciBkYXRhIG1heSBiZSByZWFsbG9jLCBuZWVkIGdldCByZWZlcmVuY2UgYWZ0ZXIgcmVxdWVzdC5cclxuICAgIGNvbnN0IHZCdWYgPSBidWZmZXIudkRhdGEhO1xyXG4gICAgY29uc3QgaUJ1ZiA9IGJ1ZmZlci5pRGF0YSE7XHJcblxyXG4gICAgbm9kZS5nZXRXb3JsZE1hdHJpeChfd29ybGRNYXRyaXgpO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGV4Q291bnQ7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IHZlcnQgPSBkYXRhTGlzdFtpXTtcclxuICAgICAgICBWZWMzLnNldCh2ZWMzX3RlbXAsIHZlcnQueCwgdmVydC55LCAwKTtcclxuICAgICAgICBWZWMzLnRyYW5zZm9ybU1hdDQodmVjM190ZW1wLCB2ZWMzX3RlbXAsIF93b3JsZE1hdHJpeCk7XHJcbiAgICAgICAgdkJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZWMzX3RlbXAueDtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlYzNfdGVtcC55O1xyXG4gICAgICAgIHZCdWZbdmVydGV4T2Zmc2V0KytdID0gdmVjM190ZW1wLno7XHJcbiAgICAgICAgdkJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0LnU7XHJcbiAgICAgICAgdkJ1Zlt2ZXJ0ZXhPZmZzZXQrK10gPSB2ZXJ0LnY7XHJcbiAgICAgICAgQ29sb3IudG9BcnJheSh2QnVmISwgY29sb3IsIHZlcnRleE9mZnNldCk7XHJcbiAgICAgICAgdmVydGV4T2Zmc2V0ICs9IDQ7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gZmlsbCBpbmRleCBkYXRhXHJcbiAgICBmb3IgKGxldCBpID0gMCwgY291bnQgPSB2ZXJ0ZXhDb3VudCAvIDQ7IGkgPCBjb3VudDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3Qgc3RhcnQgPSB2ZXJ0ZXhJZCArIGkgKiA0O1xyXG4gICAgICAgIGlCdWZbaW5kaWNlc09mZnNldCsrXSA9IHN0YXJ0O1xyXG4gICAgICAgIGlCdWZbaW5kaWNlc09mZnNldCsrXSA9IHN0YXJ0ICsgMTtcclxuICAgICAgICBpQnVmW2luZGljZXNPZmZzZXQrK10gPSBzdGFydCArIDI7XHJcbiAgICAgICAgaUJ1ZltpbmRpY2VzT2Zmc2V0KytdID0gc3RhcnQgKyAxO1xyXG4gICAgICAgIGlCdWZbaW5kaWNlc09mZnNldCsrXSA9IHN0YXJ0ICsgMztcclxuICAgICAgICBpQnVmW2luZGljZXNPZmZzZXQrK10gPSBzdGFydCArIDI7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaWxsVmVydGljZXNXaXRob3V0Q2FsYzNEIChub2RlOiBOb2RlLCByZW5kZXJlcjogVUksIHJlbmRlckRhdGE6IFJlbmRlckRhdGEsIGNvbG9yOiBDb2xvcikge1xyXG4gICAgY29uc3QgZGF0YUxpc3QgPSByZW5kZXJEYXRhLmRhdGE7XHJcbiAgICBsZXQgYnVmZmVyID0gcmVuZGVyZXIuY3VyckJ1ZmZlckJhdGNoITtcclxuICAgIGxldCB2ZXJ0ZXhPZmZzZXQgPSBidWZmZXIuYnl0ZU9mZnNldCA+PiAyO1xyXG5cclxuICAgIC8vIGJ1ZmZlclxyXG4gICAgbGV0IHZlcnRleENvdW50ID0gcmVuZGVyRGF0YS52ZXJ0ZXhDb3VudDtcclxuICAgIGxldCBpbmRpY2VzT2Zmc2V0OiBudW1iZXIgPSBidWZmZXIuaW5kaWNlc09mZnNldDtcclxuICAgIGxldCB2ZXJ0ZXhJZDogbnVtYmVyID0gYnVmZmVyLnZlcnRleE9mZnNldDtcclxuICAgIGNvbnN0IGlzUmVjcmVhdGUgPSBidWZmZXIucmVxdWVzdCh2ZXJ0ZXhDb3VudCwgcmVuZGVyRGF0YS5pbmRpY2VzQ291bnQpO1xyXG4gICAgaWYgKCFpc1JlY3JlYXRlKSB7XHJcbiAgICAgICAgYnVmZmVyID0gcmVuZGVyZXIuY3VyckJ1ZmZlckJhdGNoITtcclxuICAgICAgICB2ZXJ0ZXhDb3VudCA9IDA7XHJcbiAgICAgICAgaW5kaWNlc09mZnNldCA9IDA7XHJcbiAgICAgICAgdmVydGV4SWQgPSAwO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIGJ1ZmZlciBkYXRhIG1heSBiZSByZWFsbG9jLCBuZWVkIGdldCByZWZlcmVuY2UgYWZ0ZXIgcmVxdWVzdC5cclxuICAgIGNvbnN0IHZCdWYgPSBidWZmZXIudkRhdGEhO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmVydGV4Q291bnQ7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IHZlcnQgPSBkYXRhTGlzdFtpXTtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlcnQueDtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlcnQueTtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlcnQuejtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlcnQudTtcclxuICAgICAgICB2QnVmW3ZlcnRleE9mZnNldCsrXSA9IHZlcnQudjtcclxuICAgICAgICBDb2xvci50b0FycmF5KHZCdWYhLCBjb2xvciwgdmVydGV4T2Zmc2V0KTtcclxuICAgICAgICB2ZXJ0ZXhPZmZzZXQgKz0gNDtcclxuICAgIH1cclxuXHJcbiAgICAvLyBidWZmZXIgZGF0YSBtYXkgYmUgcmVhbGxvYywgbmVlZCBnZXQgcmVmZXJlbmNlIGFmdGVyIHJlcXVlc3QuXHJcbiAgICBjb25zdCBpQnVmID0gYnVmZmVyLmlEYXRhO1xyXG4gICAgaUJ1ZiFbaW5kaWNlc09mZnNldCsrXSA9IHZlcnRleElkO1xyXG4gICAgaUJ1ZiFbaW5kaWNlc09mZnNldCsrXSA9IHZlcnRleElkICsgMTtcclxuICAgIGlCdWYhW2luZGljZXNPZmZzZXQrK10gPSB2ZXJ0ZXhJZCArIDI7XHJcbiAgICBpQnVmIVtpbmRpY2VzT2Zmc2V0KytdID0gdmVydGV4SWQgKyAxO1xyXG4gICAgaUJ1ZiFbaW5kaWNlc09mZnNldCsrXSA9IHZlcnRleElkICsgMztcclxuICAgIGlCdWYhW2luZGljZXNPZmZzZXQrK10gPSB2ZXJ0ZXhJZCArIDI7XHJcbn1cclxuIl19