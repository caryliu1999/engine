(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../utils/js.js", "../assets/raw-asset.js", "../global-exports.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../utils/js.js"), require("../assets/raw-asset.js"), require("../global-exports.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.js, global.rawAsset, global.globalExports);
    global.autoReleaseUtils = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _js, _rawAsset, _globalExports) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.autoRelease = autoRelease;
  _exports.getDependsRecursively = getDependsRecursively;

  function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

  function parseDepends(key, parsed) {
    var item = _globalExports.legacyCC.loader.getItem(key);

    if (item) {
      var depends = item.dependKeys;

      if (depends) {
        for (var i = 0; i < depends.length; i++) {
          var depend = depends[i];

          if (!parsed[depend]) {
            parsed[depend] = true;
            parseDepends(depend, parsed);
          }
        }
      }
    }
  }

  function visitAsset(asset, excludeMap) {
    // Skip assets generated programmatically or by user (e.g. label texture)
    if (!asset._uuid) {
      return;
    }

    var key = _globalExports.legacyCC.loader._getReferenceKey(asset);

    if (!excludeMap[key]) {
      excludeMap[key] = true;
      parseDepends(key, excludeMap);
    }
  }

  function visitComponent(comp, excludeMap) {
    var props = Object.getOwnPropertyNames(comp);

    for (var i = 0; i < props.length; i++) {
      var value = comp[props[i]];

      if (_typeof(value) === 'object' && value) {
        if (Array.isArray(value)) {
          for (var j = 0; j < value.length; j++) {
            var val = value[j];

            if (val instanceof _rawAsset.RawAsset) {
              visitAsset(val, excludeMap);
            }
          }
        } else if (!value.constructor || value.constructor === Object) {
          var keys = Object.getOwnPropertyNames(value);

          for (var _j = 0; _j < keys.length; _j++) {
            var _val = value[keys[_j]];

            if (_val instanceof _rawAsset.RawAsset) {
              visitAsset(_val, excludeMap);
            }
          }
        } else if (value instanceof _rawAsset.RawAsset) {
          visitAsset(value, excludeMap);
        }
      }
    }
  }

  function visitNode(node, excludeMap) {
    for (var i = 0; i < node._components.length; i++) {
      visitComponent(node._components[i], excludeMap);
    }

    for (var _i = 0; _i < node._children.length; _i++) {
      visitNode(node._children[_i], excludeMap);
    }
  } // do auto release


  function autoRelease(oldSceneAssets, nextSceneAssets, persistNodes) {
    var releaseSettings = _globalExports.legacyCC.loader._autoReleaseSetting;
    var excludeMap = (0, _js.createMap)(); // collect next scene assets

    if (nextSceneAssets) {
      for (var i = 0; i < nextSceneAssets.length; i++) {
        excludeMap[nextSceneAssets[i]] = true;
      }
    } // collect assets used by persist nodes


    for (var _i2 = 0; _i2 < persistNodes.length; _i2++) {
      visitNode(persistNodes[_i2], excludeMap);
    } // remove ununsed scene assets


    if (oldSceneAssets) {
      for (var _i3 = 0; _i3 < oldSceneAssets.length; _i3++) {
        var key = oldSceneAssets[_i3];

        if (releaseSettings[key] !== false && !excludeMap[key]) {
          _globalExports.legacyCC.loader.release(key);
        }
      }
    } // remove auto release assets
    // (releasing asset will change _autoReleaseSetting, so don't use for-in)


    var keys = Object.keys(releaseSettings);

    for (var _i4 = 0; _i4 < keys.length; _i4++) {
      var _key = keys[_i4];

      if (releaseSettings[_key] === true && !excludeMap[_key]) {
        _globalExports.legacyCC.loader.release(_key);
      }
    }
  } // get dependencies not including self


  function getDependsRecursively(key) {
    var depends = {};
    parseDepends(key, depends);
    return Object.keys(depends);
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL2NvcmUvbG9hZC1waXBlbGluZS9hdXRvLXJlbGVhc2UtdXRpbHMudHMiXSwibmFtZXMiOlsicGFyc2VEZXBlbmRzIiwia2V5IiwicGFyc2VkIiwiaXRlbSIsImxlZ2FjeUNDIiwibG9hZGVyIiwiZ2V0SXRlbSIsImRlcGVuZHMiLCJkZXBlbmRLZXlzIiwiaSIsImxlbmd0aCIsImRlcGVuZCIsInZpc2l0QXNzZXQiLCJhc3NldCIsImV4Y2x1ZGVNYXAiLCJfdXVpZCIsIl9nZXRSZWZlcmVuY2VLZXkiLCJ2aXNpdENvbXBvbmVudCIsImNvbXAiLCJwcm9wcyIsIk9iamVjdCIsImdldE93blByb3BlcnR5TmFtZXMiLCJ2YWx1ZSIsIkFycmF5IiwiaXNBcnJheSIsImoiLCJ2YWwiLCJSYXdBc3NldCIsImNvbnN0cnVjdG9yIiwia2V5cyIsInZpc2l0Tm9kZSIsIm5vZGUiLCJfY29tcG9uZW50cyIsIl9jaGlsZHJlbiIsImF1dG9SZWxlYXNlIiwib2xkU2NlbmVBc3NldHMiLCJuZXh0U2NlbmVBc3NldHMiLCJwZXJzaXN0Tm9kZXMiLCJyZWxlYXNlU2V0dGluZ3MiLCJfYXV0b1JlbGVhc2VTZXR0aW5nIiwicmVsZWFzZSIsImdldERlcGVuZHNSZWN1cnNpdmVseSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFpQ0EsV0FBU0EsWUFBVCxDQUF1QkMsR0FBdkIsRUFBNEJDLE1BQTVCLEVBQW9DO0FBQ2hDLFFBQUlDLElBQUksR0FBR0Msd0JBQVNDLE1BQVQsQ0FBZ0JDLE9BQWhCLENBQXdCTCxHQUF4QixDQUFYOztBQUNBLFFBQUlFLElBQUosRUFBVTtBQUNOLFVBQUlJLE9BQU8sR0FBR0osSUFBSSxDQUFDSyxVQUFuQjs7QUFDQSxVQUFJRCxPQUFKLEVBQWE7QUFDVCxhQUFLLElBQUlFLENBQUMsR0FBRyxDQUFiLEVBQWdCQSxDQUFDLEdBQUdGLE9BQU8sQ0FBQ0csTUFBNUIsRUFB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RCxHQUFDLEVBQTVDLEVBQWdEO0FBQzVDLFlBQUlSLEdBQUcsR0FBR2tDLGNBQWMsQ0FBQzFCLEdBQUQsQ0FBeEI7O0FBQ0EsWUFBSTZCLGVBQWUsQ0FBQ3JDLEdBQUQsQ0FBZixLQUF5QixLQUF6QixJQUFrQyxDQUFDYSxVQUFVLENBQUNiLEdBQUQsQ0FBakQsRUFBd0Q7QUFDcERHLGtDQUFTQyxNQUFULENBQWdCbUMsT0FBaEIsQ0FBd0J2QyxHQUF4QjtBQUNIO0FBQ0o7QUFDSixLQXhCdUUsQ0EwQnhFO0FBQ0E7OztBQUNBLFFBQUk0QixJQUFJLEdBQUdULE1BQU0sQ0FBQ1MsSUFBUCxDQUFZUyxlQUFaLENBQVg7O0FBQ0EsU0FBSyxJQUFJN0IsR0FBQyxHQUFHLENBQWIsRUFBZ0JBLEdBQUMsR0FBR29CLElBQUksQ0FBQ25CLE1BQXpCLEVBQWlDRCxHQUFDLEVBQWxDLEVBQXNDO0FBQ2xDLFVBQUlSLElBQUcsR0FBRzRCLElBQUksQ0FBQ3BCLEdBQUQsQ0FBZDs7QUFDQSxVQUFJNkIsZUFBZSxDQUFDckMsSUFBRCxDQUFmLEtBQXlCLElBQXpCLElBQWlDLENBQUNhLFVBQVUsQ0FBQ2IsSUFBRCxDQUFoRCxFQUF1RDtBQUNuREcsZ0NBQVNDLE1BQVQsQ0FBZ0JtQyxPQUFoQixDQUF3QnZDLElBQXhCO0FBQ0g7QUFDSjtBQUNKLEcsQ0FFRDs7O0FBQ08sV0FBU3dDLHFCQUFULENBQWdDeEMsR0FBaEMsRUFBcUM7QUFDeEMsUUFBSU0sT0FBTyxHQUFHLEVBQWQ7QUFDQVAsSUFBQUEsWUFBWSxDQUFDQyxHQUFELEVBQU1NLE9BQU4sQ0FBWjtBQUNBLFdBQU9hLE1BQU0sQ0FBQ1MsSUFBUCxDQUFZdEIsT0FBWixDQUFQO0FBQ0giLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG4gQ29weXJpZ2h0IChjKSAyMDE2IENodWtvbmcgVGVjaG5vbG9naWVzIEluYy5cclxuIENvcHlyaWdodCAoYykgMjAxNy0yMDE4IFhpYW1lbiBZYWppIFNvZnR3YXJlIENvLiwgTHRkLlxyXG5cclxuIGh0dHA6Ly93d3cuY29jb3MuY29tXHJcblxyXG4gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxyXG4gb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBlbmdpbmUgc291cmNlIGNvZGUgKHRoZSBcIlNvZnR3YXJlXCIpLCBhIGxpbWl0ZWQsXHJcbiAgd29ybGR3aWRlLCByb3lhbHR5LWZyZWUsIG5vbi1hc3NpZ25hYmxlLCByZXZvY2FibGUgYW5kIG5vbi1leGNsdXNpdmUgbGljZW5zZVxyXG4gdG8gdXNlIENvY29zIENyZWF0b3Igc29sZWx5IHRvIGRldmVsb3AgZ2FtZXMgb24geW91ciB0YXJnZXQgcGxhdGZvcm1zLiBZb3Ugc2hhbGxcclxuICBub3QgdXNlIENvY29zIENyZWF0b3Igc29mdHdhcmUgZm9yIGRldmVsb3Bpbmcgb3RoZXIgc29mdHdhcmUgb3IgdG9vbHMgdGhhdCdzXHJcbiAgdXNlZCBmb3IgZGV2ZWxvcGluZyBnYW1lcy4gWW91IGFyZSBub3QgZ3JhbnRlZCB0byBwdWJsaXNoLCBkaXN0cmlidXRlLFxyXG4gIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiBDb2NvcyBDcmVhdG9yLlxyXG5cclxuIFRoZSBzb2Z0d2FyZSBvciB0b29scyBpbiB0aGlzIExpY2Vuc2UgQWdyZWVtZW50IGFyZSBsaWNlbnNlZCwgbm90IHNvbGQuXHJcbiBYaWFtZW4gWWFqaSBTb2Z0d2FyZSBDby4sIEx0ZC4gcmVzZXJ2ZXMgYWxsIHJpZ2h0cyBub3QgZXhwcmVzc2x5IGdyYW50ZWQgdG8geW91LlxyXG5cclxuIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcclxuIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxyXG4gRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXHJcbiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXHJcbiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxyXG4gT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTlxyXG4gVEhFIFNPRlRXQVJFLlxyXG4gKi9cclxuLyoqXHJcbiAqIEBoaWRkZW5cclxuICovXHJcblxyXG5pbXBvcnQge2NyZWF0ZU1hcH0gZnJvbSAnLi4vdXRpbHMvanMnO1xyXG5pbXBvcnQgeyBSYXdBc3NldCB9IGZyb20gJy4uL2Fzc2V0cy9yYXctYXNzZXQnO1xyXG5pbXBvcnQgeyBsZWdhY3lDQyB9IGZyb20gJy4uL2dsb2JhbC1leHBvcnRzJztcclxuXHJcbmZ1bmN0aW9uIHBhcnNlRGVwZW5kcyAoa2V5LCBwYXJzZWQpIHtcclxuICAgIGxldCBpdGVtID0gbGVnYWN5Q0MubG9hZGVyLmdldEl0ZW0oa2V5KTtcclxuICAgIGlmIChpdGVtKSB7XHJcbiAgICAgICAgbGV0IGRlcGVuZHMgPSBpdGVtLmRlcGVuZEtleXM7XHJcbiAgICAgICAgaWYgKGRlcGVuZHMpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBkZXBlbmRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZGVwZW5kID0gZGVwZW5kc1tpXTtcclxuICAgICAgICAgICAgICAgIGlmICggIXBhcnNlZFtkZXBlbmRdICkge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcnNlZFtkZXBlbmRdID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICBwYXJzZURlcGVuZHMoZGVwZW5kLCBwYXJzZWQpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiB2aXNpdEFzc2V0IChhc3NldCwgZXhjbHVkZU1hcCkge1xyXG4gICAgLy8gU2tpcCBhc3NldHMgZ2VuZXJhdGVkIHByb2dyYW1tYXRpY2FsbHkgb3IgYnkgdXNlciAoZS5nLiBsYWJlbCB0ZXh0dXJlKVxyXG4gICAgaWYgKCFhc3NldC5fdXVpZCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGxldCBrZXkgPSBsZWdhY3lDQy5sb2FkZXIuX2dldFJlZmVyZW5jZUtleShhc3NldCk7XHJcbiAgICBpZiAoICFleGNsdWRlTWFwW2tleV0gKSB7XHJcbiAgICAgICAgZXhjbHVkZU1hcFtrZXldID0gdHJ1ZTtcclxuICAgICAgICBwYXJzZURlcGVuZHMoa2V5LCBleGNsdWRlTWFwKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdmlzaXRDb21wb25lbnQgKGNvbXAsIGV4Y2x1ZGVNYXApIHtcclxuICAgIGxldCBwcm9wcyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGNvbXApO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGxldCB2YWx1ZSA9IGNvbXBbcHJvcHNbaV1dO1xyXG4gICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmIHZhbHVlKSB7XHJcbiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCB2YWx1ZS5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCB2YWwgPSB2YWx1ZVtqXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodmFsIGluc3RhbmNlb2YgUmF3QXNzZXQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmlzaXRBc3NldCh2YWwsIGV4Y2x1ZGVNYXApO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIGlmICghdmFsdWUuY29uc3RydWN0b3IgfHwgdmFsdWUuY29uc3RydWN0b3IgPT09IE9iamVjdCkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyh2YWx1ZSk7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IGtleXMubGVuZ3RoOyBqKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgdmFsID0gdmFsdWVba2V5c1tqXV07XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCBpbnN0YW5jZW9mIFJhd0Fzc2V0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHZpc2l0QXNzZXQodmFsLCBleGNsdWRlTWFwKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBSYXdBc3NldCkge1xyXG4gICAgICAgICAgICAgICAgdmlzaXRBc3NldCh2YWx1ZSwgZXhjbHVkZU1hcCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHZpc2l0Tm9kZSAobm9kZSwgZXhjbHVkZU1hcCkge1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBub2RlLl9jb21wb25lbnRzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgdmlzaXRDb21wb25lbnQobm9kZS5fY29tcG9uZW50c1tpXSwgZXhjbHVkZU1hcCk7XHJcbiAgICB9XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5vZGUuX2NoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgdmlzaXROb2RlKG5vZGUuX2NoaWxkcmVuW2ldLCBleGNsdWRlTWFwKTtcclxuICAgIH1cclxufVxyXG5cclxuLy8gZG8gYXV0byByZWxlYXNlXHJcbmV4cG9ydCBmdW5jdGlvbiBhdXRvUmVsZWFzZSAob2xkU2NlbmVBc3NldHMsIG5leHRTY2VuZUFzc2V0cywgcGVyc2lzdE5vZGVzKSB7XHJcbiAgICBsZXQgcmVsZWFzZVNldHRpbmdzID0gbGVnYWN5Q0MubG9hZGVyLl9hdXRvUmVsZWFzZVNldHRpbmc7XHJcbiAgICBsZXQgZXhjbHVkZU1hcCA9IGNyZWF0ZU1hcCgpO1xyXG5cclxuICAgIC8vIGNvbGxlY3QgbmV4dCBzY2VuZSBhc3NldHNcclxuICAgIGlmIChuZXh0U2NlbmVBc3NldHMpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IG5leHRTY2VuZUFzc2V0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICBleGNsdWRlTWFwW25leHRTY2VuZUFzc2V0c1tpXV0gPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAvLyBjb2xsZWN0IGFzc2V0cyB1c2VkIGJ5IHBlcnNpc3Qgbm9kZXNcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcGVyc2lzdE5vZGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgdmlzaXROb2RlKHBlcnNpc3ROb2Rlc1tpXSwgZXhjbHVkZU1hcClcclxuICAgIH1cclxuXHJcbiAgICAvLyByZW1vdmUgdW51bnNlZCBzY2VuZSBhc3NldHNcclxuICAgIGlmIChvbGRTY2VuZUFzc2V0cykge1xyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb2xkU2NlbmVBc3NldHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgbGV0IGtleSA9IG9sZFNjZW5lQXNzZXRzW2ldO1xyXG4gICAgICAgICAgICBpZiAocmVsZWFzZVNldHRpbmdzW2tleV0gIT09IGZhbHNlICYmICFleGNsdWRlTWFwW2tleV0pIHtcclxuICAgICAgICAgICAgICAgIGxlZ2FjeUNDLmxvYWRlci5yZWxlYXNlKGtleSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLy8gcmVtb3ZlIGF1dG8gcmVsZWFzZSBhc3NldHNcclxuICAgIC8vIChyZWxlYXNpbmcgYXNzZXQgd2lsbCBjaGFuZ2UgX2F1dG9SZWxlYXNlU2V0dGluZywgc28gZG9uJ3QgdXNlIGZvci1pbilcclxuICAgIGxldCBrZXlzID0gT2JqZWN0LmtleXMocmVsZWFzZVNldHRpbmdzKTtcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGxldCBrZXkgPSBrZXlzW2ldO1xyXG4gICAgICAgIGlmIChyZWxlYXNlU2V0dGluZ3Nba2V5XSA9PT0gdHJ1ZSAmJiAhZXhjbHVkZU1hcFtrZXldKSB7XHJcbiAgICAgICAgICAgIGxlZ2FjeUNDLmxvYWRlci5yZWxlYXNlKGtleSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcblxyXG4vLyBnZXQgZGVwZW5kZW5jaWVzIG5vdCBpbmNsdWRpbmcgc2VsZlxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RGVwZW5kc1JlY3Vyc2l2ZWx5IChrZXkpIHtcclxuICAgIGxldCBkZXBlbmRzID0ge307XHJcbiAgICBwYXJzZURlcGVuZHMoa2V5LCBkZXBlbmRzKTtcclxuICAgIHJldHVybiBPYmplY3Qua2V5cyhkZXBlbmRzKTtcclxufSJdfQ==