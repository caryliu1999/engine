(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../../geometry/index.js", "../../renderer/scene/camera.js", "../../scene-graph/layers.js", "../../math/index.js", "../../memop/index.js", "../define.js", "../../renderer/scene/shadows.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../../geometry/index.js"), require("../../renderer/scene/camera.js"), require("../../scene-graph/layers.js"), require("../../math/index.js"), require("../../memop/index.js"), require("../define.js"), require("../../renderer/scene/shadows.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.index, global.camera, global.layers, global.index, global.index, global.define, global.shadows);
    global.sceneCulling = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _index, _camera, _layers, _index2, _index3, _define, _shadows) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.getShadowWorldMatrix = getShadowWorldMatrix;
  _exports.sceneCulling = sceneCulling;

  var _tempVec3 = new _index2.Vec3();

  var _forward = new _index2.Vec3(0, 0, -1);

  var _v3 = new _index2.Vec3();

  var _qt = new _index2.Quat();

  var _dir_negate = new _index2.Vec3();

  var _vec3_p = new _index2.Vec3();

  var _mat4_trans = new _index2.Mat4();

  var _data = Float32Array.from([1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, // matLightPlaneProj
  0.0, 0.0, 0.0, 0.3 // shadowColor
  ]);

  var roPool = new _index3.Pool(function () {
    return {
      model: null,
      depth: 0
    };
  }, 128);
  var shadowPool = new _index3.Pool(function () {
    return {
      model: null,
      depth: 0
    };
  }, 128);

  function getRenderObject(model, camera) {
    var depth = 0;

    if (model.node) {
      _index2.Vec3.subtract(_tempVec3, model.node.worldPosition, camera.position);

      depth = _index2.Vec3.dot(_tempVec3, camera.forward);
    }

    var ro = roPool.alloc();
    ro.model = model;
    ro.depth = depth;
    return ro;
  }

  function getCastShadowRenderObject(model, camera) {
    var depth = 0;

    if (model.node) {
      _index2.Vec3.subtract(_tempVec3, model.node.worldPosition, camera.position);

      depth = _index2.Vec3.dot(_tempVec3, camera.forward);
    }

    var ro = shadowPool.alloc();
    ro.model = model;
    ro.depth = depth;
    return ro;
  }

  function getShadowWorldMatrix(pipeline, rotation, dir) {
    var shadows = pipeline.shadows;

    _index2.Vec3.negate(_dir_negate, dir);

    var distance = Math.sqrt(2) * shadows.sphere.radius;

    _index2.Vec3.multiplyScalar(_vec3_p, _dir_negate, distance);

    _index2.Vec3.add(_vec3_p, _vec3_p, shadows.sphere.center);

    _index2.Mat4.fromRT(_mat4_trans, rotation, _vec3_p);

    return _mat4_trans;
  }

  function updateSphereLight(pipeline, light) {
    var shadows = pipeline.shadows;

    if (!light.node.hasChangedFlags && !shadows.dirty) {
      return;
    }

    shadows.dirty = true;
    light.node.getWorldPosition(_v3);
    var n = shadows.normal;
    var d = shadows.distance + 0.001; // avoid z-fighting

    var NdL = _index2.Vec3.dot(n, _v3);

    var lx = _v3.x;
    var ly = _v3.y;
    var lz = _v3.z;
    var nx = n.x;
    var ny = n.y;
    var nz = n.z;
    var m = shadows.matLight;
    m.m00 = NdL - d - lx * nx;
    m.m01 = -ly * nx;
    m.m02 = -lz * nx;
    m.m03 = -nx;
    m.m04 = -lx * ny;
    m.m05 = NdL - d - ly * ny;
    m.m06 = -lz * ny;
    m.m07 = -ny;
    m.m08 = -lx * nz;
    m.m09 = -ly * nz;
    m.m10 = NdL - d - lz * nz;
    m.m11 = -nz;
    m.m12 = lx * d;
    m.m13 = ly * d;
    m.m14 = lz * d;
    m.m15 = NdL;

    _index2.Mat4.toArray(_data, shadows.matLight, _define.UBOShadow.MAT_LIGHT_PLANE_PROJ_OFFSET);

    pipeline.descriptorSet.getBuffer(_define.UBOShadow.BINDING).update(_data);
  }

  function updateDirLight(pipeline, light) {
    var shadows = pipeline.shadows;

    if (!light.node.hasChangedFlags && !shadows.dirty) {
      return;
    }

    shadows.dirty = false;
    light.node.getWorldRotation(_qt);

    _index2.Vec3.transformQuat(_v3, _forward, _qt);

    var n = shadows.normal;
    var d = shadows.distance + 0.001; // avoid z-fighting

    var NdL = _index2.Vec3.dot(n, _v3);

    var scale = 1 / NdL;
    var lx = _v3.x * scale;
    var ly = _v3.y * scale;
    var lz = _v3.z * scale;
    var nx = n.x;
    var ny = n.y;
    var nz = n.z;
    var m = shadows.matLight;
    m.m00 = 1 - nx * lx;
    m.m01 = -nx * ly;
    m.m02 = -nx * lz;
    m.m03 = 0;
    m.m04 = -ny * lx;
    m.m05 = 1 - ny * ly;
    m.m06 = -ny * lz;
    m.m07 = 0;
    m.m08 = -nz * lx;
    m.m09 = -nz * ly;
    m.m10 = 1 - nz * lz;
    m.m11 = 0;
    m.m12 = lx * d;
    m.m13 = ly * d;
    m.m14 = lz * d;
    m.m15 = 1;

    _index2.Mat4.toArray(_data, shadows.matLight, _define.UBOShadow.MAT_LIGHT_PLANE_PROJ_OFFSET);

    pipeline.descriptorSet.getBuffer(_define.UBOShadow.BINDING).update(_data);
  }

  function sceneCulling(pipeline, view) {
    var camera = view.camera;
    var scene = camera.scene;
    var renderObjects = pipeline.renderObjects;
    roPool.freeArray(renderObjects);
    renderObjects.length = 0;
    var shadowObjects = pipeline.shadowObjects;
    shadowPool.freeArray(shadowObjects);
    shadowObjects.length = 0;
    var mainLight = scene.mainLight;
    var shadows = pipeline.shadows;
    var shadowSphere = shadows.sphere;
    shadowSphere.center.set(0.0, 0.0, 0.0);
    shadowSphere.radius = 0.01;

    if (shadows.enabled && shadows.dirty) {
      _index2.Color.toArray(_data, shadows.shadowColor, _define.UBOShadow.SHADOW_COLOR_OFFSET);

      pipeline.descriptorSet.getBuffer(_define.UBOShadow.BINDING).update(_data);
    }

    if (mainLight) {
      if (shadows.type === _shadows.ShadowType.Planar) {
        updateDirLight(pipeline, mainLight);
      }
    }

    if (pipeline.skybox.enabled && pipeline.skybox.model && camera.clearFlag & _camera.SKYBOX_FLAG) {
      renderObjects.push(getRenderObject(pipeline.skybox.model, camera));
    }

    var models = scene.models;

    for (var i = 0; i < models.length; i++) {
      var model = models[i]; // filter model by view visibility

      if (model.enabled) {
        var vis = view.visibility & _layers.Layers.BitMask.UI_2D;

        if (vis) {
          if (model.node && view.visibility === model.node.layer || view.visibility === model.visFlags) {
            renderObjects.push(getRenderObject(model, camera));
          }
        } else {
          if (model.node && (view.visibility & model.node.layer) === model.node.layer || view.visibility & model.visFlags) {
            // shadow render Object
            if (model.castShadow) {
              _index.sphere.mergeAABB(shadowSphere, shadowSphere, model.worldBounds);

              shadowObjects.push(getCastShadowRenderObject(model, camera));
            } // frustum culling


            if (model.worldBounds && !_index.intersect.aabb_frustum(model.worldBounds, camera.frustum)) {
              continue;
            }

            renderObjects.push(getRenderObject(model, camera));
          }
        }
      }
    }
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL2NvcmUvcGlwZWxpbmUvZGVmZXJyZWQvc2NlbmUtY3VsbGluZy50cyJdLCJuYW1lcyI6WyJfdGVtcFZlYzMiLCJWZWMzIiwiX2ZvcndhcmQiLCJfdjMiLCJfcXQiLCJRdWF0IiwiX2Rpcl9uZWdhdGUiLCJfdmVjM19wIiwiX21hdDRfdHJhbnMiLCJNYXQ0IiwiX2RhdGEiLCJGbG9hdDMyQXJyYXkiLCJmcm9tIiwicm9Qb29sIiwiUG9vbCIsIm1vZGVsIiwiZGVwdGgiLCJzaGFkb3dQb29sIiwiZ2V0UmVuZGVyT2JqZWN0IiwiY2FtZXJhIiwibm9kZSIsInN1YnRyYWN0Iiwid29ybGRQb3NpdGlvbiIsInBvc2l0aW9uIiwiZG90IiwiZm9yd2FyZCIsInJvIiwiYWxsb2MiLCJnZXRDYXN0U2hhZG93UmVuZGVyT2JqZWN0IiwiZ2V0U2hhZG93V29ybGRNYXRyaXgiLCJwaXBlbGluZSIsInJvdGF0aW9uIiwiZGlyIiwic2hhZG93cyIsIm5lZ2F0ZSIsImRpc3RhbmNlIiwiTWF0aCIsInNxcnQiLCJzcGhlcmUiLCJyYWRpdXMiLCJtdWx0aXBseVNjYWxhciIsImFkZCIsImNlbnRlciIsImZyb21SVCIsInVwZGF0ZVNwaGVyZUxpZ2h0IiwibGlnaHQiLCJoYXNDaGFuZ2VkRmxhZ3MiLCJkaXJ0eSIsImdldFdvcmxkUG9zaXRpb24iLCJuIiwibm9ybWFsIiwiZCIsIk5kTCIsImx4IiwieCIsImx5IiwieSIsImx6IiwieiIsIm54IiwibnkiLCJueiIsIm0iLCJtYXRMaWdodCIsIm0wMCIsIm0wMSIsIm0wMiIsIm0wMyIsIm0wNCIsIm0wNSIsIm0wNiIsIm0wNyIsIm0wOCIsIm0wOSIsIm0xMCIsIm0xMSIsIm0xMiIsIm0xMyIsIm0xNCIsIm0xNSIsInRvQXJyYXkiLCJVQk9TaGFkb3ciLCJNQVRfTElHSFRfUExBTkVfUFJPSl9PRkZTRVQiLCJkZXNjcmlwdG9yU2V0IiwiZ2V0QnVmZmVyIiwiQklORElORyIsInVwZGF0ZSIsInVwZGF0ZURpckxpZ2h0IiwiZ2V0V29ybGRSb3RhdGlvbiIsInRyYW5zZm9ybVF1YXQiLCJzY2FsZSIsInNjZW5lQ3VsbGluZyIsInZpZXciLCJzY2VuZSIsInJlbmRlck9iamVjdHMiLCJmcmVlQXJyYXkiLCJsZW5ndGgiLCJzaGFkb3dPYmplY3RzIiwibWFpbkxpZ2h0Iiwic2hhZG93U3BoZXJlIiwic2V0IiwiZW5hYmxlZCIsIkNvbG9yIiwic2hhZG93Q29sb3IiLCJTSEFET1dfQ09MT1JfT0ZGU0VUIiwidHlwZSIsIlNoYWRvd1R5cGUiLCJQbGFuYXIiLCJza3lib3giLCJjbGVhckZsYWciLCJTS1lCT1hfRkxBRyIsInB1c2giLCJtb2RlbHMiLCJpIiwidmlzIiwidmlzaWJpbGl0eSIsIkxheWVycyIsIkJpdE1hc2siLCJVSV8yRCIsImxheWVyIiwidmlzRmxhZ3MiLCJjYXN0U2hhZG93IiwibWVyZ2VBQUJCIiwid29ybGRCb3VuZHMiLCJpbnRlcnNlY3QiLCJhYWJiX2ZydXN0dW0iLCJmcnVzdHVtIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFZQSxNQUFNQSxTQUFTLEdBQUcsSUFBSUMsWUFBSixFQUFsQjs7QUFDQSxNQUFNQyxRQUFRLEdBQUcsSUFBSUQsWUFBSixDQUFTLENBQVQsRUFBWSxDQUFaLEVBQWUsQ0FBQyxDQUFoQixDQUFqQjs7QUFDQSxNQUFNRSxHQUFHLEdBQUcsSUFBSUYsWUFBSixFQUFaOztBQUNBLE1BQU1HLEdBQUcsR0FBRyxJQUFJQyxZQUFKLEVBQVo7O0FBQ0EsTUFBTUMsV0FBVyxHQUFHLElBQUlMLFlBQUosRUFBcEI7O0FBQ0EsTUFBTU0sT0FBTyxHQUFHLElBQUlOLFlBQUosRUFBaEI7O0FBQ0EsTUFBTU8sV0FBVyxHQUFHLElBQUlDLFlBQUosRUFBcEI7O0FBQ0EsTUFBTUMsS0FBSyxHQUFHQyxZQUFZLENBQUNDLElBQWIsQ0FBa0IsQ0FDNUIsQ0FENEIsRUFDekIsQ0FEeUIsRUFDdEIsQ0FEc0IsRUFDbkIsQ0FEbUIsRUFD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QVIsQ0FBbEM7QUFDSDtBQUNKLFNBTEQsTUFLTztBQUNILGNBQUlKLEtBQUssQ0FBQ0ssSUFBTixJQUFlLENBQUN3RSxJQUFJLENBQUN1QixVQUFMLEdBQWtCcEcsS0FBSyxDQUFDSyxJQUFOLENBQVdtRyxLQUE5QixNQUF5Q3hHLEtBQUssQ0FBQ0ssSUFBTixDQUFXbUcsS0FBbkUsSUFDQzNCLElBQUksQ0FBQ3VCLFVBQUwsR0FBa0JwRyxLQUFLLENBQUN5RyxRQUQ3QixFQUN3QztBQUVwQztBQUNBLGdCQUFJekcsS0FBSyxDQUFDMEcsVUFBVixFQUFzQjtBQUNsQm5GLDRCQUFPb0YsU0FBUCxDQUFpQnZCLFlBQWpCLEVBQStCQSxZQUEvQixFQUE2Q3BGLEtBQUssQ0FBQzRHLFdBQW5EOztBQUNBMUIsY0FBQUEsYUFBYSxDQUFDYyxJQUFkLENBQW1CbkYseUJBQXlCLENBQUNiLEtBQUQsRUFBUUksTUFBUixDQUE1QztBQUNILGFBTm1DLENBUXBDOzs7QUFDQSxnQkFBSUosS0FBSyxDQUFDNEcsV0FBTixJQUFxQixDQUFDQyxpQkFBVUMsWUFBVixDQUF1QjlHLEtBQUssQ0FBQzRHLFdBQTdCLEVBQTBDeEcsTUFBTSxDQUFDMkcsT0FBakQsQ0FBMUIsRUFBcUY7QUFDakY7QUFDSDs7QUFFRGhDLFlBQUFBLGFBQWEsQ0FBQ2lCLElBQWQsQ0FBbUI3RixlQUFlLENBQUNILEtBQUQsRUFBUUksTUFBUixDQUFsQztBQUNIO0FBQ0o7QUFDSjtBQUNKO0FBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpbnRlcnNlY3QsIHNwaGVyZSB9IGZyb20gJy4uLy4uL2dlb21ldHJ5JztcclxuaW1wb3J0IHsgTW9kZWwgfSBmcm9tICcuLi8uLi9yZW5kZXJlci9zY2VuZS9tb2RlbCc7XHJcbmltcG9ydCB7IENhbWVyYSwgU0tZQk9YX0ZMQUcgfSBmcm9tICcuLi8uLi9yZW5kZXJlci9zY2VuZS9jYW1lcmEnO1xyXG5pbXBvcnQgeyBMYXllcnMgfSBmcm9tICcuLi8uLi9zY2VuZS1ncmFwaC9sYXllcnMnO1xyXG5pbXBvcnQgeyBWZWMzLCBNYXQ0LCBRdWF0LCBDb2xvciB9IGZyb20gJy4uLy4uL21hdGgnO1xyXG5pbXBvcnQgeyBEZWZlcnJlZFBpcGVsaW5lIH0gZnJvbSAnLi4vZGVmZXJyZWQvZGVmZXJyZWQtcGlwZWxpbmUnO1xyXG5pbXBvcnQgeyBSZW5kZXJWaWV3IH0gZnJvbSAnLi4vJztcclxuaW1wb3J0IHsgUG9vbCB9IGZyb20gJy4uLy4uL21lbW9wJztcclxuaW1wb3J0IHsgSVJlbmRlck9iamVjdCwgVUJPU2hhZG93IH0gZnJvbSAnLi4vZGVmaW5lJztcclxuaW1wb3J0IHsgU2hhZG93VHlwZSB9IGZyb20gJy4uLy4uL3JlbmRlcmVyL3NjZW5lL3NoYWRvd3MnO1xyXG5pbXBvcnQgeyBTcGhlcmVMaWdodCwgRGlyZWN0aW9uYWxMaWdodH0gZnJvbSAnLi4vLi4vcmVuZGVyZXIvc2NlbmUnO1xyXG5cclxuY29uc3QgX3RlbXBWZWMzID0gbmV3IFZlYzMoKTtcclxuY29uc3QgX2ZvcndhcmQgPSBuZXcgVmVjMygwLCAwLCAtMSk7XHJcbmNvbnN0IF92MyA9IG5ldyBWZWMzKCk7XHJcbmNvbnN0IF9xdCA9IG5ldyBRdWF0KCk7XHJcbmNvbnN0IF9kaXJfbmVnYXRlID0gbmV3IFZlYzMoKTtcclxuY29uc3QgX3ZlYzNfcCA9IG5ldyBWZWMzKCk7XHJcbmNvbnN0IF9tYXQ0X3RyYW5zID0gbmV3IE1hdDQoKTtcclxuY29uc3QgX2RhdGEgPSBGbG9hdDMyQXJyYXkuZnJvbShbXHJcbiAgICAxLCAwLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAwLCAxLCAwLCAwLCAwLCAwLCAxLCAvLyBtYXRMaWdodFBsYW5lUHJvalxyXG4gICAgMC4wLCAwLjAsIDAuMCwgMC4zLCAvLyBzaGFkb3dDb2xvclxyXG5dKTtcclxuXHJcbmNvbnN0IHJvUG9vbCA9IG5ldyBQb29sPElSZW5kZXJPYmplY3Q+KCgpID0+ICh7IG1vZGVsOiBudWxsISwgZGVwdGg6IDAgfSksIDEyOCk7XHJcbmNvbnN0IHNoYWRvd1Bvb2wgPSBuZXcgUG9vbDxJUmVuZGVyT2JqZWN0PigoKSA9PiAoeyBtb2RlbDogbnVsbCEsIGRlcHRoOiAwIH0pLCAxMjgpO1xyXG5cclxuZnVuY3Rpb24gZ2V0UmVuZGVyT2JqZWN0IChtb2RlbDogTW9kZWwsIGNhbWVyYTogQ2FtZXJhKSB7XHJcbiAgICBsZXQgZGVwdGggPSAwO1xyXG4gICAgaWYgKG1vZGVsLm5vZGUpIHtcclxuICAgICAgICBWZWMzLnN1YnRyYWN0KF90ZW1wVmVjMywgbW9kZWwubm9kZS53b3JsZFBvc2l0aW9uLCBjYW1lcmEucG9zaXRpb24pO1xyXG4gICAgICAgIGRlcHRoID0gVmVjMy5kb3QoX3RlbXBWZWMzLCBjYW1lcmEuZm9yd2FyZCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBybyA9IHJvUG9vbC5hbGxvYygpO1xyXG4gICAgcm8ubW9kZWwgPSBtb2RlbDtcclxuICAgIHJvLmRlcHRoID0gZGVwdGg7XHJcbiAgICByZXR1cm4gcm87XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldENhc3RTaGFkb3dSZW5kZXJPYmplY3QgKG1vZGVsOiBNb2RlbCwgY2FtZXJhOiBDYW1lcmEpIHtcclxuICAgIGxldCBkZXB0aCA9IDA7XHJcbiAgICBpZiAobW9kZWwubm9kZSkge1xyXG4gICAgICAgIFZlYzMuc3VidHJhY3QoX3RlbXBWZWMzLCBtb2RlbC5ub2RlLndvcmxkUG9zaXRpb24sIGNhbWVyYS5wb3NpdGlvbik7XHJcbiAgICAgICAgZGVwdGggPSBWZWMzLmRvdChfdGVtcFZlYzMsIGNhbWVyYS5mb3J3YXJkKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHJvID0gc2hhZG93UG9vbC5hbGxvYygpO1xyXG4gICAgcm8ubW9kZWwgPSBtb2RlbDtcclxuICAgIHJvLmRlcHRoID0gZGVwdGg7XHJcbiAgICByZXR1cm4gcm87XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRTaGFkb3dXb3JsZE1hdHJpeCAocGlwZWxpbmU6IERlZmVycmVkUGlwZWxpbmUsIHJvdGF0aW9uOiBRdWF0LCBkaXI6IFZlYzMpIHtcclxuICAgIGNvbnN0IHNoYWRvd3MgPSBwaXBlbGluZS5zaGFkb3dzO1xyXG4gICAgVmVjMy5uZWdhdGUoX2Rpcl9uZWdhdGUsIGRpcik7XHJcbiAgICBjb25zdCBkaXN0YW5jZTogbnVtYmVyID0gTWF0aC5zcXJ0KDIpICogc2hhZG93cy5zcGhlcmUucmFkaXVzO1xyXG4gICAgVmVjMy5tdWx0aXBseVNjYWxhcihfdmVjM19wLCBfZGlyX25lZ2F0ZSwgZGlzdGFuY2UpO1xyXG4gICAgVmVjMy5hZGQoX3ZlYzNfcCwgX3ZlYzNfcCwgc2hhZG93cy5zcGhlcmUuY2VudGVyKTtcclxuXHJcbiAgICBNYXQ0LmZyb21SVChfbWF0NF90cmFucywgcm90YXRpb24sIF92ZWMzX3ApO1xyXG5cclxuICAgIHJldHVybiBfbWF0NF90cmFucztcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlU3BoZXJlTGlnaHQgKHBpcGVsaW5lOiBEZWZlcnJlZFBpcGVsaW5lLCBsaWdodDogU3BoZXJlTGlnaHQpIHtcclxuICAgIGNvbnN0IHNoYWRvd3MgPSBwaXBlbGluZS5zaGFkb3dzO1xyXG4gICAgaWYgKCFsaWdodC5ub2RlIS5oYXNDaGFuZ2VkRmxhZ3MgJiYgIXNoYWRvd3MuZGlydHkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgc2hhZG93cy5kaXJ0eSA9IHRydWU7XHJcbiAgICBsaWdodC5ub2RlIS5nZXRXb3JsZFBvc2l0aW9uKF92Myk7XHJcbiAgICBjb25zdCBuID0gc2hhZG93cy5ub3JtYWw7IGNvbnN0IGQgPSBzaGFkb3dzLmRpc3RhbmNlICsgMC4wMDE7IC8vIGF2b2lkIHotZmlnaHRpbmdcclxuICAgIGNvbnN0IE5kTCA9IFZlYzMuZG90KG4sIF92Myk7XHJcbiAgICBjb25zdCBseCA9IF92My54OyBjb25zdCBseSA9IF92My55OyBjb25zdCBseiA9IF92My56O1xyXG4gICAgY29uc3QgbnggPSBuLng7IGNvbnN0IG55ID0gbi55OyBjb25zdCBueiA9IG4uejtcclxuICAgIGNvbnN0IG0gPSBzaGFkb3dzLm1hdExpZ2h0O1xyXG4gICAgbS5tMDAgPSBOZEwgLSBkIC0gbHggKiBueDtcclxuICAgIG0ubTAxID0gLWx5ICogbng7XHJcbiAgICBtLm0wMiA9IC1seiAqIG54O1xyXG4gICAgbS5tMDMgPSAtbng7XHJcbiAgICBtLm0wNCA9IC1seCAqIG55O1xyXG4gICAgbS5tMDUgPSBOZEwgLSBkIC0gbHkgKiBueTtcclxuICAgIG0ubTA2ID0gLWx6ICogbnk7XHJcbiAgICBtLm0wNyA9IC1ueTtcclxuICAgIG0ubTA4ID0gLWx4ICogbno7XHJcbiAgICBtLm0wOSA9IC1seSAqIG56O1xyXG4gICAgbS5tMTAgPSBOZEwgLSBkIC0gbHogKiBuejtcclxuICAgIG0ubTExID0gLW56O1xyXG4gICAgbS5tMTIgPSBseCAqIGQ7XHJcbiAgICBtLm0xMyA9IGx5ICogZDtcclxuICAgIG0ubTE0ID0gbHogKiBkO1xyXG4gICAgbS5tMTUgPSBOZEw7XHJcblxyXG4gICAgTWF0NC50b0FycmF5KF9kYXRhLCBzaGFkb3dzLm1hdExpZ2h0LCBVQk9TaGFkb3cuTUFUX0xJR0hUX1BMQU5FX1BST0pfT0ZGU0VUKTtcclxuICAgIHBpcGVsaW5lLmRlc2NyaXB0b3JTZXQuZ2V0QnVmZmVyKFVCT1NoYWRvdy5CSU5ESU5HKS51cGRhdGUoX2RhdGEpO1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVEaXJMaWdodCAocGlwZWxpbmU6IERlZmVycmVkUGlwZWxpbmUsIGxpZ2h0OiBEaXJlY3Rpb25hbExpZ2h0KSB7XHJcbiAgICBjb25zdCBzaGFkb3dzID0gcGlwZWxpbmUuc2hhZG93cztcclxuICAgIGlmICghbGlnaHQubm9kZSEuaGFzQ2hhbmdlZEZsYWdzICYmICFzaGFkb3dzLmRpcnR5KSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHNoYWRvd3MuZGlydHkgPSBmYWxzZTtcclxuXHJcbiAgICBsaWdodC5ub2RlIS5nZXRXb3JsZFJvdGF0aW9uKF9xdCk7XHJcbiAgICBWZWMzLnRyYW5zZm9ybVF1YXQoX3YzLCBfZm9yd2FyZCwgX3F0KTtcclxuICAgIGNvbnN0IG4gPSBzaGFkb3dzLm5vcm1hbDsgY29uc3QgZCA9IHNoYWRvd3MuZGlzdGFuY2UgKyAwLjAwMTsgLy8gYXZvaWQgei1maWdodGluZ1xyXG4gICAgY29uc3QgTmRMID0gVmVjMy5kb3QobiwgX3YzKTsgY29uc3Qgc2NhbGUgPSAxIC8gTmRMO1xyXG4gICAgY29uc3QgbHggPSBfdjMueCAqIHNjYWxlOyBjb25zdCBseSA9IF92My55ICogc2NhbGU7IGNvbnN0IGx6ID0gX3YzLnogKiBzY2FsZTtcclxuICAgIGNvbnN0IG54ID0gbi54OyBjb25zdCBueSA9IG4ueTsgY29uc3QgbnogPSBuLno7XHJcbiAgICBjb25zdCBtID0gc2hhZG93cy5tYXRMaWdodDtcclxuICAgIG0ubTAwID0gMSAtIG54ICogbHg7XHJcbiAgICBtLm0wMSA9IC1ueCAqIGx5O1xyXG4gICAgbS5tMDIgPSAtbnggKiBsejtcclxuICAgIG0ubTAzID0gMDtcclxuICAgIG0ubTA0ID0gLW55ICogbHg7XHJcbiAgICBtLm0wNSA9IDEgLSBueSAqIGx5O1xyXG4gICAgbS5tMDYgPSAtbnkgKiBsejtcclxuICAgIG0ubTA3ID0gMDtcclxuICAgIG0ubTA4ID0gLW56ICogbHg7XHJcbiAgICBtLm0wOSA9IC1ueiAqIGx5O1xyXG4gICAgbS5tMTAgPSAxIC0gbnogKiBsejtcclxuICAgIG0ubTExID0gMDtcclxuICAgIG0ubTEyID0gbHggKiBkO1xyXG4gICAgbS5tMTMgPSBseSAqIGQ7XHJcbiAgICBtLm0xNCA9IGx6ICogZDtcclxuICAgIG0ubTE1ID0gMTtcclxuXHJcbiAgICBNYXQ0LnRvQXJyYXkoX2RhdGEsIHNoYWRvd3MubWF0TGlnaHQsIFVCT1NoYWRvdy5NQVRfTElHSFRfUExBTkVfUFJPSl9PRkZTRVQpO1xyXG4gICAgcGlwZWxpbmUuZGVzY3JpcHRvclNldC5nZXRCdWZmZXIoVUJPU2hhZG93LkJJTkRJTkcpLnVwZGF0ZShfZGF0YSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzY2VuZUN1bGxpbmcgKHBpcGVsaW5lOiBEZWZlcnJlZFBpcGVsaW5lLCB2aWV3OiBSZW5kZXJWaWV3KSB7XHJcbiAgICBjb25zdCBjYW1lcmEgPSB2aWV3LmNhbWVyYTtcclxuICAgIGNvbnN0IHNjZW5lID0gY2FtZXJhLnNjZW5lITtcclxuICAgIGNvbnN0IHJlbmRlck9iamVjdHMgPSBwaXBlbGluZS5yZW5kZXJPYmplY3RzO1xyXG4gICAgcm9Qb29sLmZyZWVBcnJheShyZW5kZXJPYmplY3RzKTsgcmVuZGVyT2JqZWN0cy5sZW5ndGggPSAwO1xyXG4gICAgY29uc3Qgc2hhZG93T2JqZWN0cyA9IHBpcGVsaW5lLnNoYWRvd09iamVjdHM7XHJcbiAgICBzaGFkb3dQb29sLmZyZWVBcnJheShzaGFkb3dPYmplY3RzKTsgc2hhZG93T2JqZWN0cy5sZW5ndGggPSAwO1xyXG5cclxuICAgIGNvbnN0IG1haW5MaWdodCA9IHNjZW5lLm1haW5MaWdodDtcclxuICAgIGNvbnN0IHNoYWRvd3MgPSBwaXBlbGluZS5zaGFkb3dzO1xyXG4gICAgY29uc3Qgc2hhZG93U3BoZXJlID0gc2hhZG93cy5zcGhlcmU7XHJcbiAgICBzaGFkb3dTcGhlcmUuY2VudGVyLnNldCgwLjAsIDAuMCwgMC4wKTtcclxuICAgIHNoYWRvd1NwaGVyZS5yYWRpdXMgPSAwLjAxO1xyXG5cclxuICAgIGlmIChzaGFkb3dzLmVuYWJsZWQgJiYgc2hhZG93cy5kaXJ0eSkge1xyXG4gICAgICAgIENvbG9yLnRvQXJyYXkoX2RhdGEsIHNoYWRvd3Muc2hhZG93Q29sb3IsIFVCT1NoYWRvdy5TSEFET1dfQ09MT1JfT0ZGU0VUKTtcclxuICAgICAgICBwaXBlbGluZS5kZXNjcmlwdG9yU2V0LmdldEJ1ZmZlcihVQk9TaGFkb3cuQklORElORykudXBkYXRlKF9kYXRhKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAobWFpbkxpZ2h0KSB7XHJcbiAgICAgICAgaWYgKHNoYWRvd3MudHlwZSA9PT0gU2hhZG93VHlwZS5QbGFuYXIpIHtcclxuICAgICAgICAgICAgdXBkYXRlRGlyTGlnaHQocGlwZWxpbmUsIG1haW5MaWdodCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlmIChwaXBlbGluZS5za3lib3guZW5hYmxlZCAmJiBwaXBlbGluZS5za3lib3gubW9kZWwgJiYgKGNhbWVyYS5jbGVhckZsYWcgJiBTS1lCT1hfRkxBRykpIHtcclxuICAgICAgICByZW5kZXJPYmplY3RzLnB1c2goZ2V0UmVuZGVyT2JqZWN0KHBpcGVsaW5lLnNreWJveC5tb2RlbCwgY2FtZXJhKSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbW9kZWxzID0gc2NlbmUubW9kZWxzO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbW9kZWxzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3QgbW9kZWwgPSBtb2RlbHNbaV07XHJcblxyXG4gICAgICAgIC8vIGZpbHRlciBtb2RlbCBieSB2aWV3IHZpc2liaWxpdHlcclxuICAgICAgICBpZiAobW9kZWwuZW5hYmxlZCkge1xyXG4gICAgICAgICAgICBjb25zdCB2aXMgPSB2aWV3LnZpc2liaWxpdHkgJiBMYXllcnMuQml0TWFzay5VSV8yRDtcclxuICAgICAgICAgICAgaWYgKHZpcykge1xyXG4gICAgICAgICAgICAgICAgaWYgKChtb2RlbC5ub2RlICYmICh2aWV3LnZpc2liaWxpdHkgPT09IG1vZGVsLm5vZGUubGF5ZXIpKSB8fFxyXG4gICAgICAgICAgICAgICAgICAgIHZpZXcudmlzaWJpbGl0eSA9PT0gbW9kZWwudmlzRmxhZ3MpIHtcclxuICAgICAgICAgICAgICAgICAgICByZW5kZXJPYmplY3RzLnB1c2goZ2V0UmVuZGVyT2JqZWN0KG1vZGVsLCBjYW1lcmEpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGlmIChtb2RlbC5ub2RlICYmICgodmlldy52aXNpYmlsaXR5ICYgbW9kZWwubm9kZS5sYXllcikgPT09IG1vZGVsLm5vZGUubGF5ZXIpIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgKHZpZXcudmlzaWJpbGl0eSAmIG1vZGVsLnZpc0ZsYWdzKSkge1xyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBzaGFkb3cgcmVuZGVyIE9iamVjdFxyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5jYXN0U2hhZG93KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNwaGVyZS5tZXJnZUFBQkIoc2hhZG93U3BoZXJlLCBzaGFkb3dTcGhlcmUsIG1vZGVsLndvcmxkQm91bmRzISk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRvd09iamVjdHMucHVzaChnZXRDYXN0U2hhZG93UmVuZGVyT2JqZWN0KG1vZGVsLCBjYW1lcmEpKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGZydXN0dW0gY3VsbGluZ1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC53b3JsZEJvdW5kcyAmJiAhaW50ZXJzZWN0LmFhYmJfZnJ1c3R1bShtb2RlbC53b3JsZEJvdW5kcywgY2FtZXJhLmZydXN0dW0pKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgcmVuZGVyT2JqZWN0cy5wdXNoKGdldFJlbmRlck9iamVjdChtb2RlbCwgY2FtZXJhKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19