(function (global, factory) {
  if (typeof define === "function" && define.amd) {
    define(["exports", "../../geometry/index.js", "../../renderer/scene/camera.js", "../../scene-graph/layers.js", "../../math/index.js", "../../memop/index.js", "../define.js", "../../renderer/scene/shadows.js"], factory);
  } else if (typeof exports !== "undefined") {
    factory(exports, require("../../geometry/index.js"), require("../../renderer/scene/camera.js"), require("../../scene-graph/layers.js"), require("../../math/index.js"), require("../../memop/index.js"), require("../define.js"), require("../../renderer/scene/shadows.js"));
  } else {
    var mod = {
      exports: {}
    };
    factory(mod.exports, global.index, global.camera, global.layers, global.index, global.index, global.define, global.shadows);
    global.sceneCulling = mod.exports;
  }
})(typeof globalThis !== "undefined" ? globalThis : typeof self !== "undefined" ? self : this, function (_exports, _index, _camera, _layers, _index2, _index3, _define, _shadows) {
  "use strict";

  Object.defineProperty(_exports, "__esModule", {
    value: true
  });
  _exports.getShadowWorldMatrix = getShadowWorldMatrix;
  _exports.sceneCulling = sceneCulling;

  var _tempVec3 = new _index2.Vec3();

  var _forward = new _index2.Vec3(0, 0, -1);

  var _v3 = new _index2.Vec3();

  var _qt = new _index2.Quat();

  var _dir_negate = new _index2.Vec3();

  var _vec3_p = new _index2.Vec3();

  var _mat4_trans = new _index2.Mat4();

  var _data = Float32Array.from([1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, // matLightPlaneProj
  0.0, 0.0, 0.0, 0.3 // shadowColor
  ]);

  var roPool = new _index3.Pool(function () {
    return {
      model: null,
      depth: 0
    };
  }, 128);
  var shadowPool = new _index3.Pool(function () {
    return {
      model: null,
      depth: 0
    };
  }, 128);

  function getRenderObject(model, camera) {
    var depth = 0;

    if (model.node) {
      _index2.Vec3.subtract(_tempVec3, model.node.worldPosition, camera.position);

      depth = _index2.Vec3.dot(_tempVec3, camera.forward);
    }

    var ro = roPool.alloc();
    ro.model = model;
    ro.depth = depth;
    return ro;
  }

  function getCastShadowRenderObject(model, camera) {
    var depth = 0;

    if (model.node) {
      _index2.Vec3.subtract(_tempVec3, model.node.worldPosition, camera.position);

      depth = _index2.Vec3.dot(_tempVec3, camera.forward);
    }

    var ro = shadowPool.alloc();
    ro.model = model;
    ro.depth = depth;
    return ro;
  }

  function getShadowWorldMatrix(pipeline, rotation, dir) {
    var shadows = pipeline.shadows;

    _index2.Vec3.negate(_dir_negate, dir);

    var distance = Math.sqrt(2) * shadows.sphere.radius;

    _index2.Vec3.multiplyScalar(_vec3_p, _dir_negate, distance);

    _index2.Vec3.add(_vec3_p, _vec3_p, shadows.sphere.center);

    _index2.Mat4.fromRT(_mat4_trans, rotation, _vec3_p);

    return _mat4_trans;
  }

  function updateSphereLight(pipeline, light) {
    var shadows = pipeline.shadows;

    if (!light.node.hasChangedFlags && !shadows.dirty) {
      return;
    }

    shadows.dirty = true;
    light.node.getWorldPosition(_v3);
    var n = shadows.normal;
    var d = shadows.distance + 0.001; // avoid z-fighting

    var NdL = _index2.Vec3.dot(n, _v3);

    var lx = _v3.x;
    var ly = _v3.y;
    var lz = _v3.z;
    var nx = n.x;
    var ny = n.y;
    var nz = n.z;
    var m = shadows.matLight;
    m.m00 = NdL - d - lx * nx;
    m.m01 = -ly * nx;
    m.m02 = -lz * nx;
    m.m03 = -nx;
    m.m04 = -lx * ny;
    m.m05 = NdL - d - ly * ny;
    m.m06 = -lz * ny;
    m.m07 = -ny;
    m.m08 = -lx * nz;
    m.m09 = -ly * nz;
    m.m10 = NdL - d - lz * nz;
    m.m11 = -nz;
    m.m12 = lx * d;
    m.m13 = ly * d;
    m.m14 = lz * d;
    m.m15 = NdL;

    _index2.Mat4.toArray(_data, shadows.matLight, _define.UBOShadow.MAT_LIGHT_PLANE_PROJ_OFFSET);

    pipeline.descriptorSet.getBuffer(_define.UBOShadow.BINDING).update(_data);
  }

  function updateDirLight(pipeline, light) {
    var shadows = pipeline.shadows;

    if (!light.node.hasChangedFlags && !shadows.dirty) {
      return;
    }

    shadows.dirty = false;
    light.node.getWorldRotation(_qt);

    _index2.Vec3.transformQuat(_v3, _forward, _qt);

    var n = shadows.normal;
    var d = shadows.distance + 0.001; // avoid z-fighting

    var NdL = _index2.Vec3.dot(n, _v3);

    var scale = 1 / NdL;
    var lx = _v3.x * scale;
    var ly = _v3.y * scale;
    var lz = _v3.z * scale;
    var nx = n.x;
    var ny = n.y;
    var nz = n.z;
    var m = shadows.matLight;
    m.m00 = 1 - nx * lx;
    m.m01 = -nx * ly;
    m.m02 = -nx * lz;
    m.m03 = 0;
    m.m04 = -ny * lx;
    m.m05 = 1 - ny * ly;
    m.m06 = -ny * lz;
    m.m07 = 0;
    m.m08 = -nz * lx;
    m.m09 = -nz * ly;
    m.m10 = 1 - nz * lz;
    m.m11 = 0;
    m.m12 = lx * d;
    m.m13 = ly * d;
    m.m14 = lz * d;
    m.m15 = 1;

    _index2.Mat4.toArray(_data, shadows.matLight, _define.UBOShadow.MAT_LIGHT_PLANE_PROJ_OFFSET);

    pipeline.descriptorSet.getBuffer(_define.UBOShadow.BINDING).update(_data);
  }

  function sceneCulling(pipeline, view) {
    var camera = view.camera;
    var scene = camera.scene;
    var renderObjects = pipeline.renderObjects;
    roPool.freeArray(renderObjects);
    renderObjects.length = 0;
    var shadowObjects = pipeline.shadowObjects;
    shadowPool.freeArray(shadowObjects);
    shadowObjects.length = 0;
    var mainLight = scene.mainLight;
    var shadows = pipeline.shadows;
    var shadowSphere = shadows.sphere;
    shadowSphere.center.set(0.0, 0.0, 0.0);
    shadowSphere.radius = 0.01;

    if (shadows.enabled && shadows.dirty) {
      _index2.Color.toArray(_data, shadows.shadowColor, _define.UBOShadow.SHADOW_COLOR_OFFSET);

      pipeline.descriptorSet.getBuffer(_define.UBOShadow.BINDING).update(_data);
    }

    if (mainLight) {
      if (shadows.type === _shadows.ShadowType.Planar) {
        updateDirLight(pipeline, mainLight);
      }
    }

    if (pipeline.skybox.enabled && pipeline.skybox.model && camera.clearFlag & _camera.SKYBOX_FLAG) {
      renderObjects.push(getRenderObject(pipeline.skybox.model, camera));
    }

    var models = scene.models;

    for (var i = 0; i < models.length; i++) {
      var model = models[i]; // filter model by view visibility

      if (model.enabled) {
        var vis = view.visibility & _layers.Layers.BitMask.UI_2D;

        if (vis) {
          if (model.node && view.visibility === model.node.layer || view.visibility === model.visFlags) {
            renderObjects.push(getRenderObject(model, camera));
          }
        } else {
          if (model.node && (view.visibility & model.node.layer) === model.node.layer || view.visibility & model.visFlags) {
            // shadow render Object
            if (model.castShadow) {
              _index.sphere.mergeAABB(shadowSphere, shadowSphere, model.worldBounds);

              shadowObjects.push(getCastShadowRenderObject(model, camera));
            } // frustum culling


            if (model.worldBounds && !_index.intersect.aabb_frustum(model.worldBounds, camera.frustum)) {
              continue;
            }

            renderObjects.push(getRenderObject(model, camera));
          }
        }
      }
    }
  }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImU6L2QwMDQ1MjUyMC9HaXRodWIvZW5naW5lL2NvY29zL2NvcmUvcGlwZWxpbmUvZm9yd2FyZC9zY2VuZS1jdWxsaW5nLnRzIl0sIm5hbWVzIjpbIl90ZW1wVmVjMyIsIlZlYzMiLCJfZm9yd2FyZCIsIl92MyIsIl9xdCIsIlF1YXQiLCJfZGlyX25lZ2F0ZSIsIl92ZWMzX3AiLCJfbWF0NF90cmFucyIsIk1hdDQiLCJfZGF0YSIsIkZsb2F0MzJBcnJheSIsImZyb20iLCJyb1Bvb2wiLCJQb29sIiwibW9kZWwiLCJkZXB0aCIsInNoYWRvd1Bvb2wiLCJnZXRSZW5kZXJPYmplY3QiLCJjYW1lcmEiLCJub2RlIiwic3VidHJhY3QiLCJ3b3JsZFBvc2l0aW9uIiwicG9zaXRpb24iLCJkb3QiLCJmb3J3YXJkIiwicm8iLCJhbGxvYyIsImdldENhc3RTaGFkb3dSZW5kZXJPYmplY3QiLCJnZXRTaGFkb3dXb3JsZE1hdHJpeCIsInBpcGVsaW5lIiwicm90YXRpb24iLCJkaXIiLCJzaGFkb3dzIiwibmVnYXRlIiwiZGlzdGFuY2UiLCJNYXRoIiwic3FydCIsInNwaGVyZSIsInJhZGl1cyIsIm11bHRpcGx5U2NhbGFyIiwiYWRkIiwiY2VudGVyIiwiZnJvbVJUIiwidXBkYXRlU3BoZXJlTGlnaHQiLCJsaWdodCIsImhhc0NoYW5nZWRGbGFncyIsImRpcnR5IiwiZ2V0V29ybGRQb3NpdGlvbiIsIm4iLCJub3JtYWwiLCJkIiwiTmRMIiwibHgiLCJ4IiwibHkiLCJ5IiwibHoiLCJ6IiwibngiLCJueSIsIm56IiwibSIsIm1hdExpZ2h0IiwibTAwIiwibTAxIiwibTAyIiwibTAzIiwibTA0IiwibTA1IiwibTA2IiwibTA3IiwibTA4IiwibTA5IiwibTEwIiwibTExIiwibTEyIiwibTEzIiwibTE0IiwibTE1IiwidG9BcnJheSIsIlVCT1NoYWRvdyIsIk1BVF9MSUdIVF9QTEFORV9QUk9KX09GRlNFVCIsImRlc2NyaXB0b3JTZXQiLCJnZXRCdWZmZXIiLCJCSU5ESU5HIiwidXBkYXRlIiwidXBkYXRlRGlyTGlnaHQiLCJnZXRXb3JsZFJvdGF0aW9uIiwidHJhbnNmb3JtUXVhdCIsInNjYWxlIiwic2NlbmVDdWxsaW5nIiwidmlldyIsInNjZW5lIiwicmVuZGVyT2JqZWN0cyIsImZyZWVBcnJheSIsImxlbmd0aCIsInNoYWRvd09iamVjdHMiLCJtYWluTGlnaHQiLCJzaGFkb3dTcGhlcmUiLCJzZXQiLCJlbmFibGVkIiwiQ29sb3IiLCJzaGFkb3dDb2xvciIsIlNIQURPV19DT0xPUl9PRkZTRVQiLCJ0eXBlIiwiU2hhZG93VHlwZSIsIlBsYW5hciIsInNreWJveCIsImNsZWFyRmxhZyIsIlNLWUJPWF9GTEFHIiwicHVzaCIsIm1vZGVscyIsImkiLCJ2aXMiLCJ2aXNpYmlsaXR5IiwiTGF5ZXJzIiwiQml0TWFzayIsIlVJXzJEIiwibGF5ZXIiLCJ2aXNGbGFncyIsImNhc3RTaGFkb3ciLCJtZXJnZUFBQkIiLCJ3b3JsZEJvdW5kcyIsImludGVyc2VjdCIsImFhYmJfZnJ1c3R1bSIsImZydXN0dW0iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQVlBLE1BQU1BLFNBQVMsR0FBRyxJQUFJQyxZQUFKLEVBQWxCOztBQUNBLE1BQU1DLFFBQVEsR0FBRyxJQUFJRCxZQUFKLENBQVMsQ0FBVCxFQUFZLENBQVosRUFBZSxDQUFDLENBQWhCLENBQWpCOztBQUNBLE1BQU1FLEdBQUcsR0FBRyxJQUFJRixZQUFKLEVBQVo7O0FBQ0EsTUFBTUcsR0FBRyxHQUFHLElBQUlDLFlBQUosRUFBWjs7QUFDQSxNQUFNQyxXQUFXLEdBQUcsSUFBSUwsWUFBSixFQUFwQjs7QUFDQSxNQUFNTSxPQUFPLEdBQUcsSUFBSU4sWUFBSixFQUFoQjs7QUFDQSxNQUFNTyxXQUFXLEdBQUcsSUFBSUMsWUFBSixFQUFwQjs7QUFDQSxNQUFNQyxLQUFLLEdBQUdDLFlBQVksQ0FBQ0MsSUFBYixDQUFrQixDQUM1QixDQUQ0QixFQUN6QixDQUR5QixFQUN0QixDQURzQixFQUNuQixDQURtQixFQUNoQixDQURnQixFQUNiLENBRGEsRUFDVixDQURVLEVBQ1AsQ0FETyxFQUNKLENBREksRUFDRCxDQURDLEVBQ0UsQ0FERixFQUNLLENBREwsRUFDUSxDQURSLEVBQ1csQ0FEWCxFQUNjLENBRGQsRUFDaUIsQ0FEakIsRUFDb0I7QUFDaEQsS0FGNEIsRUFFdkIsR0FGdUIsRUFFbEIsR0FGa0IsRUFFYixHQUZhLENBRVI7QUFGUSxHQUFsQixDQUFkOztBQUtBLE1BQU1DLE1BQU0sR0FBRyxJQUFJQyxZQUFKLENBQXdCO0FBQUEsV0FBTztBQUFFQyxNQUFBQSxLQUFLLEVBQUUsSUFBVDtBQUFnQkMsTUFBQUEsS0FBSyxFQUFFO0FBQXZCLEtBQVA7QUFBQSxHQUF4QixFQUE0RCxHQUE1RCxDQUFmO0FBQ0EsTUFBTUMsVUFBVSxHQUFHLElBQUlILFlBQUosQ0FBd0I7QUFBQSxXQUFPO0FBQUVDLE1BQUFBLEtBQUssRUFBRSxJQUFUO0FBQWdCQyxNQUFBQSxLQUFLLEVBQUU7QUFBdkIsS0FBUDtBQUFBLEdBQXhCLEVBQTRELEdBQTVELENBQW5COztBQUVBLFdBQVNFLGVBQVQsQ0FBMEJILEtBQTFCLEVBQXdDSSxNQUF4QyxFQUF3RDtBQUNwRCxRQUFJSCxLQUFLLEdBQUcsQ0FBWjs7QUFDQSxRQUFJRCxLQUFLLENBQUNLLElBQVYsRUFBZ0I7QUFDWm5CLG1CQUFLb0IsUUFBTCxDQUFjckIsU0FBZCxFQUF5QmUsS0FBSyxDQUFDSyxJQUFOLENBQVdFLGFBQXBDLEVBQW1ESCxNQUFNLENBQUNJLFFBQTFEOztBQUNBUCxNQUFBQSxLQUFLLEdBQUdmLGFBQUt1QixHQUFMLENBQVN4QixTQUFULEVBQW9CbUIsTUFBTSxDQUFDTSxPQUEzQixDQUFSO0FBQ0g7O0FBQ0QsUUFBTUMsRUFBRSxHQUFHYixNQUFNLENBQUNjLEtBQVAsRUFBWDtBQUNBRCxJQUFBQSxFQUFFLENBQUNYLEtBQUgsR0FBV0EsS0FBWDtBQUNBVyxJQUFBQSxFQUFFLENBQUNWLEtBQUgsR0FBV0EsS0FBWDtBQUNBLFdBQU9VLEVBQVA7QUFDSDs7QUFFRCxXQUFTRSx5QkFBVCxDQUFvQ2IsS0FBcEMsRUFBa0RJLE1BQWxELEVBQWtFO0FBQzlELFFBQUlILEtBQUssR0FBRyxDQUFaOztBQUNBLFFBQUlELEtBQUssQ0FBQ0ssSUFBVixFQUFnQjtBQUNabkIsbUJBQUtvQixRQUFMLENBQWNyQixTQUFkLEVBQXlCZSxLQUFLLENBQUNLLElBQU4sQ0FBV0UsYUFBcEMsRUFBbURILE1BQU0sQ0FBQ0ksUUFBMUQ7O0FBQ0FQLE1BQUFBLEtBQUssR0FBR2YsYUFBS3VCLEdBQUwsQ0FBU3hCLFNBQVQsRUFBb0JtQixNQUFNLENBQUNNLE9BQTNCLENBQVI7QUFDSDs7QUFDRCxRQUFNQyxFQUFFLEdBQUdULFVBQVUsQ0FBQ1UsS0FBWCxFQUFYO0FBQ0FELElBQUFBLEVBQUUsQ0FBQ1gsS0FBSCxHQUFXQSxLQUFYO0FBQ0FXLElBQUFBLEVBQUUsQ0FBQ1YsS0FBSCxHQUFXQSxLQUFYO0FBQ0EsV0FBT1UsRUFBUDtBQUNIOztBQUVNLFdBQVNHLG9CQUFULENBQStCQyxRQUEvQixFQUEwREMsUUFBMUQsRUFBMEVDLEdBQTFFLEVBQXFGO0FBQ3hGLFFBQU1DLE9BQU8sR0FBR0gsUUFBUSxDQUFDRyxPQUF6Qjs7QUFDQWhDLGlCQUFLaUMsTUFBTCxDQUFZNUIsV0FBWixFQUF5QjBCLEdBQXpCOztBQUNBLFFBQU1HLFFBQWdCLEdBQUdDLElBQUksQ0FBQ0MsSUFBTCxDQUFVLENBQVYsSUFBZUosT0FBTyxDQUFDSyxNQUFSLENBQWVDLE1BQXZEOztBQUNBdEMsaUJBQUt1QyxjQUFMLENBQW9CakMsT0FBcEIsRUFBNkJELFdBQTdCLEVBQTBDNkIsUUFBMUM7O0FBQ0FsQyxpQkFBS3dDLEdBQUwsQ0FBU2xDLE9BQVQsRUFBa0JBLE9BQWxCLEVBQTJCMEIsT0FBTyxDQUFDSyxNQUFSLENBQWVJLE1BQTFDOztBQUVBakMsaUJBQUtrQyxNQUFMLENBQVluQyxXQUFaLEVBQXlCdUIsUUFBekIsRUFBbUN4QixPQUFuQzs7QUFFQSxXQUFPQyxXQUFQO0FBQ0g7O0FBRUQsV0FBU29DLGlCQUFULENBQTRCZCxRQUE1QixFQUF1RGUsS0FBdkQsRUFBMkU7QUFDdkUsUUFBTVosT0FBTyxHQUFHSCxRQUFRLENBQUNHLE9BQXpCOztBQUNBLFFBQUksQ0FBQ1ksS0FBSyxDQUFDekIsSUFBTixDQUFZMEIsZUFBYixJQUFnQyxDQUFDYixPQUFPLENBQUNjLEtBQTdDLEVBQW9EO0FBQ2hEO0FBQ0g7O0FBRURkLElBQUFBLE9BQU8sQ0FBQ2MsS0FBUixHQUFnQixJQUFoQjtBQUNBRixJQUFBQSxLQUFLLENBQUN6QixJQUFOLENBQVk0QixnQkFBWixDQUE2QjdDLEdBQTdCO0FBQ0EsUUFBTThDLENBQUMsR0FBR2hCLE9BQU8sQ0FBQ2lCLE1BQWxCO0FBQTBCLFFBQU1DLENBQUMsR0FBR2xCLE9BQU8sQ0FBQ0UsUUFBUixHQUFtQixLQUE3QixDQVI2QyxDQVFUOztBQUM5RCxRQUFNaUIsR0FBRyxHQUFHbkQsYUFBS3VCLEdBQUwsQ0FBU3lCLENBQVQsRUFBWTlDLEdBQVosQ0FBWjs7QUFDQSxRQUFNa0QsRUFBRSxHQUFHbEQsR0FBRyxDQUFDbUQsQ0FBZjtBQUFrQixRQUFNQyxFQUFFLEdBQUdwRCxHQUFHLENBQUNxRCxDQUFmO0FBQWtCLFFBQU1DLEVBQUUsR0FBR3RELEdBQUcsQ0FBQ3VELENBQWY7QUFDcEMsUUFBTUMsRUFBRSxHQUFHVixDQUFDLENBQUNLLENBQWI7QUFBZ0IsUUFBTU0sRUFBRSxHQUFHWCxDQUFDLENBQUNPLENBQWI7QUFBZ0IsUUFBTUssRUFBRSxHQUFHWixDQUFDLENBQUNTLENBQWI7QUFDaEMsUUFBTUksQ0FBQyxHQUFHN0IsT0FBTyxDQUFDOEIsUUFBbEI7QUFDQUQsSUFBQUEsQ0FBQyxDQUFDRSxHQUFGLEdBQVFaLEdBQUcsR0FBR0QsQ0FBTixHQUFVRSxFQUFFLEdBQUdNLEVBQXZCO0FBQ0FHLElBQUFBLENBQUMsQ0FBQ0csR0FBRixHQUFRLENBQUNWLEVBQUQsR0FBTUksRUFBZDtBQUNBRyxJQUFBQSxDQUFDLENBQUNJLEdBQUYsR0FBUSxDQUFDVCxFQUFELEdBQU1FLEVBQWQ7QUFDQUcsSUFBQUEsQ0FBQyxDQUFDSyxHQUFGLEdBQVEsQ0FBQ1IsRUFBVDtBQUNBRyxJQUFBQSxDQUFDLENBQUNNLEdBQUYsR0FBUSxDQUFDZixFQUFELEdBQU1PLEVBQWQ7QUFDQUUsSUFBQUEsQ0FBQyxDQUFDTyxHQUFGLEdBQVFqQixHQUFHLEdBQUdELENBQU4sR0FBVUksRUFBRSxHQUFHSyxFQUF2QjtBQUNBRSxJQUFBQSxDQUFDLENBQUNRLEdBQUYsR0FBUSxDQUFDYixFQUFELEdBQU1HLEVBQWQ7QUFDQUUsSUFBQUEsQ0FBQyxDQUFDUyxHQUFGLEdBQVEsQ0FBQ1gsRUFBVDtBQUNBRSxJQUFBQSxDQUFDLENBQUNVLEdBQUYsR0FBUSxDQUFDbkIsRUFBRCxHQUFNUSxFQUFkO0FBQ0FDLElBQUFBLENBQUMsQ0FBQ1csR0FBRixHQUFRLENBQUNsQixFQUFELEdBQU1NLEVBQWQ7QUFDQUMsSUFBQUEsQ0FBQyxDQUFDWSxHQUFGLEdBQVF0QixHQUFHLEdBQUdELENBQU4sR0FBVU0sRUFBRSxHQUFHSSxFQUF2QjtBQUNBQyxJQUFBQSxDQUFDLENBQUNhLEdBQUYsR0FBUSxDQUFDZCxFQUFUO0FBQ0FDLElBQUFBLENBQUMsQ0FBQ2MsR0FBRixHQUFRdkIsRUFBRSxHQUFHRixDQUFiO0FBQ0FXLElBQUFBLENBQUMsQ0FBQ2UsR0FBRixHQUFRdEIsRUFBRSxHQUFHSixDQUFiO0FBQ0FXLElBQUFBLENBQUMsQ0FBQ2dCLEdBQUYsR0FBUXJCLEVBQUUsR0FBR04sQ0FBYjtBQUNBVyxJQUFBQSxDQUFDLENBQUNpQixHQUFGLEdBQVEzQixHQUFSOztBQUVBM0MsaUJBQUt1RSxPQUFMLENBQWF0RSxLQUFiLEVBQW9CdUIsT0FBTyxDQUFDOEIsUUFBNUIsRUFBc0NrQixrQkFBVUMsMkJBQWhEOztBQUNBcEQsSUFBQUEsUUFBUSxDQUFDcUQsYUFBVCxDQUF1QkMsU0FBdkIsQ0FBaUNILGtCQUFVSSxPQUEzQyxFQUFvREMsTUFBcEQsQ0FBMkQ1RSxLQUEzRDtBQUNIOztBQUVELFdBQVM2RSxjQUFULENBQXlCekQsUUFBekIsRUFBb0RlLEtBQXBELEVBQTZFO0FBQ3pFLFFBQU1aLE9BQU8sR0FBR0gsUUFBUSxDQUFDRyxPQUF6Qjs7QUFDQSxRQUFJLENBQUNZLEtBQUssQ0FBQ3pCLElBQU4sQ0FBWTBCLGVBQWIsSUFBZ0MsQ0FBQ2IsT0FBTyxDQUFDYyxLQUE3QyxFQUFvRDtBQUNoRDtBQUNIOztBQUVEZCxJQUFBQSxPQUFPLENBQUNjLEtBQVIsR0FBZ0IsS0FBaEI7QUFFQUYsSUFBQUEsS0FBSyxDQUFDekIsSUFBTixDQUFZb0UsZ0JBQVosQ0FBNkJwRixHQUE3Qjs7QUFDQUgsaUJBQUt3RixhQUFMLENBQW1CdEYsR0FBbkIsRUFBd0JELFFBQXhCLEVBQWtDRSxHQUFsQzs7QUFDQSxRQUFNNkMsQ0FBQyxHQUFHaEIsT0FBTyxDQUFDaUIsTUFBbEI7QUFBMEIsUUFBTUMsQ0FBQyxHQUFHbEIsT0FBTyxDQUFDRSxRQUFSLEdBQW1CLEtBQTdCLENBVitDLENBVVg7O0FBQzlELFFBQU1pQixHQUFHLEdBQUduRCxhQUFLdUIsR0FBTCxDQUFTeUIsQ0FBVCxFQUFZOUMsR0FBWixDQUFaOztBQUE4QixRQUFNdUYsS0FBSyxHQUFHLElBQUl0QyxHQUFsQjtBQUM5QixRQUFNQyxFQUFFLEdBQUdsRCxHQUFHLENBQUNtRCxDQUFKLEdBQVFvQyxLQUFuQjtBQUEwQixRQUFNbkMsRUFBRSxHQUFHcEQsR0FBRyxDQUFDcUQsQ0FBSixHQUFRa0MsS0FBbkI7QUFBMEIsUUFBTWpDLEVBQUUsR0FBR3RELEdBQUcsQ0FBQ3VELENBQUosR0FBUWdDLEtBQW5CO0FBQ3BELFFBQU0vQixFQUFFLEdBQUdWLENBQUMsQ0FBQ0ssQ0FBYjtBQUFnQixRQUFNTSxFQUFFLEdBQUdYLENBQUMsQ0FBQ08sQ0FBYjtBQUFnQixRQUFNSyxFQUFFLEdBQUdaLENBQUMsQ0FBQ1MsQ0FBYjtBQUNoQyxRQUFNSSxDQUFDLEdBQUc3QixPQUFPLENBQUM4QixRQUFsQjtBQUNBRCxJQUFBQSxDQUFDLENBQUNFLEdBQUYsR0FBUSxJQUFJTCxFQUFFLEdBQUdOLEVBQWpCO0FBQ0FTLElBQUFBLENBQUMsQ0FBQ0csR0FBRixHQUFRLENBQUNOLEVBQUQsR0FBTUosRUFBZDtBQUNBTyxJQUFBQSxDQUFDLENBQUNJLEdBQUYsR0FBUSxDQUFDUCxFQUFELEdBQU1GLEVBQWQ7QUFDQUssSUFBQUEsQ0FBQyxDQUFDSyxHQUFGLEdBQVEsQ0FBUjtBQUNBTCxJQUFBQSxDQUFDLENBQUNNLEdBQUYsR0FBUSxDQUFDUixFQUFELEdBQU1QLEVBQWQ7QUFDQVMsSUFBQUEsQ0FBQyxDQUFDTyxHQUFGLEdBQVEsSUFBSVQsRUFBRSxHQUFHTCxFQUFqQjtBQUNBTyxJQUFBQSxDQUFDLENBQUNRLEdBQUYsR0FBUSxDQUFDVixFQUFELEdBQU1ILEVBQWQ7QUFDQUssSUFBQUEsQ0FBQyxDQUFDUyxHQUFGLEdBQVEsQ0FBUjtBQUNBVCxJQUFBQSxDQUFDLENBQUNVLEdBQUYsR0FBUSxDQUFDWCxFQUFELEdBQU1SLEVBQWQ7QUFDQVMsSUFBQUEsQ0FBQyxDQUFDVyxHQUFGLEdBQVEsQ0FBQ1osRUFBRCxHQUFNTixFQUFkO0FBQ0FPLElBQUFBLENBQUMsQ0FBQ1ksR0FBRixHQUFRLElBQUliLEVBQUUsR0FBR0osRUFBakI7QUFDQUssSUFBQUEsQ0FBQyxDQUFDYSxHQUFGLEdBQVEsQ0FBUjtBQUNBYixJQUFBQSxDQUFDLENBQUNjLEdBQUYsR0FBUXZCLEVBQUUsR0FBR0YsQ0FBYjtBQUNBVyxJQUFBQSxDQUFDLENBQUNlLEdBQUYsR0FBUXRCLEVBQUUsR0FBR0osQ0FBYjtBQUNBVyxJQUFBQSxDQUFDLENBQUNnQixHQUFGLEdBQVFyQixFQUFFLEdBQUdOLENBQWI7QUFDQVcsSUFBQUEsQ0FBQyxDQUFDaUIsR0FBRixHQUFRLENBQVI7O0FBRUF0RSxpQkFBS3VFLE9BQUwsQ0FBYXRFLEtBQWIsRUFBb0J1QixPQUFPLENBQUM4QixRQUE1QixFQUFzQ2tCLGtCQUFVQywyQkFBaEQ7O0FBQ0FwRCxJQUFBQSxRQUFRLENBQUNxRCxhQUFULENBQXVCQyxTQUF2QixDQUFpQ0gsa0JBQVVJLE9BQTNDLEVBQW9EQyxNQUFwRCxDQUEyRDVFLEtBQTNEO0FBQ0g7O0FBRU0sV0FBU2lGLFlBQVQsQ0FBdUI3RCxRQUF2QixFQUFrRDhELElBQWxELEVBQW9FO0FBQ3ZFLFFBQU16RSxNQUFNLEdBQUd5RSxJQUFJLENBQUN6RSxNQUFwQjtBQUNBLFFBQU0wRSxLQUFLLEdBQUcxRSxNQUFNLENBQUMwRSxLQUFyQjtBQUNBLFFBQU1DLGFBQWEsR0FBR2hFLFFBQVEsQ0FBQ2dFLGFBQS9CO0FBQ0FqRixJQUFBQSxNQUFNLENBQUNrRixTQUFQLENBQWlCRCxhQUFqQjtBQUFpQ0EsSUFBQUEsYUFBYSxDQUFDRSxNQUFkLEdBQXVCLENBQXZCO0FBQ2pDLFFBQU1DLGFBQWEsR0FBR25FLFFBQVEsQ0FBQ21FLGFBQS9CO0FBQ0FoRixJQUFBQSxVQUFVLENBQUM4RSxTQUFYLENBQXFCRSxhQUFyQjtBQUFxQ0EsSUFBQUEsYUFBYSxDQUFDRCxNQUFkLEdBQXVCLENBQXZCO0FBRXJDLFFBQU1FLFNBQVMsR0FBR0wsS0FBSyxDQUFDSyxTQUF4QjtBQUNBLFFBQU1qRSxPQUFPLEdBQUdILFFBQVEsQ0FBQ0csT0FBekI7QUFDQSxRQUFNa0UsWUFBWSxHQUFHbEUsT0FBTyxDQUFDSyxNQUE3QjtBQUNBNkQsSUFBQUEsWUFBWSxDQUFDekQsTUFBYixDQUFvQjBELEdBQXBCLENBQXdCLEdBQXhCLEVBQTZCLEdBQTdCLEVBQWtDLEdBQWxDO0FBQ0FELElBQUFBLFlBQVksQ0FBQzVELE1BQWIsR0FBc0IsSUFBdEI7O0FBRUEsUUFBSU4sT0FBTyxDQUFDb0UsT0FBUixJQUFtQnBFLE9BQU8sQ0FBQ2MsS0FBL0IsRUFBc0M7QUFDbEN1RCxvQkFBTXRCLE9BQU4sQ0FBY3RFLEtBQWQsRUFBcUJ1QixPQUFPLENBQUNzRSxXQUE3QixFQUEwQ3RCLGtCQUFVdUIsbUJBQXBEOztBQUNBMUUsTUFBQUEsUUFBUSxDQUFDcUQsYUFBVCxDQUF1QkMsU0FBdkIsQ0FBaUNILGtCQUFVSSxPQUEzQyxFQUFvREMsTUFBcEQsQ0FBMkQ1RSxLQUEzRDtBQUNIOztBQUVELFFBQUl3RixTQUFKLEVBQWU7QUFDWCxVQUFJakUsT0FBTyxDQUFDd0UsSUFBUixLQUFpQkMsb0JBQVdDLE1BQWhDLEVBQXdDO0FBQ3BDcEIsUUFBQUEsY0FBYyxDQUFDekQsUUFBRCxFQUFXb0UsU0FBWCxDQUFkO0FBQ0g7QUFDSjs7QUFFRCxRQUFJcEUsUUFBUSxDQUFDOEUsTUFBVCxDQUFnQlAsT0FBaEIsSUFBMkJ2RSxRQUFRLENBQUM4RSxNQUFULENBQWdCN0YsS0FBM0MsSUFBcURJLE1BQU0sQ0FBQzBGLFNBQVAsR0FBbUJDLG1CQUE1RSxFQUEwRjtBQUN0RmhCLE1BQUFBLGFBQWEsQ0FBQ2lCLElBQWQsQ0FBbUI3RixlQUFlLENBQUNZLFFBQVEsQ0FBQzhFLE1BQVQsQ0FBZ0I3RixLQUFqQixFQUF3QkksTUFBeEIsQ0FBbEM7QUFDSDs7QUFFRCxRQUFNNkYsTUFBTSxHQUFHbkIsS0FBSyxDQUFDbUIsTUFBckI7O0FBRUEsU0FBSyxJQUFJQyxDQUFDLEdBQUcsQ0FBYixFQUFnQkEsQ0FBQyxHQUFHRCxNQUFNLENBQUNoQixNQUEzQixFQUFtQ2lCLENBQUMsRUFBcEMsRUFBd0M7QUFDcEMsVUFBTWxHLEtBQUssR0FBR2lHLE1BQU0sQ0FBQ0MsQ0FBRCxDQUFwQixDQURvQyxDQUdwQzs7QUFDQSxVQUFJbEcsS0FBSyxDQUFDc0YsT0FBVixFQUFtQjtBQUNmLFlBQU1hLEdBQUcsR0FBR3RCLElBQUksQ0FBQ3VCLFVBQUwsR0FBa0JDLGVBQU9DLE9BQVAsQ0FBZUMsS0FBN0M7O0FBQ0EsWUFBSUosR0FBSixFQUFTO0FBQ0wsY0FBS25HLEtBQUssQ0FBQ0ssSUFBTixJQUFld0UsSUFBSSxDQUFDdUIsVUFBTCxLQUFvQnBHLEtBQUssQ0FBQ0ssSUFBTixDQUFXbUcsS0FBL0MsSUFDQTNCLElBQUksQ0FBQ3VCLFVBQUwsS0FBb0JwRyxLQUFLLENBQUN5RyxRQUQ5QixFQUN3QztBQUNwQzFCLFlBQUFBLGFBQWEsQ0FBQ2lCLElBQWQsQ0FBbUI3RixlQUFlLENBQUNILEtBQUQsRUFBUUksTUFBUixDQUFsQztBQUNIO0FBQ0osU0FMRCxNQUtPO0FBQ0gsY0FBSUosS0FBSyxDQUFDSyxJQUFOLElBQWUsQ0FBQ3dFLElBQUksQ0FBQ3VCLFVBQUwsR0FBa0JwRyxLQUFLLENBQUNLLElBQU4sQ0FBV21HLEtBQTlCLE1BQXlDeEcsS0FBSyxDQUFDSyxJQUFOLENBQVdtRyxLQUFuRSxJQUNDM0IsSUFBSSxDQUFDdUIsVUFBTCxHQUFrQnBHLEtBQUssQ0FBQ3lHLFFBRDdCLEVBQ3dDO0FBRXBDO0FBQ0EsZ0JBQUl6RyxLQUFLLENBQUMwRyxVQUFWLEVBQXNCO0FBQ2xCbkYsNEJBQU9vRixTQUFQLENBQWlCdkIsWUFBakIsRUFBK0JBLFlBQS9CLEVBQTZDcEYsS0FBSyxDQUFDNEcsV0FBbkQ7O0FBQ0ExQixjQUFBQSxhQUFhLENBQUNjLElBQWQsQ0FBbUJuRix5QkFBeUIsQ0FBQ2IsS0FBRCxFQUFRSSxNQUFSLENBQTVDO0FBQ0gsYUFObUMsQ0FRcEM7OztBQUNBLGdCQUFJSixLQUFLLENBQUM0RyxXQUFOLElBQXFCLENBQUNDLGlCQUFVQyxZQUFWLENBQXVCOUcsS0FBSyxDQUFDNEcsV0FBN0IsRUFBMEN4RyxNQUFNLENBQUMyRyxPQUFqRCxDQUExQixFQUFxRjtBQUNqRjtBQUNIOztBQUVEaEMsWUFBQUEsYUFBYSxDQUFDaUIsSUFBZCxDQUFtQjdGLGVBQWUsQ0FBQ0gsS0FBRCxFQUFRSSxNQUFSLENBQWxDO0FBQ0g7QUFDSjtBQUNKO0FBQ0o7QUFDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGludGVyc2VjdCwgc3BoZXJlIH0gZnJvbSAnLi4vLi4vZ2VvbWV0cnknO1xyXG5pbXBvcnQgeyBNb2RlbCB9IGZyb20gJy4uLy4uL3JlbmRlcmVyL3NjZW5lL21vZGVsJztcclxuaW1wb3J0IHsgQ2FtZXJhLCBTS1lCT1hfRkxBRyB9IGZyb20gJy4uLy4uL3JlbmRlcmVyL3NjZW5lL2NhbWVyYSc7XHJcbmltcG9ydCB7IExheWVycyB9IGZyb20gJy4uLy4uL3NjZW5lLWdyYXBoL2xheWVycyc7XHJcbmltcG9ydCB7IFZlYzMsIE1hdDQsIFF1YXQsIENvbG9yIH0gZnJvbSAnLi4vLi4vbWF0aCc7XHJcbmltcG9ydCB7IEZvcndhcmRQaXBlbGluZSB9IGZyb20gJy4vZm9yd2FyZC1waXBlbGluZSc7XHJcbmltcG9ydCB7IFJlbmRlclZpZXcgfSBmcm9tICcuLi8nO1xyXG5pbXBvcnQgeyBQb29sIH0gZnJvbSAnLi4vLi4vbWVtb3AnO1xyXG5pbXBvcnQgeyBJUmVuZGVyT2JqZWN0LCBVQk9TaGFkb3cgfSBmcm9tICcuLi9kZWZpbmUnO1xyXG5pbXBvcnQgeyBTaGFkb3dUeXBlIH0gZnJvbSAnLi4vLi4vcmVuZGVyZXIvc2NlbmUvc2hhZG93cyc7XHJcbmltcG9ydCB7IFNwaGVyZUxpZ2h0LCBEaXJlY3Rpb25hbExpZ2h0fSBmcm9tICcuLi8uLi9yZW5kZXJlci9zY2VuZSc7XHJcblxyXG5jb25zdCBfdGVtcFZlYzMgPSBuZXcgVmVjMygpO1xyXG5jb25zdCBfZm9yd2FyZCA9IG5ldyBWZWMzKDAsIDAsIC0xKTtcclxuY29uc3QgX3YzID0gbmV3IFZlYzMoKTtcclxuY29uc3QgX3F0ID0gbmV3IFF1YXQoKTtcclxuY29uc3QgX2Rpcl9uZWdhdGUgPSBuZXcgVmVjMygpO1xyXG5jb25zdCBfdmVjM19wID0gbmV3IFZlYzMoKTtcclxuY29uc3QgX21hdDRfdHJhbnMgPSBuZXcgTWF0NCgpO1xyXG5jb25zdCBfZGF0YSA9IEZsb2F0MzJBcnJheS5mcm9tKFtcclxuICAgIDEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDAsIDEsIDAsIDAsIDAsIDAsIDEsIC8vIG1hdExpZ2h0UGxhbmVQcm9qXHJcbiAgICAwLjAsIDAuMCwgMC4wLCAwLjMsIC8vIHNoYWRvd0NvbG9yXHJcbl0pO1xyXG5cclxuY29uc3Qgcm9Qb29sID0gbmV3IFBvb2w8SVJlbmRlck9iamVjdD4oKCkgPT4gKHsgbW9kZWw6IG51bGwhLCBkZXB0aDogMCB9KSwgMTI4KTtcclxuY29uc3Qgc2hhZG93UG9vbCA9IG5ldyBQb29sPElSZW5kZXJPYmplY3Q+KCgpID0+ICh7IG1vZGVsOiBudWxsISwgZGVwdGg6IDAgfSksIDEyOCk7XHJcblxyXG5mdW5jdGlvbiBnZXRSZW5kZXJPYmplY3QgKG1vZGVsOiBNb2RlbCwgY2FtZXJhOiBDYW1lcmEpIHtcclxuICAgIGxldCBkZXB0aCA9IDA7XHJcbiAgICBpZiAobW9kZWwubm9kZSkge1xyXG4gICAgICAgIFZlYzMuc3VidHJhY3QoX3RlbXBWZWMzLCBtb2RlbC5ub2RlLndvcmxkUG9zaXRpb24sIGNhbWVyYS5wb3NpdGlvbik7XHJcbiAgICAgICAgZGVwdGggPSBWZWMzLmRvdChfdGVtcFZlYzMsIGNhbWVyYS5mb3J3YXJkKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHJvID0gcm9Qb29sLmFsbG9jKCk7XHJcbiAgICByby5tb2RlbCA9IG1vZGVsO1xyXG4gICAgcm8uZGVwdGggPSBkZXB0aDtcclxuICAgIHJldHVybiBybztcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0Q2FzdFNoYWRvd1JlbmRlck9iamVjdCAobW9kZWw6IE1vZGVsLCBjYW1lcmE6IENhbWVyYSkge1xyXG4gICAgbGV0IGRlcHRoID0gMDtcclxuICAgIGlmIChtb2RlbC5ub2RlKSB7XHJcbiAgICAgICAgVmVjMy5zdWJ0cmFjdChfdGVtcFZlYzMsIG1vZGVsLm5vZGUud29ybGRQb3NpdGlvbiwgY2FtZXJhLnBvc2l0aW9uKTtcclxuICAgICAgICBkZXB0aCA9IFZlYzMuZG90KF90ZW1wVmVjMywgY2FtZXJhLmZvcndhcmQpO1xyXG4gICAgfVxyXG4gICAgY29uc3Qgcm8gPSBzaGFkb3dQb29sLmFsbG9jKCk7XHJcbiAgICByby5tb2RlbCA9IG1vZGVsO1xyXG4gICAgcm8uZGVwdGggPSBkZXB0aDtcclxuICAgIHJldHVybiBybztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFNoYWRvd1dvcmxkTWF0cml4IChwaXBlbGluZTogRm9yd2FyZFBpcGVsaW5lLCByb3RhdGlvbjogUXVhdCwgZGlyOiBWZWMzKSB7XHJcbiAgICBjb25zdCBzaGFkb3dzID0gcGlwZWxpbmUuc2hhZG93cztcclxuICAgIFZlYzMubmVnYXRlKF9kaXJfbmVnYXRlLCBkaXIpO1xyXG4gICAgY29uc3QgZGlzdGFuY2U6IG51bWJlciA9IE1hdGguc3FydCgyKSAqIHNoYWRvd3Muc3BoZXJlLnJhZGl1cztcclxuICAgIFZlYzMubXVsdGlwbHlTY2FsYXIoX3ZlYzNfcCwgX2Rpcl9uZWdhdGUsIGRpc3RhbmNlKTtcclxuICAgIFZlYzMuYWRkKF92ZWMzX3AsIF92ZWMzX3AsIHNoYWRvd3Muc3BoZXJlLmNlbnRlcik7XHJcblxyXG4gICAgTWF0NC5mcm9tUlQoX21hdDRfdHJhbnMsIHJvdGF0aW9uLCBfdmVjM19wKTtcclxuXHJcbiAgICByZXR1cm4gX21hdDRfdHJhbnM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZVNwaGVyZUxpZ2h0IChwaXBlbGluZTogRm9yd2FyZFBpcGVsaW5lLCBsaWdodDogU3BoZXJlTGlnaHQpIHtcclxuICAgIGNvbnN0IHNoYWRvd3MgPSBwaXBlbGluZS5zaGFkb3dzO1xyXG4gICAgaWYgKCFsaWdodC5ub2RlIS5oYXNDaGFuZ2VkRmxhZ3MgJiYgIXNoYWRvd3MuZGlydHkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgc2hhZG93cy5kaXJ0eSA9IHRydWU7XHJcbiAgICBsaWdodC5ub2RlIS5nZXRXb3JsZFBvc2l0aW9uKF92Myk7XHJcbiAgICBjb25zdCBuID0gc2hhZG93cy5ub3JtYWw7IGNvbnN0IGQgPSBzaGFkb3dzLmRpc3RhbmNlICsgMC4wMDE7IC8vIGF2b2lkIHotZmlnaHRpbmdcclxuICAgIGNvbnN0IE5kTCA9IFZlYzMuZG90KG4sIF92Myk7XHJcbiAgICBjb25zdCBseCA9IF92My54OyBjb25zdCBseSA9IF92My55OyBjb25zdCBseiA9IF92My56O1xyXG4gICAgY29uc3QgbnggPSBuLng7IGNvbnN0IG55ID0gbi55OyBjb25zdCBueiA9IG4uejtcclxuICAgIGNvbnN0IG0gPSBzaGFkb3dzLm1hdExpZ2h0O1xyXG4gICAgbS5tMDAgPSBOZEwgLSBkIC0gbHggKiBueDtcclxuICAgIG0ubTAxID0gLWx5ICogbng7XHJcbiAgICBtLm0wMiA9IC1seiAqIG54O1xyXG4gICAgbS5tMDMgPSAtbng7XHJcbiAgICBtLm0wNCA9IC1seCAqIG55O1xyXG4gICAgbS5tMDUgPSBOZEwgLSBkIC0gbHkgKiBueTtcclxuICAgIG0ubTA2ID0gLWx6ICogbnk7XHJcbiAgICBtLm0wNyA9IC1ueTtcclxuICAgIG0ubTA4ID0gLWx4ICogbno7XHJcbiAgICBtLm0wOSA9IC1seSAqIG56O1xyXG4gICAgbS5tMTAgPSBOZEwgLSBkIC0gbHogKiBuejtcclxuICAgIG0ubTExID0gLW56O1xyXG4gICAgbS5tMTIgPSBseCAqIGQ7XHJcbiAgICBtLm0xMyA9IGx5ICogZDtcclxuICAgIG0ubTE0ID0gbHogKiBkO1xyXG4gICAgbS5tMTUgPSBOZEw7XHJcblxyXG4gICAgTWF0NC50b0FycmF5KF9kYXRhLCBzaGFkb3dzLm1hdExpZ2h0LCBVQk9TaGFkb3cuTUFUX0xJR0hUX1BMQU5FX1BST0pfT0ZGU0VUKTtcclxuICAgIHBpcGVsaW5lLmRlc2NyaXB0b3JTZXQuZ2V0QnVmZmVyKFVCT1NoYWRvdy5CSU5ESU5HKS51cGRhdGUoX2RhdGEpO1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVEaXJMaWdodCAocGlwZWxpbmU6IEZvcndhcmRQaXBlbGluZSwgbGlnaHQ6IERpcmVjdGlvbmFsTGlnaHQpIHtcclxuICAgIGNvbnN0IHNoYWRvd3MgPSBwaXBlbGluZS5zaGFkb3dzO1xyXG4gICAgaWYgKCFsaWdodC5ub2RlIS5oYXNDaGFuZ2VkRmxhZ3MgJiYgIXNoYWRvd3MuZGlydHkpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgc2hhZG93cy5kaXJ0eSA9IGZhbHNlO1xyXG5cclxuICAgIGxpZ2h0Lm5vZGUhLmdldFdvcmxkUm90YXRpb24oX3F0KTtcclxuICAgIFZlYzMudHJhbnNmb3JtUXVhdChfdjMsIF9mb3J3YXJkLCBfcXQpO1xyXG4gICAgY29uc3QgbiA9IHNoYWRvd3Mubm9ybWFsOyBjb25zdCBkID0gc2hhZG93cy5kaXN0YW5jZSArIDAuMDAxOyAvLyBhdm9pZCB6LWZpZ2h0aW5nXHJcbiAgICBjb25zdCBOZEwgPSBWZWMzLmRvdChuLCBfdjMpOyBjb25zdCBzY2FsZSA9IDEgLyBOZEw7XHJcbiAgICBjb25zdCBseCA9IF92My54ICogc2NhbGU7IGNvbnN0IGx5ID0gX3YzLnkgKiBzY2FsZTsgY29uc3QgbHogPSBfdjMueiAqIHNjYWxlO1xyXG4gICAgY29uc3QgbnggPSBuLng7IGNvbnN0IG55ID0gbi55OyBjb25zdCBueiA9IG4uejtcclxuICAgIGNvbnN0IG0gPSBzaGFkb3dzLm1hdExpZ2h0O1xyXG4gICAgbS5tMDAgPSAxIC0gbnggKiBseDtcclxuICAgIG0ubTAxID0gLW54ICogbHk7XHJcbiAgICBtLm0wMiA9IC1ueCAqIGx6O1xyXG4gICAgbS5tMDMgPSAwO1xyXG4gICAgbS5tMDQgPSAtbnkgKiBseDtcclxuICAgIG0ubTA1ID0gMSAtIG55ICogbHk7XHJcbiAgICBtLm0wNiA9IC1ueSAqIGx6O1xyXG4gICAgbS5tMDcgPSAwO1xyXG4gICAgbS5tMDggPSAtbnogKiBseDtcclxuICAgIG0ubTA5ID0gLW56ICogbHk7XHJcbiAgICBtLm0xMCA9IDEgLSBueiAqIGx6O1xyXG4gICAgbS5tMTEgPSAwO1xyXG4gICAgbS5tMTIgPSBseCAqIGQ7XHJcbiAgICBtLm0xMyA9IGx5ICogZDtcclxuICAgIG0ubTE0ID0gbHogKiBkO1xyXG4gICAgbS5tMTUgPSAxO1xyXG5cclxuICAgIE1hdDQudG9BcnJheShfZGF0YSwgc2hhZG93cy5tYXRMaWdodCwgVUJPU2hhZG93Lk1BVF9MSUdIVF9QTEFORV9QUk9KX09GRlNFVCk7XHJcbiAgICBwaXBlbGluZS5kZXNjcmlwdG9yU2V0LmdldEJ1ZmZlcihVQk9TaGFkb3cuQklORElORykudXBkYXRlKF9kYXRhKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNjZW5lQ3VsbGluZyAocGlwZWxpbmU6IEZvcndhcmRQaXBlbGluZSwgdmlldzogUmVuZGVyVmlldykge1xyXG4gICAgY29uc3QgY2FtZXJhID0gdmlldy5jYW1lcmE7XHJcbiAgICBjb25zdCBzY2VuZSA9IGNhbWVyYS5zY2VuZSE7XHJcbiAgICBjb25zdCByZW5kZXJPYmplY3RzID0gcGlwZWxpbmUucmVuZGVyT2JqZWN0cztcclxuICAgIHJvUG9vbC5mcmVlQXJyYXkocmVuZGVyT2JqZWN0cyk7IHJlbmRlck9iamVjdHMubGVuZ3RoID0gMDtcclxuICAgIGNvbnN0IHNoYWRvd09iamVjdHMgPSBwaXBlbGluZS5zaGFkb3dPYmplY3RzO1xyXG4gICAgc2hhZG93UG9vbC5mcmVlQXJyYXkoc2hhZG93T2JqZWN0cyk7IHNoYWRvd09iamVjdHMubGVuZ3RoID0gMDtcclxuXHJcbiAgICBjb25zdCBtYWluTGlnaHQgPSBzY2VuZS5tYWluTGlnaHQ7XHJcbiAgICBjb25zdCBzaGFkb3dzID0gcGlwZWxpbmUuc2hhZG93cztcclxuICAgIGNvbnN0IHNoYWRvd1NwaGVyZSA9IHNoYWRvd3Muc3BoZXJlO1xyXG4gICAgc2hhZG93U3BoZXJlLmNlbnRlci5zZXQoMC4wLCAwLjAsIDAuMCk7XHJcbiAgICBzaGFkb3dTcGhlcmUucmFkaXVzID0gMC4wMTtcclxuXHJcbiAgICBpZiAoc2hhZG93cy5lbmFibGVkICYmIHNoYWRvd3MuZGlydHkpIHtcclxuICAgICAgICBDb2xvci50b0FycmF5KF9kYXRhLCBzaGFkb3dzLnNoYWRvd0NvbG9yLCBVQk9TaGFkb3cuU0hBRE9XX0NPTE9SX09GRlNFVCk7XHJcbiAgICAgICAgcGlwZWxpbmUuZGVzY3JpcHRvclNldC5nZXRCdWZmZXIoVUJPU2hhZG93LkJJTkRJTkcpLnVwZGF0ZShfZGF0YSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG1haW5MaWdodCkge1xyXG4gICAgICAgIGlmIChzaGFkb3dzLnR5cGUgPT09IFNoYWRvd1R5cGUuUGxhbmFyKSB7XHJcbiAgICAgICAgICAgIHVwZGF0ZURpckxpZ2h0KHBpcGVsaW5lLCBtYWluTGlnaHQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAocGlwZWxpbmUuc2t5Ym94LmVuYWJsZWQgJiYgcGlwZWxpbmUuc2t5Ym94Lm1vZGVsICYmIChjYW1lcmEuY2xlYXJGbGFnICYgU0tZQk9YX0ZMQUcpKSB7XHJcbiAgICAgICAgcmVuZGVyT2JqZWN0cy5wdXNoKGdldFJlbmRlck9iamVjdChwaXBlbGluZS5za3lib3gubW9kZWwsIGNhbWVyYSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG1vZGVscyA9IHNjZW5lLm1vZGVscztcclxuXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1vZGVscy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IG1vZGVsID0gbW9kZWxzW2ldO1xyXG5cclxuICAgICAgICAvLyBmaWx0ZXIgbW9kZWwgYnkgdmlldyB2aXNpYmlsaXR5XHJcbiAgICAgICAgaWYgKG1vZGVsLmVuYWJsZWQpIHtcclxuICAgICAgICAgICAgY29uc3QgdmlzID0gdmlldy52aXNpYmlsaXR5ICYgTGF5ZXJzLkJpdE1hc2suVUlfMkQ7XHJcbiAgICAgICAgICAgIGlmICh2aXMpIHtcclxuICAgICAgICAgICAgICAgIGlmICgobW9kZWwubm9kZSAmJiAodmlldy52aXNpYmlsaXR5ID09PSBtb2RlbC5ub2RlLmxheWVyKSkgfHxcclxuICAgICAgICAgICAgICAgICAgICB2aWV3LnZpc2liaWxpdHkgPT09IG1vZGVsLnZpc0ZsYWdzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVuZGVyT2JqZWN0cy5wdXNoKGdldFJlbmRlck9iamVjdChtb2RlbCwgY2FtZXJhKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobW9kZWwubm9kZSAmJiAoKHZpZXcudmlzaWJpbGl0eSAmIG1vZGVsLm5vZGUubGF5ZXIpID09PSBtb2RlbC5ub2RlLmxheWVyKSB8fFxyXG4gICAgICAgICAgICAgICAgICAgICh2aWV3LnZpc2liaWxpdHkgJiBtb2RlbC52aXNGbGFncykpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gc2hhZG93IHJlbmRlciBPYmplY3RcclxuICAgICAgICAgICAgICAgICAgICBpZiAobW9kZWwuY2FzdFNoYWRvdykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzcGhlcmUubWVyZ2VBQUJCKHNoYWRvd1NwaGVyZSwgc2hhZG93U3BoZXJlLCBtb2RlbC53b3JsZEJvdW5kcyEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzaGFkb3dPYmplY3RzLnB1c2goZ2V0Q2FzdFNoYWRvd1JlbmRlck9iamVjdChtb2RlbCwgY2FtZXJhKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgICAgICAvLyBmcnVzdHVtIGN1bGxpbmdcclxuICAgICAgICAgICAgICAgICAgICBpZiAobW9kZWwud29ybGRCb3VuZHMgJiYgIWludGVyc2VjdC5hYWJiX2ZydXN0dW0obW9kZWwud29ybGRCb3VuZHMsIGNhbWVyYS5mcnVzdHVtKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHJlbmRlck9iamVjdHMucHVzaChnZXRSZW5kZXJPYmplY3QobW9kZWwsIGNhbWVyYSkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59XHJcbiJdfQ==